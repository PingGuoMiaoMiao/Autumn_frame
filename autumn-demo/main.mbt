/// Autumn Framework å®Œæ•´ç¤ºä¾‹
/// 
/// æ ¹æ®ä½¿ç”¨æŒ‡å—åˆ›å»ºçš„å®Œæ•´ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ Autumn Frame æ„å»º Web åº”ç”¨
/// ç±»ä¼¼ Spring Boot çš„å¼€å‘ä½“éªŒ

// ========== å¯¼å…¥ä¾èµ– ==========

fn parse_request_params(request : @Http.HttpRequest) -> @hashmap.HashMap[String, String]? {
  match request.get_body() {
    Some(body) => {
      let content_type = match request.get_header("Content-Type") {
        Some(ct) => ct
        None => ""
      }
      if content_type.contains("application/json") {
        Some(parse_json_data(body))
      } else {
        Some(parse_form_data(body))
      }
    }
    None => None
  }
}

fn opt_string_or(value : String?, fallback : String) -> String {
  match value {
    Some(v) => v
    None => fallback
  }
}

fn safe_strip_prefix(value : String, prefix : String) -> String {
  if value.has_prefix(prefix) {
    let len = value.length()
    let pre_len = prefix.length()
    if len > pre_len {
      value[pre_len:len].to_string() catch { _ => value }
    } else {
      ""
    }
  } else {
    value
  }
}

fn extract_path_tail(path : String) -> String {
  let parts = Array::from_iter(path.split("/"))
  if parts.length() == 0 {
    path
  } else {
    parts[parts.length() - 1].to_string()
  }
}

fn handle_log_upload(request : @Http.HttpRequest) -> @Controller.JsonResponse {
  match request.get_body() {
    Some(body) => {
      let content_type = match request.get_header("Content-Type") {
        Some(ct) => ct
        None => ""
      }
      
      let params = if content_type.contains("application/json") {
        parse_json_data(body)
      } else {
        // å…è®¸è¡¨å•æ ¼å¼ä½œä¸ºé™çº§æ–¹æ¡ˆ
        parse_form_data(body)
      }
      
      match (params.get("level"), params.get("message")) {
        (Some(level), Some(message)) => {
          let request_id_opt = request.get_header("X-Request-Id")
          let timestamp = match params.get("timestamp") {
            Some(ts) => ts
            None => ""
          }
          let context = match params.get("context") {
            Some(ctx) => ctx
            None => ""
          }
          let origin = match params.get("origin") {
            Some(or) => or
            None => ""
          }
          let device = match params.get("device") {
            Some(dev) => dev
            None => ""
          }
          
          let request_id = match request_id_opt {
            Some(id) => id
            None => match params.get("logId") {
              Some(user_log_id) => user_log_id
              None => if timestamp != "" {
                "log-" + timestamp
              } else {
                "log-" + level
              }
            }
          }
          
          println("[LOG] id=" + request_id + " level=" + level + " message=" + message)
          if timestamp != "" {
            println("      timestamp=" + timestamp)
          }
          if context != "" {
            println("      context=" + context)
          }
          if origin != "" {
            println("      origin=" + origin)
          }
          if device != "" {
            println("      device=" + device)
          }
          
          let response = @hashmap.new()
          response.set("success", "true")
          response.set("message", "æ—¥å¿—å·²æ¥æ”¶")
          response.set("requestId", request_id)
          response.set("level", level)
          response.set("logMessage", message)
          if timestamp != "" {
            response.set("timestamp", timestamp)
          }
          if context != "" {
            response.set("context", context)
          }
          if origin != "" {
            response.set("origin", origin)
          }
          if device != "" {
            response.set("device", device)
          }
          
          @Controller.JsonResponse::new(response)
        }
        _ => {
          let error = @hashmap.new()
          error.set("success", "false")
          error.set("message", "è¯·æä¾› level ä¸ message å­—æ®µ")
          @Controller.JsonResponse::new(error)
        }
      }
    }
    None => {
      let error = @hashmap.new()
      error.set("success", "false")
      error.set("message", "è¯·æ±‚ä½“ä¸èƒ½ä¸ºç©º")
      @Controller.JsonResponse::new(error)
    }
  }
}

/// ä¸»å‡½æ•°
fn main {
  println("============================================================")
  println("Autumn Framework ç¤ºä¾‹åº”ç”¨")
  println("============================================================")
  println("")
  
  // ========== ç¬¬ä¸€æ­¥ï¼šåˆ›å»º IoC å®¹å™¨ ==========
  println("ğŸ“ ç¬¬ä¸€æ­¥ï¼šåˆ›å»º IoC å®¹å™¨")
  println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
  
  // åˆ›å»ºé…ç½®ï¼ˆç±»ä¼¼ Spring Boot çš„ application.propertiesï¼‰
  let config = [
    ("app.name", "User Management System"),
    ("app.version", "1.0.0"),
    ("server.port", "8080"),
    ("db.url", "jdbc:mysql://localhost:3306/users"),
    ("db.username", "root"),
    ("db.password", "password")
  ]
  
  // åˆ›å»º IoC å®¹å™¨ï¼ˆç±»ä¼¼ Spring çš„ ApplicationContextï¼‰
  let ctx = @ApplicationContext.ApplicationContext::new(config, "com.example")
  println("âœ“ IoC å®¹å™¨åˆ›å»ºæˆåŠŸ")
  println("  - é…ç½®é¡¹æ•°é‡: " + config.length().to_string())
  println("")
  
  // ========== ç¬¬äºŒæ­¥ï¼šæ³¨å†Œ Bean ==========
  println("ğŸ“¦ ç¬¬äºŒæ­¥ï¼šæ³¨å†Œ Bean")
  println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
  
  // æ³¨å†Œ Beanï¼ˆç±»ä¼¼ Spring çš„ @Component, @Service, @Repositoryï¼‰
  ctx.register_bean("userService", "com.example.service.UserService", 10, false)
  ctx.register_bean("userRepository", "com.example.repository.UserRepository", 5, false)
  ctx.register_bean("userController", "com.example.controller.UserController", 20, false)
  
  println("âœ“ æ³¨å†Œ Bean: userService (order=10)")
  println("âœ“ æ³¨å†Œ Bean: userRepository (order=5)")
  println("âœ“ æ³¨å†Œ Bean: userController (order=20)")
  println("")
  
  // ========== ç¬¬ä¸‰æ­¥ï¼šåˆ›å»º Bean å®ä¾‹ ==========
  println("ğŸ”¨ ç¬¬ä¸‰æ­¥ï¼šåˆ›å»º Bean å®ä¾‹")
  println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
  
  ctx.create_all_beans()
  println("âœ“ æ‰€æœ‰ Bean åˆ›å»ºå®Œæˆ")
  println("")
  
  // ========== ç¬¬å››æ­¥ï¼šåˆ›å»º Web MVC åº”ç”¨ ==========
  println("ğŸŒ ç¬¬å››æ­¥ï¼šåˆ›å»º Web MVC åº”ç”¨")
  println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
  
  // 4.1 åˆ›å»ºæ ¹è·¯å¾„ Controllerï¼ˆå¤„ç† / è¯·æ±‚ï¼‰
  let root_controller = @Controller.Controller::new("")
    .get("/", fn(_request : @Http.HttpRequest) {
      let html_part1 = "<!DOCTYPE html><html><head><title>Autumn Framework</title>"
      let html_part2 = html_part1 + "<meta charset='utf-8'></head><body>"
      let html_part3 = html_part2 + "<style>body{font-family:Arial,sans-serif;margin:40px;}" +
                       "h1{color:#333;}ul{list-style:none;padding:0;}li{margin:10px 0;}" +
                       "a{color:#007bff;text-decoration:none;}a:hover{text-decoration:underline;}</style>"
      let html_part4 = html_part3 + "<h1>æ¬¢è¿ä½¿ç”¨ Autumn Framework</h1>"
      let html_part5 = html_part4 + "<p>è¿™æ˜¯ä¸€ä¸ªåŸºäº MoonBit çš„ Web æ¡†æ¶ï¼Œç±»ä¼¼ Spring Boot</p>"
      let html_part6 = html_part5 + "<h2>å¯ç”¨è·¯ç”±ï¼š</h2>"
      let html_part7 = html_part6 + "<ul>"
      let html_part8 = html_part7 + "<li><a href='/login'>GET /login</a> - ç™»å½•é¡µé¢</li>"
      let html_part9 = html_part8 + "<li><a href='/users'>GET /users</a> - ç”¨æˆ·åˆ—è¡¨ï¼ˆHTMLï¼‰</li>"
      let html_part10 = html_part9 + "<li><a href='/users/123'>GET /users/123</a> - ç”¨æˆ·è¯¦æƒ…ï¼ˆHTMLï¼‰</li>"
      let html_part11 = html_part10 + "<li><a href='/api/users'>GET /api/users</a> - ç”¨æˆ·åˆ—è¡¨ï¼ˆJSONï¼‰</li>"
      let html_part12 = html_part11 + "<li><a href='/api/users/123'>GET /api/users/123</a> - ç”¨æˆ·è¯¦æƒ…ï¼ˆJSONï¼‰</li>"
      let html = html_part12 + "</ul></body></html>"
      @Http.HttpResponse::ok(html)
    })
    
    // GET /login - ç™»å½•é¡µé¢ï¼ˆå‰ç«¯é¡µé¢å·²å†™å¥½ï¼Œè¿™é‡Œè¿”å›ç®€å•æç¤ºï¼‰
    .get("/login", fn(_request : @Http.HttpRequest) {
      // æ³¨æ„ï¼šå®é™…çš„å‰ç«¯ç™»å½•é¡µé¢åº”è¯¥ç”±å‰ç«¯æ¡†æ¶ï¼ˆNext.jsï¼‰æä¾›
      // è¿™é‡Œè¿”å›ä¸€ä¸ªç®€å•çš„æç¤ºé¡µé¢ï¼Œæˆ–è€…é‡å®šå‘åˆ°å‰ç«¯
      let html_part1 = "<!DOCTYPE html><html><head><title>ç™»å½•</title>"
      let html_part2 = html_part1 + "<meta charset='utf-8'></head><body>"
      let html_part3 = html_part2 + "<style>body{font-family:Arial,sans-serif;margin:40px;text-align:center;}" +
                       "h1{color:#333;}.info{padding:20px;background:#f5f5f5;border-radius:5px;margin:20px auto;max-width:600px;}</style>"
      let html_part4 = html_part3 + "<h1>ç™»å½•é¡µé¢</h1>"
      let html_part5 = html_part4 + "<div class='info'>"
      let html_part6 = html_part5 + "<p>å‰ç«¯ç™»å½•é¡µé¢åº”è¯¥ç”± Next.js æ¡†æ¶æä¾›</p>"
      let html_part7 = html_part6 + "<p>è¯·è®¿é—®å‰ç«¯åº”ç”¨ï¼š<a href='http://localhost:3000/login'>http://localhost:3000/login</a></p>"
      let html_part8 = html_part7 + "<p><strong>åç«¯ç™»å½•æ¥å£ï¼š</strong> POST /api/auth/login</p>"
      let html_part9 = html_part8 + "<p><strong>æµ‹è¯•è´¦å·ï¼š</strong></p>"
      let html_part10 = html_part9 + "<ul style='text-align:left;display:inline-block;'>"
      let html_part11 = html_part10 + "<li>ç”¨æˆ·å: admin, å¯†ç : 123456</li>"
      let html_part12 = html_part11 + "<li>ç”¨æˆ·å: user, å¯†ç : password</li>"
      let html_part13 = html_part12 + "</ul>"
      let html_part14 = html_part13 + "</div>"
      let html = html_part14 + "</body></html>"
      @Http.HttpResponse::ok(html)
    })
    
    // GET /favicon.ico - å¤„ç†æµè§ˆå™¨è‡ªåŠ¨è¯·æ±‚çš„å›¾æ ‡
    .get("/favicon.ico", fn(_request : @Http.HttpRequest) {
      // è¿”å› 204 No Contentï¼Œé¿å… 404 é”™è¯¯
      @Http.HttpResponse::no_content()
    })
  
  println("âœ“ åˆ›å»ºæ ¹è·¯å¾„ Controller: /")
  
  // 4.2 åˆ›å»ºç”¨æˆ· Controllerï¼ˆç±»ä¼¼ Spring çš„ @Controllerï¼‰
  let user_controller = @Controller.Controller::new("/users")
    // GET /usersï¼ˆç±»ä¼¼ @GetMapping("/")ï¼‰
    .get("/", fn(_request : @Http.HttpRequest) {
      let html_part1 = "<!DOCTYPE html><html><head><title>ç”¨æˆ·åˆ—è¡¨</title>"
      let html_part2 = html_part1 + "<meta charset='utf-8'></head><body>"
      let html_part3 = html_part2 + "<style>body{font-family:Arial,sans-serif;margin:40px;}h1{color:#333;}" +
                       "ul{list-style:none;padding:0;}li{padding:10px;background:#f5f5f5;margin:5px 0;border-radius:5px;}</style>"
      let html_part4 = html_part3 + "<h1>ç”¨æˆ·åˆ—è¡¨</h1>"
      let html_part5 = html_part4 + "<ul>"
      let html_part6 = html_part5 + "<li><strong>ç”¨æˆ· 1:</strong> Alice - alice@example.com</li>"
      let html_part7 = html_part6 + "<li><strong>ç”¨æˆ· 2:</strong> Bob - bob@example.com</li>"
      let html_part8 = html_part7 + "<li><strong>ç”¨æˆ· 3:</strong> Charlie - charlie@example.com</li>"
      let html_part9 = html_part8 + "</ul>"
      let html_part10 = html_part9 + "<p><a href='/'>è¿”å›é¦–é¡µ</a></p>"
      let html = html_part10 + "</body></html>"
      @Http.HttpResponse::ok(html)
    })
    
    // GET /users/{id}ï¼ˆç±»ä¼¼ @GetMapping("/{id}")ï¼‰
    .get("/{id}", fn(request : @Http.HttpRequest) {
      let path = request.get_path()
      let html_part1 = "<!DOCTYPE html><html><head><title>ç”¨æˆ·è¯¦æƒ…</title>"
      let html_part2 = html_part1 + "<meta charset='utf-8'></head><body>"
      let html_part3 = html_part2 + "<style>body{font-family:Arial,sans-serif;margin:40px;}h1{color:#333;}" +
                       ".info{padding:20px;background:#f5f5f5;border-radius:5px;margin:20px 0;}</style>"
      let html_part4 = html_part3 + "<h1>ç”¨æˆ·è¯¦æƒ…</h1>"
      let html_part5 = html_part4 + "<div class='info'>"
      let html_part6 = html_part5 + "<p><strong>è·¯å¾„:</strong> " + path + "</p>"
      let html_part7 = html_part6 + "<p><strong>ç”¨æˆ·ID:</strong> ä»è·¯å¾„ä¸­æå–</p>"
      let html_part8 = html_part7 + "<p><strong>çŠ¶æ€:</strong> å·²æ‰¾åˆ°</p>"
      let html_part9 = html_part8 + "</div>"
      let html_part10 = html_part9 + "<p><a href='/users'>è¿”å›ç”¨æˆ·åˆ—è¡¨</a> | <a href='/'>è¿”å›é¦–é¡µ</a></p>"
      let html = html_part10 + "</body></html>"
      @Http.HttpResponse::ok(html)
    })
    
    // POST /usersï¼ˆç±»ä¼¼ @PostMapping("/")ï¼‰
    .post("/", fn(_request : @Http.HttpRequest) {
      let html_part1 = "<!DOCTYPE html><html><head><title>åˆ›å»ºç”¨æˆ·</title>"
      let html_part2 = html_part1 + "<meta charset='utf-8'></head><body>"
      let html_part3 = html_part2 + "<style>body{font-family:Arial,sans-serif;margin:40px;}h1{color:#28a745;}</style>"
      let html_part4 = html_part3 + "<h1>âœ“ åˆ›å»ºç”¨æˆ·æˆåŠŸ</h1>"
      let html_part5 = html_part4 + "<p>ç”¨æˆ·å·²æˆåŠŸåˆ›å»º</p>"
      let html_part6 = html_part5 + "<p><a href='/users'>æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨</a> | <a href='/'>è¿”å›é¦–é¡µ</a></p>"
      let html = html_part6 + "</body></html>"
      @Http.HttpResponse::created(html)
    })
    
    // PUT /users/{id}ï¼ˆç±»ä¼¼ @PutMapping("/{id}")ï¼‰
    .put("/{id}", fn(_request : @Http.HttpRequest) {
      let html = "<!DOCTYPE html><html><head><title>æ›´æ–°ç”¨æˆ·</title><meta charset='utf-8'></head><body>" +
                 "<h1>âœ“ æ›´æ–°ç”¨æˆ·æˆåŠŸ</h1>" +
                 "<p><a href='/users'>è¿”å›ç”¨æˆ·åˆ—è¡¨</a></p>" +
                 "</body></html>"
      @Http.HttpResponse::ok(html)
    })
    
    // DELETE /users/{id}ï¼ˆç±»ä¼¼ @DeleteMapping("/{id}")ï¼‰
    .delete("/{id}", fn(_request : @Http.HttpRequest) {
      let html = "<!DOCTYPE html><html><head><title>åˆ é™¤ç”¨æˆ·</title><meta charset='utf-8'></head><body>" +
                 "<h1>âœ“ åˆ é™¤ç”¨æˆ·æˆåŠŸ</h1>" +
                 "<p><a href='/users'>è¿”å›ç”¨æˆ·åˆ—è¡¨</a></p>" +
                 "</body></html>"
      @Http.HttpResponse::ok(html)
    })
  
  println("âœ“ åˆ›å»º Controller: /users")
  
  // 4.3 åˆ›å»ºç™»å½•è®¤è¯ Controllerï¼ˆç±»ä¼¼ Spring çš„ @RestControllerï¼‰
  let auth_controller = @Controller.RestController::new("/api/auth")
    // GET /api/auth/loginï¼ˆè¿”å›æ¥å£è¯´æ˜ä¿¡æ¯ï¼‰
    .get("/login", fn(_request : @Http.HttpRequest) {
      let data = @hashmap.new()
      data.set("message", "æ­¤æ¥å£éœ€è¦ä½¿ç”¨ POST æ–¹æ³•æäº¤ç™»å½•ä¿¡æ¯")
      data.set("method", "POST")
      data.set("url", "/api/auth/login")
      data.set("content_type", "application/json")
      data.set("request_body", "{\"username\":\"admin\",\"password\":\"123456\"}")
      data.set("test_accounts", "ç”¨æˆ·å: admin/123456 æˆ– user/password")
      @Controller.JsonResponse::new(data)
    })
    // POST /api/auth/loginï¼ˆç±»ä¼¼ @PostMapping("/login")ï¼‰
    .post("/login", fn(request : @Http.HttpRequest) {
      handle_login(request)
    })
    
    // POST /api/auth/logoutï¼ˆç±»ä¼¼ @PostMapping("/logout")ï¼‰
    .post("/logout", fn(request : @Http.HttpRequest) {
      handle_logout(request)
    })
  
  println("âœ“ åˆ›å»ºè®¤è¯ Controller: /api/auth")
  
  // 4.4 åˆ›å»º REST API Controllerï¼ˆç±»ä¼¼ Spring çš„ @RestControllerï¼‰
  let api_controller = @Controller.RestController::new("/api/users")
    // GET /api/usersï¼ˆç±»ä¼¼ @GetMapping("/")ï¼‰
    .get("/", fn(_request : @Http.HttpRequest) {
      let data = @hashmap.new()
      data.set("id", "1")
      data.set("name", "Alice")
      data.set("email", "alice@example.com")
      @Controller.JsonResponse::new(data)
    })
    
    // GET /api/users/{id}ï¼ˆç±»ä¼¼ @GetMapping("/{id}")ï¼‰
    .get("/{id}", fn(request : @Http.HttpRequest) {
      let path = request.get_path()
      let data = @hashmap.new()
      // ä»è·¯å¾„ä¸­æå– IDï¼ˆç®€åŒ–å¤„ç†ï¼‰
      data.set("id", path)
      data.set("name", "Bob")
      data.set("email", "bob@example.com")
      @Controller.JsonResponse::new(data)
    })
    
    // POST /api/usersï¼ˆç±»ä¼¼ @PostMapping("/")ï¼‰
    .post("/", fn(_request : @Http.HttpRequest) {
      let data = @hashmap.new()
      data.set("id", "2")
      data.set("name", "Charlie")
      data.set("email", "charlie@example.com")
      @Controller.JsonResponse::new(data)
    })
    
    // PUT /api/users/{id}ï¼ˆç±»ä¼¼ @PutMapping("/{id}")ï¼‰
    .put("/{id}", fn(_request : @Http.HttpRequest) {
      let data = @hashmap.new()
      data.set("id", "1")
      data.set("name", "Alice Updated")
      data.set("email", "alice.updated@example.com")
      @Controller.JsonResponse::new(data)
    })
    
    // DELETE /api/users/{id}ï¼ˆç±»ä¼¼ @DeleteMapping("/{id}")ï¼‰
    .delete("/{id}", fn(_request : @Http.HttpRequest) {
      let data = @hashmap.new()
      data.set("status", "deleted")
      data.set("message", "ç”¨æˆ·å·²åˆ é™¤")
      @Controller.JsonResponse::new(data)
    })
  
  println("âœ“ åˆ›å»º RestController: /api/users")
  
  // 4.5 åˆ›å»ºç”¨æˆ·ç³»ç»Ÿ RestController
  let user_api_controller = @Controller.RestController::new("/api/user")
    .post("/register", fn(request : @Http.HttpRequest) {
      match parse_request_params(request) {
        Some(params) => {
          match (params.get("username"), params.get("password")) {
            (Some(username), Some(password)) => {
              let display_name = opt_string_or(params.get("displayName"), username + "_user")
              let email = opt_string_or(params.get("email"), username + "@example.com")
              let response = @hashmap.new()
              response.set("success", "true")
              response.set("userId", "user-" + username)
              response.set("username", username)
              response.set("displayName", display_name)
              response.set("email", email)
              response.set("token", "token-" + username + "-" + password.length().to_string())
              response.set("channel", opt_string_or(params.get("channel"), "default"))
              @Controller.JsonResponse::new(response)
            }
            _ => {
              let error = @hashmap.new()
              error.set("success", "false")
              error.set("message", "username ä¸ password ä¸ºå¿…å¡«é¡¹")
              @Controller.JsonResponse::new(error)
            }
          }
        }
        None => {
          let error = @hashmap.new()
          error.set("success", "false")
          error.set("message", "è¯·æ±‚ä½“ä¸èƒ½ä¸ºç©º")
          @Controller.JsonResponse::new(error)
        }
      }
    })
    .post("/login", fn(request : @Http.HttpRequest) {
      match parse_request_params(request) {
        Some(params) => {
          match (params.get("username"), params.get("password")) {
            (Some(username), Some(password)) => {
              let remember = opt_string_or(params.get("remember"), "false")
              let issued_at = opt_string_or(params.get("timestamp"), "")
              let response = @hashmap.new()
              response.set("success", "true")
              response.set("username", username)
              response.set("token", "token-" + username + "-" + password.length().to_string())
              response.set("remember", remember)
              if issued_at != "" {
                response.set("issuedAt", issued_at)
              }
              @Controller.JsonResponse::new(response)
            }
            _ => {
              let error = @hashmap.new()
              error.set("success", "false")
              error.set("message", "ç”¨æˆ·åæˆ–å¯†ç ç¼ºå¤±")
              @Controller.JsonResponse::new(error)
            }
          }
        }
        None => {
          let error = @hashmap.new()
          error.set("success", "false")
          error.set("message", "è¯·æ±‚ä½“ä¸èƒ½ä¸ºç©º")
          @Controller.JsonResponse::new(error)
        }
      }
    })
    .get("/info", fn(request : @Http.HttpRequest) {
      let auth_header = opt_string_or(request.get_header("Authorization"), "")
      let bearer_token = safe_strip_prefix(auth_header, "Bearer ")
      let token_candidate = if bearer_token != "" {
        bearer_token
      } else {
        opt_string_or(request.get_query_param("token"), "")
      }
      let token_parts = Array::from_iter(token_candidate.split("-"))
      let resolved_username = if token_parts.length() >= 2 {
        token_parts[1].to_string()
      } else if token_candidate != "" {
        token_candidate
      } else {
        "guest"
      }
      let detail = opt_string_or(request.get_query_param("detail"), "basic")
      let response = @hashmap.new()
      response.set("success", "true")
      response.set("username", resolved_username)
      response.set("token", token_candidate)
      response.set("detail", detail)
      response.set("avatar", "https://cdn.example.com/avatar/" + resolved_username + ".png")
      response.set("roles", opt_string_or(request.get_query_param("roles"), "USER"))
      @Controller.JsonResponse::new(response)
    })
    .put("/update", fn(request : @Http.HttpRequest) {
      match parse_request_params(request) {
        Some(params) => {
          let nickname = opt_string_or(params.get("nickname"), "")
          let email = opt_string_or(params.get("email"), "")
          let avatar = opt_string_or(params.get("avatar"), "")
          if nickname == "" && email == "" && avatar == "" {
            let error = @hashmap.new()
            error.set("success", "false")
            error.set("message", "è¯·è‡³å°‘æä¾›ä¸€ä¸ªéœ€è¦æ›´æ–°çš„å­—æ®µ")
            @Controller.JsonResponse::new(error)
          } else {
            let response = @hashmap.new()
            response.set("success", "true")
            if nickname != "" {
              response.set("nickname", nickname)
            }
            if email != "" {
              response.set("email", email)
            }
            if avatar != "" {
              response.set("avatar", avatar)
            }
            response.set("updatedAt", opt_string_or(params.get("timestamp"), ""))
            @Controller.JsonResponse::new(response)
          }
        }
        None => {
          let error = @hashmap.new()
          error.set("success", "false")
          error.set("message", "è¯·æ±‚ä½“ä¸èƒ½ä¸ºç©º")
          @Controller.JsonResponse::new(error)
        }
      }
    })
    .post("/avatar", fn(request : @Http.HttpRequest) {
      match parse_request_params(request) {
        Some(params) => {
          match params.get("fileName") {
            Some(file_name) => {
              let file_size = opt_string_or(params.get("fileSize"), "0")
              let checksum = opt_string_or(params.get("checksum"), "")
              let content_type = opt_string_or(params.get("contentType"), "image/png")
              let response = @hashmap.new()
              response.set("success", "true")
              response.set("fileName", file_name)
              response.set("fileSize", file_size)
              response.set("contentType", content_type)
              response.set("checksum", checksum)
              response.set("avatarUrl", "https://cdn.example.com/avatar/" + file_name)
              @Controller.JsonResponse::new(response)
            }
            None => {
              let error = @hashmap.new()
              error.set("success", "false")
              error.set("message", "fileName ä¸ºå¿…å¡«é¡¹")
              @Controller.JsonResponse::new(error)
            }
          }
        }
        None => {
          let error = @hashmap.new()
          error.set("success", "false")
          error.set("message", "è¯·æ±‚ä½“ä¸èƒ½ä¸ºç©º")
          @Controller.JsonResponse::new(error)
        }
      }
    })
  
  println("âœ“ åˆ›å»ºç”¨æˆ·ç³»ç»Ÿ API: /api/user")
  
  // 4.6 åˆ›å»ºè§†é¢‘æ¨¡å— RestController
  let video_api_controller = @Controller.RestController::new("/api/video")
    .post("/upload", fn(request : @Http.HttpRequest) {
      match parse_request_params(request) {
        Some(params) => {
          match (params.get("title"), params.get("fileName")) {
            (Some(title), Some(file_name)) => {
              let size = opt_string_or(params.get("fileSize"), "0")
              let duration = opt_string_or(params.get("duration"), "0")
              let category = opt_string_or(params.get("category"), "general")
              let response = @hashmap.new()
              response.set("success", "true")
              response.set("videoId", "video-" + title)
              response.set("title", title)
              response.set("fileName", file_name)
              response.set("fileSize", size)
              response.set("duration", duration)
              response.set("category", category)
              response.set("transcodeTaskId", "job-" + file_name)
              @Controller.JsonResponse::new(response)
            }
            _ => {
              let error = @hashmap.new()
              error.set("success", "false")
              error.set("message", "title ä¸ fileName ä¸ºå¿…å¡«é¡¹")
              @Controller.JsonResponse::new(error)
            }
          }
        }
        None => {
          let error = @hashmap.new()
          error.set("success", "false")
          error.set("message", "è¯·æ±‚ä½“ä¸èƒ½ä¸ºç©º")
          @Controller.JsonResponse::new(error)
        }
      }
    })
    .get("/list", fn(request : @Http.HttpRequest) {
      let page = opt_string_or(request.get_query_param("page"), "1")
      let page_size = opt_string_or(request.get_query_param("pageSize"), "10")
      let category = opt_string_or(request.get_query_param("category"), "all")
      let keyword = opt_string_or(request.get_query_param("keyword"), "")
      let base_id = "video-" + page
      let title_prefix = if keyword != "" { keyword } else { "è§†é¢‘" + page }
      let item1 = "{\"id\":\"" + base_id + "-a\",\"title\":\"" + title_prefix + " A\",\"cover\":\"https://cdn.example.com/" + base_id + "-a.jpg\"}"
      let item2 = "{\"id\":\"" + base_id + "-b\",\"title\":\"" + title_prefix + " B\",\"cover\":\"https://cdn.example.com/" + base_id + "-b.jpg\"}"
      let items = "[" + item1 + "," + item2 + "]"
      let meta = "{\"page\":\"" + page + "\",\"pageSize\":\"" + page_size + "\",\"category\":\"" + category + "\",\"hasNext\":\"true\"}"
      let response = @hashmap.new()
      response.set("success", "true")
      response.set("items", items)
      response.set("meta", meta)
      @Controller.JsonResponse::new(response)
    })
    .get("/{id}", fn(request : @Http.HttpRequest) {
      let video_id = extract_path_tail(request.get_path())
      let response = @hashmap.new()
      response.set("success", "true")
      response.set("videoId", video_id)
      response.set("title", "è§†é¢‘ - " + video_id)
      response.set("cover", "https://cdn.example.com/" + video_id + ".jpg")
      response.set("duration", opt_string_or(request.get_query_param("duration"), "180"))
      response.set("playUrl", "https://cdn.example.com/stream/" + video_id + ".m3u8")
      response.set("description", "è§†é¢‘ " + video_id + " çš„åŠ¨æ€æè¿°")
      @Controller.JsonResponse::new(response)
    })
    .post("/{id}/like", fn(request : @Http.HttpRequest) {
      let video_id = extract_path_tail(request.get_path())
      match parse_request_params(request) {
        Some(params) => {
          let action = opt_string_or(params.get("action"), "toggle")
          let response = @hashmap.new()
          response.set("success", "true")
          response.set("videoId", video_id)
          response.set("action", action)
          response.set(
            "status",
            if action == "cancel" { "unliked" } else { "liked" },
          )
          @Controller.JsonResponse::new(response)
        }
        None => {
          let response = @hashmap.new()
          response.set("success", "true")
          response.set("videoId", video_id)
          response.set("action", "toggle")
          response.set("status", "liked")
          @Controller.JsonResponse::new(response)
        }
      }
    })
    .post("/{id}/favorite", fn(request : @Http.HttpRequest) {
      let video_id = extract_path_tail(request.get_path())
      match parse_request_params(request) {
        Some(params) => {
          let action = opt_string_or(params.get("action"), "toggle")
          let response = @hashmap.new()
          response.set("success", "true")
          response.set("videoId", video_id)
          response.set("action", action)
          response.set(
            "status",
            if action == "cancel" { "removed" } else { "favorited" },
          )
          @Controller.JsonResponse::new(response)
        }
        None => {
          let response = @hashmap.new()
          response.set("success", "true")
          response.set("videoId", video_id)
          response.set("action", "toggle")
          response.set("status", "favorited")
          @Controller.JsonResponse::new(response)
        }
      }
    })
    .get("/{id}/comments", fn(request : @Http.HttpRequest) {
      let video_id = extract_path_tail(request.get_path())
      let page = opt_string_or(request.get_query_param("page"), "1")
      let item1 = "{\"id\":\"" + video_id + "-c" + page + "1\",\"author\":\"demo_user\",\"content\":\"å¥½è§†é¢‘ï¼ç¬¬ " + page + " é¡µ\",\"createdAt\":\"2025-11-08T12:00:00Z\"}"
      let item2 = "{\"id\":\"" + video_id + "-c" + page + "2\",\"author\":\"guest\",\"content\":\"ç‚¹èµå­¦ä¹ \",\"createdAt\":\"2025-11-08T12:05:00Z\"}"
      let comments = "[" + item1 + "," + item2 + "]"
      let response = @hashmap.new()
      response.set("success", "true")
      response.set("videoId", video_id)
      response.set("comments", comments)
      response.set("page", page)
      @Controller.JsonResponse::new(response)
    })
    .post("/{id}/comment", fn(request : @Http.HttpRequest) {
      let video_id = extract_path_tail(request.get_path())
      match parse_request_params(request) {
        Some(params) => {
          match params.get("content") {
            Some(content) => {
              let author = opt_string_or(params.get("author"), "anonymous")
              let response = @hashmap.new()
              response.set("success", "true")
              response.set("videoId", video_id)
              response.set("commentId", video_id + "-c" + author)
              response.set("author", author)
              response.set("content", content)
              response.set("createdAt", opt_string_or(params.get("timestamp"), ""))
              @Controller.JsonResponse::new(response)
            }
            None => {
              let error = @hashmap.new()
              error.set("success", "false")
              error.set("message", "content ä¸ºå¿…å¡«é¡¹")
              @Controller.JsonResponse::new(error)
            }
          }
        }
        None => {
          let error = @hashmap.new()
          error.set("success", "false")
          error.set("message", "è¯·æ±‚ä½“ä¸èƒ½ä¸ºç©º")
          @Controller.JsonResponse::new(error)
        }
      }
    })
    .get("/recommend", fn(request : @Http.HttpRequest) {
      let user_id = opt_string_or(request.get_query_param("userId"), "anonymous")
      let seed = opt_string_or(request.get_query_param("seed"), "popular")
      let stream = "[" +
        "{\"id\":\"rec-" + seed + "-1\",\"title\":\"ä¸º " + user_id + " æ¨èçš„è§†é¢‘ 1\"}," +
        "{\"id\":\"rec-" + seed + "-2\",\"title\":\"ä¸º " + user_id + " æ¨èçš„è§†é¢‘ 2\"}" +
      "]"
      let response = @hashmap.new()
      response.set("success", "true")
      response.set("userId", user_id)
      response.set("seed", seed)
      response.set("items", stream)
      @Controller.JsonResponse::new(response)
    })
  
  println("âœ“ åˆ›å»ºè§†é¢‘æ¨¡å— API: /api/video")
  
  // 4.7 åˆ›å»ºæœç´¢ API
  let search_controller = @Controller.RestController::new("/api")
    .get("/search", fn(request : @Http.HttpRequest) {
      let keyword = opt_string_or(request.get_query_param("q"), "")
      if keyword == "" {
        let error = @hashmap.new()
        error.set("success", "false")
        error.set("message", "q ä¸ºå¿…å¡«æŸ¥è¯¢å‚æ•°")
        return @Controller.JsonResponse::new(error)
      }
      let page = opt_string_or(request.get_query_param("page"), "1")
      let results = "[" +
        "{\"id\":\"search-" + keyword + "-1\",\"title\":\"" + keyword + " ç›¸å…³è§†é¢‘ A\"}," +
        "{\"id\":\"search-" + keyword + "-2\",\"title\":\"" + keyword + " ç›¸å…³è§†é¢‘ B\"}" +
      "]"
      let response = @hashmap.new()
      response.set("success", "true")
      response.set("keyword", keyword)
      response.set("page", page)
      response.set("results", results)
      @Controller.JsonResponse::new(response)
    })
  
  println("âœ“ åˆ›å»ºæœç´¢ API: /api/search")
  
  // 4.8 åˆ›å»º AI äº’åŠ¨æ¥å£
  let ai_controller = @Controller.RestController::new("/api/ai")
    .post("/chat", fn(request : @Http.HttpRequest) {
      match parse_request_params(request) {
        Some(params) => {
          match params.get("prompt") {
            Some(prompt) => {
              let session_id = opt_string_or(params.get("sessionId"), "session-temp")
              let response = @hashmap.new()
              response.set("success", "true")
              response.set("sessionId", session_id)
              response.set("reply", "AI é’ˆå¯¹ \"" + prompt + "\" çš„ç¤ºä¾‹å›ç­”")
              response.set("promptTokens", prompt.length().to_string())
              @Controller.JsonResponse::new(response)
            }
            None => {
              let error = @hashmap.new()
              error.set("success", "false")
              error.set("message", "prompt ä¸ºå¿…å¡«é¡¹")
              @Controller.JsonResponse::new(error)
            }
          }
        }
        None => {
          let error = @hashmap.new()
          error.set("success", "false")
          error.set("message", "è¯·æ±‚ä½“ä¸èƒ½ä¸ºç©º")
          @Controller.JsonResponse::new(error)
        }
      }
    })
    .post("/voice", fn(request : @Http.HttpRequest) {
      match parse_request_params(request) {
        Some(params) => {
          match params.get("voiceId") {
            Some(voice_id) => {
              let response = @hashmap.new()
              response.set("success", "true")
              response.set("voiceId", voice_id)
              response.set("transcript", opt_string_or(params.get("transcript"), ""))
              response.set("reply", "AI è¯­éŸ³å›å¤å·²ç”Ÿæˆ")
              @Controller.JsonResponse::new(response)
            }
            None => {
              let error = @hashmap.new()
              error.set("success", "false")
              error.set("message", "voiceId ä¸ºå¿…å¡«é¡¹")
              @Controller.JsonResponse::new(error)
            }
          }
        }
        None => {
          let error = @hashmap.new()
          error.set("success", "false")
          error.set("message", "è¯·æ±‚ä½“ä¸èƒ½ä¸ºç©º")
          @Controller.JsonResponse::new(error)
        }
      }
    })
    .post("/emotion", fn(request : @Http.HttpRequest) {
      match parse_request_params(request) {
        Some(params) => {
          match params.get("content") {
            Some(content) => {
              let response = @hashmap.new()
              response.set("success", "true")
              response.set("emotion", opt_string_or(params.get("target"), "neutral"))
              response.set("score", "0.82")
              response.set("contentPreview", content)
              @Controller.JsonResponse::new(response)
            }
            None => {
              let error = @hashmap.new()
              error.set("success", "false")
              error.set("message", "content ä¸ºå¿…å¡«é¡¹")
              @Controller.JsonResponse::new(error)
            }
          }
        }
        None => {
          let error = @hashmap.new()
          error.set("success", "false")
          error.set("message", "è¯·æ±‚ä½“ä¸èƒ½ä¸ºç©º")
          @Controller.JsonResponse::new(error)
        }
      }
    })
  
  println("âœ“ åˆ›å»º AI äº’åŠ¨ API: /api/ai")
  
  // 4.9 åˆ›å»º WebSocket åè°ƒæ¥å£ï¼ˆHTTP è¿”å›æ¡æ‰‹ä¿¡æ¯ï¼‰
  let ws_controller = @Controller.RestController::new("/ws")
    .get("/chat", fn(request : @Http.HttpRequest) {
      let response = @hashmap.new()
      response.set("success", "true")
      response.set("protocol", "websocket")
      response.set("endpoint", "ws://" + opt_string_or(request.get_header("Host"), "localhost:8080") + "/ws/chat")
      response.set("note", "å½“å‰ç¤ºä¾‹ä»…è¿”å›æ¡æ‰‹è¯´æ˜ï¼Œå®é™… WebSocket å‡çº§éœ€åº•å±‚æœåŠ¡å™¨æ”¯æŒ")
      @Controller.JsonResponse::new(response)
    })
  
  println("âœ“ åˆ›å»º WebSocket ä¿¡æ¯æ¥å£: /ws/chat")
  
  // 4.10 åˆ›å»ºç³»ç»Ÿé…ç½® Controllerï¼ˆæ—¥å¿—ä¸Šä¼ ç­‰æ¥å£ï¼‰
  let system_controller = @Controller.RestController::new("/api/system")
    .get("/config", fn(request : @Http.HttpRequest) {
      let env = opt_string_or(request.get_query_param("env"), "dev")
      let response = @hashmap.new()
      response.set("success", "true")
      response.set("env", env)
      response.set("cdn", opt_string_or(request.get_query_param("cdn"), "https://cdn.example.com"))
      response.set("enableFeatureX", opt_string_or(request.get_query_param("featureX"), "false"))
      response.set("timestamp", opt_string_or(request.get_query_param("timestamp"), ""))
      @Controller.JsonResponse::new(response)
    })
    // POST /api/system/logs - ä¸Šä¼ å®¢æˆ·ç«¯æ—¥å¿—
    .post("/logs", fn(request : @Http.HttpRequest) {
      handle_log_upload(request)
    })
  
  println("âœ“ åˆ›å»ºç³»ç»Ÿ Controller: /api/system")
  
  // 4.6 åˆ›å»º DispatcherServletï¼ˆç±»ä¼¼ Spring MVC çš„ DispatcherServletï¼‰
  let dispatcher = @Dispatcher.DispatcherServlet::new()
    .register_controller("rootController", root_controller)
    .register_controller("userController", user_controller)
    .register_rest_controller("authController", auth_controller)
    .register_rest_controller("apiController", api_controller)
    .register_rest_controller("userApiController", user_api_controller)
    .register_rest_controller("videoApiController", video_api_controller)
    .register_rest_controller("searchController", search_controller)
    .register_rest_controller("aiController", ai_controller)
    .register_rest_controller("wsController", ws_controller)
    .register_rest_controller("systemController", system_controller)
  
  println("âœ“ åˆ›å»º DispatcherServlet")
  println("")
  
  // ========== ç¬¬äº”æ­¥ï¼šæµ‹è¯•è¯·æ±‚å¤„ç† ==========
  println("ğŸ§ª ç¬¬äº”æ­¥ï¼šæµ‹è¯•è¯·æ±‚å¤„ç†")
  println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
  
  // 5.1 æµ‹è¯• GET /
  let request0 = @Http.HttpRequest::new(
    @Http.HttpMethod::from_string("GET"),
    "/",
    @hashmap.new(),
    @hashmap.new(),
    None
  )
  let response0 = dispatcher.handle_request(request0)
  println("âœ“ GET /")
  println("  çŠ¶æ€ç : " + response0.get_status_code().to_string())
  match response0.get_body() {
    Some(body) => println("  å“åº”ä½“é•¿åº¦: " + body.length().to_string() + " å­—ç¬¦")
    None => println("  å“åº”ä½“: æ— ")
  }
  
  // 5.2 æµ‹è¯• GET /users
  let request1 = @Http.HttpRequest::new(
    @Http.HttpMethod::from_string("GET"),
    "/users",
    @hashmap.new(),
    @hashmap.new(),
    None
  )
  let response1 = dispatcher.handle_request(request1)
  println("âœ“ GET /users")
  println("  çŠ¶æ€ç : " + response1.get_status_code().to_string())
  match response1.get_body() {
    Some(body) => println("  å“åº”ä½“é•¿åº¦: " + body.length().to_string() + " å­—ç¬¦")
    None => println("  å“åº”ä½“: æ— ")
  }
  
  // 5.3 æµ‹è¯• GET /api/users
  let request2 = @Http.HttpRequest::new(
    @Http.HttpMethod::from_string("GET"),
    "/api/users",
    @hashmap.new(),
    @hashmap.new(),
    None
  )
  let response2 = dispatcher.handle_request(request2)
  println("âœ“ GET /api/users")
  println("  çŠ¶æ€ç : " + response2.get_status_code().to_string())
  match response2.get_body() {
    Some(body) => println("  å“åº”ä½“: " + body)
    None => println("  å“åº”ä½“: æ— ")
  }
  
  // 5.4 æµ‹è¯• GET /users/123
  let request3 = @Http.HttpRequest::new(
    @Http.HttpMethod::from_string("GET"),
    "/users/123",
    @hashmap.new(),
    @hashmap.new(),
    None
  )
  let response3 = dispatcher.handle_request(request3)
  println("âœ“ GET /users/123")
  println("  çŠ¶æ€ç : " + response3.get_status_code().to_string())
  
  // 5.5 æµ‹è¯• GET /api/users/123
  let request4 = @Http.HttpRequest::new(
    @Http.HttpMethod::from_string("GET"),
    "/api/users/123",
    @hashmap.new(),
    @hashmap.new(),
    None
  )
  let response4 = dispatcher.handle_request(request4)
  println("âœ“ GET /api/users/123")
  println("  çŠ¶æ€ç : " + response4.get_status_code().to_string())
  match response4.get_body() {
    Some(body) => println("  å“åº”ä½“: " + body)
    None => println("  å“åº”ä½“: æ— ")
  }
  
  // 5.6 æµ‹è¯• POST /api/auth/login
  let login_body = "{\"username\":\"admin\",\"password\":\"123456\"}"
  let login_headers = @hashmap.new()
  login_headers.set("Content-Type", "application/json")
  let request5 = @Http.HttpRequest::new(
    @Http.HttpMethod::from_string("POST"),
    "/api/auth/login",
    @hashmap.new(),
    login_headers,
    Some(login_body)
  )
  let response5 = dispatcher.handle_request(request5)
  println("âœ“ POST /api/auth/login")
  println("  çŠ¶æ€ç : " + response5.get_status_code().to_string())
  match response5.get_body() {
    Some(body) => println("  å“åº”ä½“: " + body)
    None => println("  å“åº”ä½“: æ— ")
  }
  
  // 5.7 æµ‹è¯• POST /api/auth/logout
  let logout_headers = @hashmap.new()
  logout_headers.set("Content-Type", "application/json")
  let request6 = @Http.HttpRequest::new(
    @Http.HttpMethod::from_string("POST"),
    "/api/auth/logout",
    @hashmap.new(),
    logout_headers,
    None
  )
  let response6 = dispatcher.handle_request(request6)
  println("âœ“ POST /api/auth/logout")
  println("  çŠ¶æ€ç : " + response6.get_status_code().to_string())
  match response6.get_body() {
    Some(body) => println("  å“åº”ä½“: " + body)
    None => println("  å“åº”ä½“: æ— ")
  }
  
  // 5.8 æµ‹è¯• POST /api/system/logs
  let log_payload = "{\"level\":\"INFO\",\"message\":\"åˆå§‹åŒ–æˆåŠŸ\",\"timestamp\":\"2025-11-08T12:00:00Z\",\"origin\":\"frontend\",\"device\":\"web\"}"
  let system_headers = @hashmap.new()
  system_headers.set("Content-Type", "application/json")
  system_headers.set("X-Request-Id", "req-log-demo-1")
  let request7 = @Http.HttpRequest::new(
    @Http.HttpMethod::from_string("POST"),
    "/api/system/logs",
    @hashmap.new(),
    system_headers,
    Some(log_payload)
  )
  let response7 = dispatcher.handle_request(request7)
  println("âœ“ POST /api/system/logs")
  println("  çŠ¶æ€ç : " + response7.get_status_code().to_string())
  match response7.get_body() {
    Some(body) => println("  å“åº”ä½“: " + body)
    None => println("  å“åº”ä½“: æ— ")
  }
  
  // 5.9 æµ‹è¯• POST /api/user/register
  let register_body = "{\"username\":\"demo_user\",\"password\":\"pass123\",\"displayName\":\"ç¤ºä¾‹ç”¨æˆ·\",\"channel\":\"ios\"}"
  let register_headers = @hashmap.new()
  register_headers.set("Content-Type", "application/json")
  let request8 = @Http.HttpRequest::new(
    @Http.HttpMethod::from_string("POST"),
    "/api/user/register",
    @hashmap.new(),
    register_headers,
    Some(register_body)
  )
  let response8 = dispatcher.handle_request(request8)
  println("âœ“ POST /api/user/register")
  println("  çŠ¶æ€ç : " + response8.get_status_code().to_string())
  match response8.get_body() {
    Some(body) => println("  å“åº”ä½“: " + body)
    None => println("  å“åº”ä½“: æ— ")
  }
  
  // 5.10 æµ‹è¯• GET /api/video/list
  let request9 = @Http.HttpRequest::new(
    @Http.HttpMethod::from_string("GET"),
    "/api/video/list?page=1&pageSize=2&keyword=moonbit",
    @hashmap.new(),
    @hashmap.new(),
    None
  )
  let response9 = dispatcher.handle_request(request9)
  println("âœ“ GET /api/video/list")
  println("  çŠ¶æ€ç : " + response9.get_status_code().to_string())
  match response9.get_body() {
    Some(body) => println("  å“åº”ä½“: " + body)
    None => println("  å“åº”ä½“: æ— ")
  }
  
  // 5.11 æµ‹è¯• GET /api/search?q=moonbit
  let request10 = @Http.HttpRequest::new(
    @Http.HttpMethod::from_string("GET"),
    "/api/search?q=moonbit&page=1",
    @hashmap.new(),
    @hashmap.new(),
    None
  )
  let response10 = dispatcher.handle_request(request10)
  println("âœ“ GET /api/search")
  println("  çŠ¶æ€ç : " + response10.get_status_code().to_string())
  match response10.get_body() {
    Some(body) => println("  å“åº”ä½“: " + body)
    None => println("  å“åº”ä½“: æ— ")
  }
  
  // 5.12 æµ‹è¯• POST /api/ai/chat
  let ai_body = "{\"prompt\":\"è¯·æ¨èä¸€éƒ¨ç§‘å¹»ç”µå½±\",\"sessionId\":\"session-demo\"}"
  let ai_headers = @hashmap.new()
  ai_headers.set("Content-Type", "application/json")
  let request11 = @Http.HttpRequest::new(
    @Http.HttpMethod::from_string("POST"),
    "/api/ai/chat",
    @hashmap.new(),
    ai_headers,
    Some(ai_body)
  )
  let response11 = dispatcher.handle_request(request11)
  println("âœ“ POST /api/ai/chat")
  println("  çŠ¶æ€ç : " + response11.get_status_code().to_string())
  match response11.get_body() {
    Some(body) => println("  å“åº”ä½“: " + body)
    None => println("  å“åº”ä½“: æ— ")
  }
  
  // 5.13 æµ‹è¯• GET /ws/chat
  let ws_headers = @hashmap.new()
  ws_headers.set("Host", "localhost:8080")
  let request12 = @Http.HttpRequest::new(
    @Http.HttpMethod::from_string("GET"),
    "/ws/chat",
    @hashmap.new(),
    ws_headers,
    None
  )
  let response12 = dispatcher.handle_request(request12)
  println("âœ“ GET /ws/chat")
  println("  çŠ¶æ€ç : " + response12.get_status_code().to_string())
  match response12.get_body() {
    Some(body) => println("  å“åº”ä½“: " + body)
    None => println("  å“åº”ä½“: æ— ")
  }
  
  // 5.14 æµ‹è¯• 404
  let request13 = @Http.HttpRequest::new(
    @Http.HttpMethod::from_string("GET"),
    "/not-found",
    @hashmap.new(),
    @hashmap.new(),
    None
  )
  let response13 = dispatcher.handle_request(request13)
  println("âœ“ GET /not-found (404)")
  println("  çŠ¶æ€ç : " + response13.get_status_code().to_string())
  println("")
  
  // ========== ç¬¬å…­æ­¥ï¼šæŸ¥çœ‹å®¹å™¨çŠ¶æ€ ==========
  println("ğŸ“Š ç¬¬å…­æ­¥ï¼šæŸ¥çœ‹å®¹å™¨çŠ¶æ€")
  println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
  
  ctx.print_summary()
  println("")
  
  // ========== ç¬¬ä¸ƒæ­¥ï¼šä½¿ç”¨ Boot å¯åŠ¨åº”ç”¨ ==========
  println("ğŸš€ ç¬¬ä¸ƒæ­¥ï¼šä½¿ç”¨ Boot å¯åŠ¨åº”ç”¨")
  println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
  
  println("âœ“ å‡†å¤‡å¯åŠ¨åµŒå…¥å¼æœåŠ¡å™¨...")
  println("  ç«¯å£: 8080")
  println("  è®¿é—®åœ°å€: http://localhost:8080")
  println("")
  println("ğŸ“Œ å¯ç”¨ç«¯ç‚¹ï¼š")
  println("  - GET  http://localhost:8080/              - é¦–é¡µ")
  println("  - GET  http://localhost:8080/users         - ç”¨æˆ·åˆ—è¡¨ï¼ˆHTMLï¼‰")
  println("  - GET  http://localhost:8080/users/{id}     - ç”¨æˆ·è¯¦æƒ…ï¼ˆHTMLï¼‰")
  println("  - POST http://localhost:8080/users          - åˆ›å»ºç”¨æˆ·ï¼ˆHTMLï¼‰")
  println("  - GET  http://localhost:8080/api/users      - ç”¨æˆ·åˆ—è¡¨ï¼ˆJSONï¼‰")
  println("  - GET  http://localhost:8080/api/users/{id} - ç”¨æˆ·è¯¦æƒ…ï¼ˆJSONï¼‰")
  println("  - POST http://localhost:8080/api/users      - åˆ›å»ºç”¨æˆ·ï¼ˆJSONï¼‰")
  println("  - POST http://localhost:8080/api/auth/login  - ç”¨æˆ·ç™»å½•ï¼ˆJSONï¼‰")
  println("  - POST http://localhost:8080/api/auth/logout - ç”¨æˆ·ç™»å‡ºï¼ˆJSONï¼‰")
  println("  - POST http://localhost:8080/api/user/register - è§†é¢‘ç«™æ³¨å†Œç”¨æˆ·")
  println("  - POST http://localhost:8080/api/user/login    - è§†é¢‘ç«™ç”¨æˆ·ç™»å½•")
  println("  - GET  http://localhost:8080/api/user/info     - è·å–ç”¨æˆ·ä¿¡æ¯")
  println("  - PUT  http://localhost:8080/api/user/update   - ä¿®æ”¹ç”¨æˆ·èµ„æ–™")
  println("  - POST http://localhost:8080/api/user/avatar   - ä¸Šä¼ ç”¨æˆ·å¤´åƒ")
  println("  - POST http://localhost:8080/api/video/upload  - ä¸Šä¼ è§†é¢‘")
  println("  - GET  http://localhost:8080/api/video/list    - è§†é¢‘åˆ—è¡¨")
  println("  - GET  http://localhost:8080/api/video/{id}    - è§†é¢‘è¯¦æƒ…")
  println("  - POST http://localhost:8080/api/video/{id}/like     - ç‚¹èµ/å–æ¶ˆç‚¹èµ")
  println("  - POST http://localhost:8080/api/video/{id}/favorite - æ”¶è—/å–æ¶ˆæ”¶è—")
  println("  - GET  http://localhost:8080/api/video/{id}/comments - è¯„è®ºåˆ—è¡¨")
  println("  - POST http://localhost:8080/api/video/{id}/comment  - å‘è¡¨è¯„è®º")
  println("  - GET  http://localhost:8080/api/video/recommend - è§†é¢‘æ¨èæµ")
  println("  - GET  http://localhost:8080/api/search        - è§†é¢‘æœç´¢")
  println("  - POST http://localhost:8080/api/ai/chat       - AI æ–‡æœ¬å¯¹è¯")
  println("  - POST http://localhost:8080/api/ai/voice      - AI è¯­éŸ³å¯¹è¯")
  println("  - POST http://localhost:8080/api/ai/emotion    - æƒ…ç»ªæ£€æµ‹")
  println("  - GET  http://localhost:8080/ws/chat           - WebSocket æ¡æ‰‹ä¿¡æ¯")
  println("  - GET  http://localhost:8080/api/system/config - è·å–ç³»ç»Ÿé…ç½®")
  println("  - POST http://localhost:8080/api/system/logs - ä¸Šä¼ å®¢æˆ·ç«¯æ—¥å¿—ï¼ˆJSON æˆ–è¡¨å•ï¼‰")
  println("")
  println("ğŸ“Œ æµ‹è¯•è´¦å·ï¼š")
  println("  - ç”¨æˆ·å: admin, å¯†ç : 123456")
  println("  - ç”¨æˆ·å: user, å¯†ç : password")
  println("")
  
  // ä½¿ç”¨ BootApplication å¯åŠ¨åº”ç”¨ï¼ˆç±»ä¼¼ Spring Boot çš„ @SpringBootApplicationï¼‰
  // BootApplication::run() ä¼šé˜»å¡ï¼Œç›´åˆ°æœåŠ¡å™¨åœæ­¢
  @Boot.BootApplication::run(8080, fn() {
    dispatcher
  })
  
  // æœåŠ¡å™¨åœæ­¢åæ‰ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ
  println("")
  println("============================================================")
  println("âœ¨ æœåŠ¡å™¨å·²åœæ­¢ï¼Œç¤ºä¾‹åº”ç”¨å®Œæˆï¼")
  println("============================================================")
}
