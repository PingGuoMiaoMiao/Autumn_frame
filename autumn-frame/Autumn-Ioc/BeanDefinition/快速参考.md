# BeanDefinition 快速参考

## 快速开始

```moonbit
// 1. 通过构造函数创建 Bean
let bean1 = BeanDefinition::new_from_constructor(
  "userService",                    // 名称
  "com.example.UserService",        // 类型
  0,                                // 顺序
  false,                            // primary
  Some("init"),                     // init 方法
  Some("destroy")                   // destroy 方法
)

// 2. 通过工厂方法创建 Bean
let bean2 = BeanDefinition::new_from_factory(
  "dataSource",                     // 名称
  "javax.sql.DataSource",           // 类型
  "appConfig",                      // 工厂 Bean
  "createDataSource",               // 工厂方法
  1,                                // 顺序
  true,                             // primary
  Some("init"),                     // init 方法
  Some("close")                     // destroy 方法
)
```

## 核心数据结构

```moonbit
pub struct BeanDefinition {
  name : String                    // Bean 名称
  bean_class : String              // Bean 类型
  creation_type : BeanCreationType // 创建方式
  factory_method_name : String?    // 工厂方法名
  mut instance : BeanInstance      // 实例
  order : Int                      // 排序
  primary : Bool                   // 优先级
  init_method_name : String?       // 初始化方法
  destroy_method_name : String?    // 销毁方法
}
```

## 创建方式

| 类型 | 说明 | 对应注解 |
|------|------|---------|
| `Constructor` | 构造函数创建 | `@Component` |
| `FactoryMethod(String)` | 工厂方法创建 | `@Bean` |

## 常用方法

### 查询信息
```moonbit
def.get_name()                    // 获取名称
def.get_bean_class()              // 获取类型
def.get_order()                   // 获取顺序
def.is_primary()                  // 是否 primary
def.has_instance()                // 是否有实例
def.is_constructor_creation()     // 是否构造函数创建
def.is_factory_creation()         // 是否工厂方法创建
def.get_factory_bean_name()       // 获取工厂 Bean 名称
def.get_factory_method_name()     // 获取工厂方法名称
def.get_init_method_name()        // 获取 init 方法名
def.get_destroy_method_name()     // 获取 destroy 方法名
```

### 管理实例
```moonbit
def.set_instance("instance_id")   // 设置实例
def.get_instance()                // 获取实例
```

### 工具方法
```moonbit
def.to_string()                   // 转换为字符串
println(def)                      // 打印（实现了 Show）
```

## 与其他模块配合

### 1. 与 ResourceResolver 配合

```moonbit
// 扫描类
let resolver = ResourceResolver::new("com.example")
let classes = resolver.scan(fn(res) {
  if res.name.has_suffix(".mbt") {
    Some(res.name)
  } else {
    None
  }
})

// 为每个类创建 BeanDefinition
let defs = @hashmap.new()
let _ = classes.map(fn(class_name) {
  let def = BeanDefinition::new_from_constructor(
    extract_bean_name(class_name),
    class_name,
    0,
    false,
    None,
    None
  )
  defs.set(def.get_name(), def)
})
```

### 2. 与 PropertyResolver 配合

```moonbit
// 读取配置
let props = PropertyResolver::from_array([
  ("db.host", "localhost"),
  ("db.port", "5432")
])

// 创建 Bean 时注入配置
let db_host = props.get_property("db.host").or("localhost")
let db_port = props.get_property_int("db.port").or(5432)

// 使用配置创建 Bean
let def = BeanDefinition::new_from_factory(
  "dataSource",
  "DataSource",
  "config",
  "createDataSource",
  0,
  true,
  None,
  None
)
```

## IoC 容器使用场景

### 按名称查找
```moonbit
let beans : @hashmap.HashMap[String, BeanDefinition] = ...

match beans.get("userService") {
  Some(def) => println("Found: " + def.get_name())
  None => println("Not found")
}
```

### 按类型查找
```moonbit
fn find_by_type(beans : @hashmap.HashMap[String, BeanDefinition], type_name : String) -> Array[BeanDefinition] {
  let results = []
  beans.iter().each(fn(entry) {
    let (_, def) = entry
    if def.get_bean_class() == type_name {
      results.push(def)
    }
  })
  results
}

let defs = find_by_type(beans, "DataSource")
if defs.length() > 1 {
  // 查找 @Primary
  for i = 0; i < defs.length(); i = i + 1 {
    if defs[i].is_primary() {
      println("Primary: " + defs[i].get_name())
      break
    }
  }
}
```

### Bean 排序
```moonbit
let defs = [def1, def2, def3]
defs.sort()  // 按 order 排序

for i = 0; i < defs.length(); i = i + 1 {
  println(defs[i].get_name())
}
```

## 生命周期管理

```moonbit
// 1. 创建 Bean
let def = BeanDefinition::new_from_constructor(...)

// 2. 实例化
def.set_instance("bean_instance")

// 3. 调用 init 方法
match def.get_init_method_name() {
  Some(method_name) => {
    println("Calling init method: " + method_name)
    // 反射调用 method_name
  }
  None => ()
}

// 4. Bean 可用
println("Bean ready: " + def.get_name())

// 5. 销毁时调用 destroy 方法
match def.get_destroy_method_name() {
  Some(method_name) => {
    println("Calling destroy method: " + method_name)
    // 反射调用 method_name
  }
  None => ()
}
```

## Spring 对比

| 特性 | Spring | Moonbit |
|------|--------|---------|
| 单例/原型 | ✅ | ❌ |
| 懒加载 | ✅ | ❌ |
| 依赖注入 | ✅ | 🚧 待实现 |
| @Primary | ✅ | ✅ |
| @Order | ✅ | ✅ |
| init/destroy | ✅ | ✅ |
| 工厂方法 | ✅ | ✅ |

## 注意事项

1. **Bean 名称必须唯一**
2. **声明类型 vs 实际类型**：存储声明类型
3. **工厂 Bean 也要注册**：工厂 Bean 本身也是 Bean
4. **@Primary 唯一性**：一个类型只能有一个 @Primary
5. **实例延迟创建**：BeanDefinition 创建时 instance 为 None

## 测试

```bash
moon check autumn-frame/Autumn-Ioc/BeanDefinition
```

## 相关文档

- [完整文档](README.md)
- [ResourceResolver](../ResourceResolver/README.md)
- [PropertyResolver](../PropertyResolver/README.md)
