# BeanDefinition å¿«é€Ÿå‚è€ƒ

## å¿«é€Ÿå¼€å§‹

```moonbit
// 1. é€šè¿‡æ„é€ å‡½æ•°åˆ›å»º Bean
let bean1 = BeanDefinition::new_from_constructor(
  "userService",                    // åç§°
  "com.example.UserService",        // ç±»å‹
  0,                                // é¡ºåº
  false,                            // primary
  Some("init"),                     // init æ–¹æ³•
  Some("destroy")                   // destroy æ–¹æ³•
)

// 2. é€šè¿‡å·¥å‚æ–¹æ³•åˆ›å»º Bean
let bean2 = BeanDefinition::new_from_factory(
  "dataSource",                     // åç§°
  "javax.sql.DataSource",           // ç±»å‹
  "appConfig",                      // å·¥å‚ Bean
  "createDataSource",               // å·¥å‚æ–¹æ³•
  1,                                // é¡ºåº
  true,                             // primary
  Some("init"),                     // init æ–¹æ³•
  Some("close")                     // destroy æ–¹æ³•
)
```

## æ ¸å¿ƒæ•°æ®ç»“æ„

```moonbit
pub struct BeanDefinition {
  name : String                    // Bean åç§°
  bean_class : String              // Bean ç±»å‹
  creation_type : BeanCreationType // åˆ›å»ºæ–¹å¼
  factory_method_name : String?    // å·¥å‚æ–¹æ³•å
  mut instance : BeanInstance      // å®ä¾‹
  order : Int                      // æ’åº
  primary : Bool                   // ä¼˜å…ˆçº§
  init_method_name : String?       // åˆå§‹åŒ–æ–¹æ³•
  destroy_method_name : String?    // é”€æ¯æ–¹æ³•
}
```

## åˆ›å»ºæ–¹å¼

| ç±»å‹ | è¯´æ˜ | å¯¹åº”æ³¨è§£ |
|------|------|---------|
| `Constructor` | æ„é€ å‡½æ•°åˆ›å»º | `@Component` |
| `FactoryMethod(String)` | å·¥å‚æ–¹æ³•åˆ›å»º | `@Bean` |

## å¸¸ç”¨æ–¹æ³•

### æŸ¥è¯¢ä¿¡æ¯
```moonbit
def.get_name()                    // è·å–åç§°
def.get_bean_class()              // è·å–ç±»å‹
def.get_order()                   // è·å–é¡ºåº
def.is_primary()                  // æ˜¯å¦ primary
def.has_instance()                // æ˜¯å¦æœ‰å®ä¾‹
def.is_constructor_creation()     // æ˜¯å¦æ„é€ å‡½æ•°åˆ›å»º
def.is_factory_creation()         // æ˜¯å¦å·¥å‚æ–¹æ³•åˆ›å»º
def.get_factory_bean_name()       // è·å–å·¥å‚ Bean åç§°
def.get_factory_method_name()     // è·å–å·¥å‚æ–¹æ³•åç§°
def.get_init_method_name()        // è·å– init æ–¹æ³•å
def.get_destroy_method_name()     // è·å– destroy æ–¹æ³•å
```

### ç®¡ç†å®ä¾‹
```moonbit
def.set_instance("instance_id")   // è®¾ç½®å®ä¾‹
def.get_instance()                // è·å–å®ä¾‹
```

### å·¥å…·æ–¹æ³•
```moonbit
def.to_string()                   // è½¬æ¢ä¸ºå­—ç¬¦ä¸²
println(def)                      // æ‰“å°ï¼ˆå®ç°äº† Showï¼‰
```

## ä¸å…¶ä»–æ¨¡å—é…åˆ

### 1. ä¸ ResourceResolver é…åˆ

```moonbit
// æ‰«æç±»
let resolver = ResourceResolver::new("com.example")
let classes = resolver.scan(fn(res) {
  if res.name.has_suffix(".mbt") {
    Some(res.name)
  } else {
    None
  }
})

// ä¸ºæ¯ä¸ªç±»åˆ›å»º BeanDefinition
let defs = @hashmap.new()
let _ = classes.map(fn(class_name) {
  let def = BeanDefinition::new_from_constructor(
    extract_bean_name(class_name),
    class_name,
    0,
    false,
    None,
    None
  )
  defs.set(def.get_name(), def)
})
```

### 2. ä¸ PropertyResolver é…åˆ

```moonbit
// è¯»å–é…ç½®
let props = PropertyResolver::from_array([
  ("db.host", "localhost"),
  ("db.port", "5432")
])

// åˆ›å»º Bean æ—¶æ³¨å…¥é…ç½®
let db_host = props.get_property("db.host").or("localhost")
let db_port = props.get_property_int("db.port").or(5432)

// ä½¿ç”¨é…ç½®åˆ›å»º Bean
let def = BeanDefinition::new_from_factory(
  "dataSource",
  "DataSource",
  "config",
  "createDataSource",
  0,
  true,
  None,
  None
)
```

## IoC å®¹å™¨ä½¿ç”¨åœºæ™¯

### æŒ‰åç§°æŸ¥æ‰¾
```moonbit
let beans : @hashmap.HashMap[String, BeanDefinition] = ...

match beans.get("userService") {
  Some(def) => println("Found: " + def.get_name())
  None => println("Not found")
}
```

### æŒ‰ç±»å‹æŸ¥æ‰¾
```moonbit
fn find_by_type(beans : @hashmap.HashMap[String, BeanDefinition], type_name : String) -> Array[BeanDefinition] {
  let results = []
  beans.iter().each(fn(entry) {
    let (_, def) = entry
    if def.get_bean_class() == type_name {
      results.push(def)
    }
  })
  results
}

let defs = find_by_type(beans, "DataSource")
if defs.length() > 1 {
  // æŸ¥æ‰¾ @Primary
  for i = 0; i < defs.length(); i = i + 1 {
    if defs[i].is_primary() {
      println("Primary: " + defs[i].get_name())
      break
    }
  }
}
```

### Bean æ’åº
```moonbit
let defs = [def1, def2, def3]
defs.sort()  // æŒ‰ order æ’åº

for i = 0; i < defs.length(); i = i + 1 {
  println(defs[i].get_name())
}
```

## ç”Ÿå‘½å‘¨æœŸç®¡ç†

```moonbit
// 1. åˆ›å»º Bean
let def = BeanDefinition::new_from_constructor(...)

// 2. å®ä¾‹åŒ–
def.set_instance("bean_instance")

// 3. è°ƒç”¨ init æ–¹æ³•
match def.get_init_method_name() {
  Some(method_name) => {
    println("Calling init method: " + method_name)
    // åå°„è°ƒç”¨ method_name
  }
  None => ()
}

// 4. Bean å¯ç”¨
println("Bean ready: " + def.get_name())

// 5. é”€æ¯æ—¶è°ƒç”¨ destroy æ–¹æ³•
match def.get_destroy_method_name() {
  Some(method_name) => {
    println("Calling destroy method: " + method_name)
    // åå°„è°ƒç”¨ method_name
  }
  None => ()
}
```

## Spring å¯¹æ¯”

| ç‰¹æ€§ | Spring | Moonbit |
|------|--------|---------|
| å•ä¾‹/åŸå‹ | âœ… | âŒ |
| æ‡’åŠ è½½ | âœ… | âŒ |
| ä¾èµ–æ³¨å…¥ | âœ… | ğŸš§ å¾…å®ç° |
| @Primary | âœ… | âœ… |
| @Order | âœ… | âœ… |
| init/destroy | âœ… | âœ… |
| å·¥å‚æ–¹æ³• | âœ… | âœ… |

## æ³¨æ„äº‹é¡¹

1. **Bean åç§°å¿…é¡»å”¯ä¸€**
2. **å£°æ˜ç±»å‹ vs å®é™…ç±»å‹**ï¼šå­˜å‚¨å£°æ˜ç±»å‹
3. **å·¥å‚ Bean ä¹Ÿè¦æ³¨å†Œ**ï¼šå·¥å‚ Bean æœ¬èº«ä¹Ÿæ˜¯ Bean
4. **@Primary å”¯ä¸€æ€§**ï¼šä¸€ä¸ªç±»å‹åªèƒ½æœ‰ä¸€ä¸ª @Primary
5. **å®ä¾‹å»¶è¿Ÿåˆ›å»º**ï¼šBeanDefinition åˆ›å»ºæ—¶ instance ä¸º None

## æµ‹è¯•

```bash
moon check autumn-frame/Autumn-Ioc/BeanDefinition
```

## ç›¸å…³æ–‡æ¡£

- [å®Œæ•´æ–‡æ¡£](README.md)
- [ResourceResolver](../ResourceResolver/README.md)
- [PropertyResolver](../PropertyResolver/README.md)
