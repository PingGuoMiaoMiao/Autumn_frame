/// ApplicationContext - IoC å®¹å™¨æ ¸å¿ƒå®ç°
/// 
/// è¿™ä¸ªæ–‡ä»¶å®ç°äº†åŸºäºç‰¹å¾ç³»ç»Ÿçš„ IoC å®¹å™¨
/// 
/// çœŸæ­£é›†æˆäº†ä»¥ä¸‹ä¸‰ä¸ªæ¨¡å—ï¼š
/// 1. BeanDefinition - Bean å®šä¹‰ç®¡ç†
/// 2. PropertyResolver - é…ç½®å±æ€§è§£æ
/// 3. ResourceResolver - èµ„æºæ‰«æ

// ========== åŸºç¡€ç±»å‹å®šä¹‰ ==========

/// å®¹å™¨çŠ¶æ€
pub enum ContainerStatus {
  NotInitialized
  Initialized
  Error(String) // ç”¨äºé”™è¯¯çŠ¶æ€ï¼Œè™½ç„¶å½“å‰æœªä½¿ç”¨ï¼Œä½†ä¿ç•™ä»¥æ”¯æŒé”™è¯¯å¤„ç†
} derive(Eq, Show)

/// å®¹å™¨é…ç½®
pub struct ContainerConfig {
  auto_scan : Bool
  debug_mode : Bool
  base_package : String
} derive(Eq, Show, Default)

/// Bean åˆ›å»ºå‡½æ•°ç±»å‹ï¼ˆæ”¯æŒä¾èµ–æ³¨å…¥ï¼‰
pub type BeanCreator = (ApplicationContext) -> String  // è¿”å› Bean å®ä¾‹ ID

/// Bean åˆå§‹åŒ–å‡½æ•°ç±»å‹
pub type BeanInitializer = (ApplicationContext, String) -> Unit  // context, instance_id

/// Bean é”€æ¯å‡½æ•°ç±»å‹
pub type BeanDestroyer = (ApplicationContext, String) -> Unit  // context, instance_id

/// Bean å·¥å‚å‡½æ•°ç±»å‹
pub type BeanFactoryFn = (ApplicationContext) -> String  // è¿”å› Bean å®ä¾‹ ID

/// ApplicationContext ä¸»ç»“æ„
/// 
/// çœŸæ­£é›†æˆä¸‰ä¸ªæ¨¡å—ï¼š
/// - PropertyResolverï¼šé…ç½®ç®¡ç†
/// - ResourceResolverï¼šèµ„æºæ‰«æ
/// - BeanDefinitionï¼šBean å®šä¹‰
pub struct ApplicationContext {
  // åŸºæœ¬é…ç½®
  mut config : ContainerConfig
  
  // å®¹å™¨çŠ¶æ€
  mut status : ContainerStatus
  
  // âœ… çœŸæ­£é›†æˆ BeanDefinition æ¨¡å—
  beans : @hashmap.HashMap[String, @BeanDefinition.BeanDefinition]
  
  // âœ… çœŸæ­£é›†æˆ PropertyResolver æ¨¡å—
  property_resolver : @PropertyResolver.PropertyResolver
  
  // âœ… çœŸæ­£é›†æˆ ResourceResolver æ¨¡å—
  resource_resolver : @ResourceResolver.ResourceResolver
  
  // ========== æ–°å¢åŠŸèƒ½ï¼šä¾èµ–æ³¨å…¥ã€ç”Ÿå‘½å‘¨æœŸã€å·¥å‚æ–¹æ³• ==========
  
  // ä¾èµ–å…³ç³»æ³¨å†Œè¡¨ï¼ˆBean åç§° -> ä¾èµ–çš„ Bean åç§°åˆ—è¡¨ï¼‰
  dependencies : @hashmap.HashMap[String, Array[String]]
  
  // Bean åˆ›å»ºå‡½æ•°æ³¨å†Œè¡¨ï¼ˆBean åç§° -> åˆ›å»ºå‡½æ•°ï¼‰
  creators : @hashmap.HashMap[String, BeanCreator]
  
  // Bean åˆå§‹åŒ–å‡½æ•°æ³¨å†Œè¡¨ï¼ˆBean åç§° -> åˆå§‹åŒ–å‡½æ•°ï¼‰
  initializers : @hashmap.HashMap[String, BeanInitializer]
  
  // Bean é”€æ¯å‡½æ•°æ³¨å†Œè¡¨ï¼ˆBean åç§° -> é”€æ¯å‡½æ•°ï¼‰
  destroyers : @hashmap.HashMap[String, BeanDestroyer]
  
  // Bean å·¥å‚å‡½æ•°æ³¨å†Œè¡¨ï¼ˆBean åç§° -> å·¥å‚å‡½æ•°ï¼‰
  factories : @hashmap.HashMap[String, BeanFactoryFn]
  
  // å·²åˆ›å»ºçš„ Bean å®ä¾‹ï¼ˆå®ä¾‹ ID -> Bean åç§°ï¼‰
  instances : @hashmap.HashMap[String, String]
  
  // ========== AOP é›†æˆ ==========
  
  // âœ… é›†æˆ AOP åŠŸèƒ½ï¼ˆä½¿ç”¨å»¶è¿Ÿåˆå§‹åŒ–é¿å…å¾ªç¯ä¾èµ–ï¼‰
  // æ³¨æ„ï¼šaop_integration å­—æ®µç±»å‹ä½¿ç”¨ Any é¿å…å¾ªç¯ä¾èµ–
  // å®é™…ç±»å‹æ˜¯ @AopIntegration.AopIntegrationï¼Œä½†é€šè¿‡ç±»å‹æ“¦é™¤é¿å…ç¼–è¯‘æ—¶ä¾èµ–
  aop_integration_initialized : Bool
}

// æ³¨æ„ï¼šç”±äº PropertyResolver å’Œ ResourceResolver å¯èƒ½æ²¡æœ‰å®ç° Eq å’Œ Showï¼Œ
// æˆ‘ä»¬ä¸åœ¨ ApplicationContext ä¸Š derive è¿™äº›ç‰¹å¾

// ========== æ„é€ å‡½æ•°å’Œæ–¹æ³• ==========

/// åˆ›å»º ApplicationContext
/// 
/// çœŸæ­£é›†æˆä¸‰ä¸ªæ¨¡å—ï¼š
/// 1. åˆ›å»º PropertyResolverï¼ˆä»é…ç½®æ•°ç»„ï¼‰
/// 2. åˆ›å»º ResourceResolverï¼ˆä»åŸºç¡€åŒ…è·¯å¾„ï¼‰
/// 3. åˆå§‹åŒ– Bean å®šä¹‰é›†åˆ
pub fn ApplicationContext::new(config : Array[(String, String)], base_package : String) -> ApplicationContext {
  {
    config: ContainerConfig::{
      auto_scan: true,
      debug_mode: false,
      base_package
    },
    status: NotInitialized,
    beans: @hashmap.new(),
    // âœ… çœŸæ­£é›†æˆ PropertyResolver
    property_resolver: @PropertyResolver.PropertyResolver::from_array(config),
    // âœ… çœŸæ­£é›†æˆ ResourceResolver
    resource_resolver: @ResourceResolver.ResourceResolver::new(base_package),
    // âœ… æ–°å¢åŠŸèƒ½ï¼šåˆå§‹åŒ–ä¾èµ–æ³¨å…¥å’Œç”Ÿå‘½å‘¨æœŸç›¸å…³çš„æ³¨å†Œè¡¨
    dependencies: @hashmap.new(),
    creators: @hashmap.new(),
    initializers: @hashmap.new(),
    destroyers: @hashmap.new(),
    factories: @hashmap.new(),
    instances: @hashmap.new(),
    
    // ========== AOP é›†æˆ ==========
    
    // âœ… AOP é›†æˆå™¨ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼Œé¿å…å¾ªç¯ä¾èµ–ï¼‰
    aop_integration_initialized: false
  }
}

/// æ³¨å†Œ Beanï¼ˆä½¿ç”¨ BeanDefinition æ¨¡å—ï¼‰
/// 
/// ä½¿ç”¨ BeanDefinition æ¨¡å—çš„ BeanDefinition ç±»å‹
pub fn ApplicationContext::register_bean(
  self : ApplicationContext,
  name : String,
  bean_class : String,
  order : Int,
  primary : Bool
) -> Unit {
  // âœ… ä½¿ç”¨ BeanDefinition æ¨¡å—çš„æ–¹æ³•åˆ›å»º BeanDefinition
  let bean_def = @BeanDefinition.BeanDefinition::new_from_constructor(
    name,
    bean_class,
    order,
    primary,
    None,  // init_method
    None   // destroy_method
  )
  self.beans.set(name, bean_def)
}

/// æŸ¥æ‰¾ Beanï¼ˆè¿”å› BeanDefinition æ¨¡å—çš„ç±»å‹ï¼‰
pub fn ApplicationContext::find_bean(self : ApplicationContext, name : String) -> @BeanDefinition.BeanDefinition? {
  self.beans.get(name)
}

/// è·å– Bean æ•°é‡
pub fn ApplicationContext::get_bean_count(self : ApplicationContext) -> Int {
  self.beans.length()
}

/// è·å–æ‰€æœ‰ Bean åç§°
pub fn ApplicationContext::get_all_bean_names(self : ApplicationContext) -> Array[String] {
  let names : Array[String] = []
  self.beans.iter().each(fn(entry) {
    let (name, _) = entry
    names.push(name)
  })
  names
}

/// è®¾ç½®å®¹å™¨çŠ¶æ€
pub fn ApplicationContext::set_status(self : ApplicationContext, status : ContainerStatus) -> Unit {
  self.status = status
}

/// è·å–å®¹å™¨çŠ¶æ€
pub fn ApplicationContext::get_status(self : ApplicationContext) -> ContainerStatus {
  self.status
}

/// æ£€æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
pub fn ApplicationContext::is_initialized(self : ApplicationContext) -> Bool {
  match self.status {
    Initialized => true
    NotInitialized => false
    Error(_) => false  // ä½¿ç”¨ Error å˜ä½“ä»¥é¿å…è­¦å‘Š
  }
}

/// è®¾ç½®é”™è¯¯çŠ¶æ€ï¼ˆç”¨äºé”™è¯¯å¤„ç†ï¼‰
pub fn ApplicationContext::set_error(self : ApplicationContext, error_msg : String) -> Unit {
  self.status = Error(error_msg)  // ä½¿ç”¨ Error å˜ä½“ä»¥é¿å…è­¦å‘Š
}

/// æ‰“å°å®¹å™¨çŠ¶æ€
pub fn ApplicationContext::print_summary(self : ApplicationContext) -> Unit {
  println("=== ApplicationContext çŠ¶æ€ ===")
  println("Bean å®šä¹‰æ•°é‡: \{self.beans.length()}")
  println("å®¹å™¨çŠ¶æ€: \{self.status}")
  
  println("\n--- Bean åˆ—è¡¨ ---")
  self.beans.iter().each(fn(entry) {
    let (name, bean_def) = entry
    // âœ… ä½¿ç”¨ BeanDefinition æ¨¡å—çš„æ–¹æ³•
    println("  \{name}: \{bean_def.get_bean_class()} (order=\{bean_def.get_order()}, primary=\{bean_def.is_primary()})")
  })
}

// ========== å±æ€§ç®¡ç†æ–¹æ³•ï¼ˆçœŸæ­£é›†æˆ PropertyResolverï¼‰ ==========

/// è·å–å±æ€§ï¼ˆçœŸæ­£ä½¿ç”¨ PropertyResolverï¼‰
pub fn ApplicationContext::get_property(self : ApplicationContext, key : String) -> String? {
  // âœ… çœŸæ­£ä½¿ç”¨ PropertyResolver æ¨¡å—
  self.property_resolver.get_property(key)
}

/// è·å–æ•´æ•°å±æ€§ï¼ˆçœŸæ­£ä½¿ç”¨ PropertyResolverï¼‰
pub fn ApplicationContext::get_property_int(self : ApplicationContext, key : String) -> Int? {
  // âœ… çœŸæ­£ä½¿ç”¨ PropertyResolver æ¨¡å—
  self.property_resolver.get_property_int(key)
}

/// è·å–å¸ƒå°”å±æ€§ï¼ˆçœŸæ­£ä½¿ç”¨ PropertyResolverï¼‰
pub fn ApplicationContext::get_property_bool(self : ApplicationContext, key : String) -> Bool? {
  // âœ… çœŸæ­£ä½¿ç”¨ PropertyResolver æ¨¡å—
  self.property_resolver.get_property_bool(key)
}

/// è·å– Double ç±»å‹å±æ€§ï¼ˆçœŸæ­£ä½¿ç”¨ PropertyResolverï¼‰
pub fn ApplicationContext::get_property_double(self : ApplicationContext, key : String) -> Double? {
  // âœ… çœŸæ­£ä½¿ç”¨ PropertyResolver æ¨¡å—
  self.property_resolver.get_property_double(key)
}

// ========== Bean ç®¡ç†æ–¹æ³• ==========

/// åˆ›å»ºæ‰€æœ‰ Bean
pub fn ApplicationContext::create_all_beans(self : ApplicationContext) -> Unit {
  println("åˆ›å»ºæ‰€æœ‰ Bean...")
  // è·å–æ‰€æœ‰ Bean åç§°
  let bean_names = self.get_all_bean_names()
  
  // ç”±äº Moonbit æ•°ç»„æ˜¯ä¸å¯å˜çš„ï¼Œæˆ‘ä»¬ç›´æ¥éå† Bean åç§°
  // å¹¶ä½¿ç”¨è¿­ä»£å™¨æ–¹å¼æŒ‰ order å¤„ç†ï¼ˆç®€åŒ–å®ç°ï¼‰
  // åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œå¯ä»¥é¢„å…ˆæ’åº Bean åç§°
  bean_names.iter().each(fn(name) {
    match self.find_bean(name) {
      Some(bean_def) => {
        // âœ… ä½¿ç”¨ BeanDefinition æ¨¡å—çš„æ–¹æ³•
        println("åˆ›å»º Bean: \{name} (\{bean_def.get_bean_class()})")
        // âœ… å­˜å‚¨å®ä¾‹ IDï¼ˆè¡¨ç¤ºå®ä¾‹å·²åˆ›å»ºï¼‰
        // ç”±äº Moonbit æ²¡æœ‰åå°„ï¼Œæˆ‘ä»¬ä½¿ç”¨å®ä¾‹ ID æ¥è¡¨ç¤ºå®ä¾‹å·²åˆ›å»º
        bean_def.set_instance(name)  // ä½¿ç”¨ Bean åç§°ä½œä¸ºå®ä¾‹ ID
        // âœ… å°†ä¿®æ”¹åçš„ BeanDefinition å­˜å› HashMap
        self.beans.set(name, bean_def)
      }
      None => ()
    }
  })
  self.set_status(Initialized)
}

// ========== ResourceResolver é›†æˆæ–¹æ³• ==========

/// æ‰«æèµ„æºï¼ˆçœŸæ­£ä½¿ç”¨ ResourceResolverï¼‰
/// 
/// ä½¿ç”¨ ResourceResolver æ¨¡å—æ‰«ææŒ‡å®šåŒ…ä¸‹çš„èµ„æºæ–‡ä»¶
pub fn ApplicationContext::scan_resources(self : ApplicationContext) -> @list.List[String] {
  // âœ… çœŸæ­£ä½¿ç”¨ ResourceResolver æ¨¡å—
  // Resource ç±»å‹é€šè¿‡ @ResourceResolver.Resource è®¿é—®
  self.resource_resolver.scan(fn(resource : @ResourceResolver.Resource) {
    // è¿‡æ»¤ .mbt æ–‡ä»¶
    if resource.name.has_suffix(".mbt") {
      Some(resource.name)
    } else {
      None
    }
  })
}

/// æ‰«æå¤šä¸ªè·¯å¾„ï¼ˆçœŸæ­£ä½¿ç”¨ ResourceResolverï¼‰
pub fn ApplicationContext::scan_resources_paths(
  self : ApplicationContext,
  paths : @list.List[String]
) -> @list.List[String] {
  // âœ… çœŸæ­£ä½¿ç”¨ ResourceResolver æ¨¡å—
  // Resource ç±»å‹é€šè¿‡ @ResourceResolver.Resource è®¿é—®
  self.resource_resolver.scan_paths(paths, fn(resource : @ResourceResolver.Resource) {
    if resource.name.has_suffix(".mbt") {
      Some(resource.name)
    } else {
      None
    }
  })
}

// ========== æ–°å¢åŠŸèƒ½ 1ï¼šResourceResolver çš„å®é™…ä½¿ç”¨ï¼ˆè‡ªåŠ¨æ‰«æå’Œæ³¨å†Œï¼‰==========

/// æ‰«æå¹¶è‡ªåŠ¨æ³¨å†Œ Beanï¼ˆResourceResolver çš„å®é™…ä½¿ç”¨ï¼‰
/// 
/// æ‰«ææŒ‡å®šåŒ…ä¸‹çš„æ‰€æœ‰ .mbt æ–‡ä»¶ï¼Œå¹¶æ ¹æ®æ–‡ä»¶å†…å®¹è‡ªåŠ¨æ³¨å†Œ Bean
/// è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„å®ç°ï¼Œå®é™…åº”è¯¥è§£ææ–‡ä»¶å†…å®¹æ¥æŸ¥æ‰¾ @Component ç­‰æ³¨è§£
pub fn ApplicationContext::scan_and_register(self : ApplicationContext) -> @list.List[String] {
  println("ğŸ” å¼€å§‹è‡ªåŠ¨æ‰«æå’Œæ³¨å†Œ Bean...")
  
  // âœ… çœŸæ­£ä½¿ç”¨ ResourceResolver æ‰«æèµ„æº
  let resources = self.scan_resources()
  
  println("ğŸ“ æ‰«æåˆ° \{resources.length()} ä¸ªèµ„æºæ–‡ä»¶")
  
  // éå†æ‰«æåˆ°çš„èµ„æºï¼Œæå– Bean ä¿¡æ¯å¹¶æ³¨å†Œ
  resources.iter().each(fn(resource_name) {
    // ä»æ–‡ä»¶åæå– Bean ä¿¡æ¯ï¼ˆç®€åŒ–å®ç°ï¼‰
    // å®é™…åº”è¯¥è§£ææ–‡ä»¶å†…å®¹ï¼ŒæŸ¥æ‰¾ @Componentã€@Service ç­‰æ³¨è§£
    let bean_name = extract_bean_name_from_resource(resource_name)
    let bean_class = extract_class_name_from_resource(resource_name)
    
    if bean_name != "" && bean_class != "" {
      // è‡ªåŠ¨æ³¨å†Œ Bean
      self.register_bean(
        bean_name,
        bean_class,
        100,  // é»˜è®¤ orderï¼ˆæ‰«æçš„ Bean ä¼˜å…ˆçº§è¾ƒä½ï¼‰
        false  // é»˜è®¤ä¸æ˜¯ primary
      )
      println("  âœ“ è‡ªåŠ¨æ³¨å†Œ Bean: \{bean_name} (\{bean_class})")
    }
  })
  
  println("âœ… è‡ªåŠ¨æ‰«æå’Œæ³¨å†Œå®Œæˆ")
  resources
}

/// ä»èµ„æºæ–‡ä»¶åæå– Bean åç§°ï¼ˆç®€åŒ–å®ç°ï¼‰
fn extract_bean_name_from_resource(resource_name : String) -> String {
  // ä¾‹å¦‚ï¼šcom/example/UserService.mbt -> userService
  // å®é™…åº”è¯¥è§£ææ–‡ä»¶å†…å®¹
  // ç®€åŒ–å®ç°ï¼šä»æ–‡ä»¶åæå–ç±»å
  // æ‰¾åˆ°æœ€åä¸€ä¸ªæ–œæ çš„ä½ç½®
  let mut last_slash_idx = -1
  for i = 0; i < resource_name.length(); i = i + 1 {
    if resource_name[i].unsafe_to_char() == '/' {
      last_slash_idx = i
    }
  }
  
  let filename = if last_slash_idx >= 0 && last_slash_idx + 1 < resource_name.length() {
    try {
      resource_name[last_slash_idx + 1:].to_string()
    } catch {
      _ => resource_name
    }
  } else {
    resource_name
  }
  
  if filename.has_suffix(".mbt") {
    let filename_len = filename.length()
    if filename_len > 4 {
      try {
        filename[0:filename_len - 4].to_string()
      } catch {
        _ => ""
      }
    } else {
      ""
    }
  } else {
    ""
  }
}

/// ä»èµ„æºæ–‡ä»¶åæå–ç±»åï¼ˆç®€åŒ–å®ç°ï¼‰
fn extract_class_name_from_resource(resource_name : String) -> String {
  // ä¾‹å¦‚ï¼šcom/example/UserService.mbt -> com.example.UserService
  // ç®€åŒ–å®ç°ï¼šå°†è·¯å¾„ä¸­çš„ / æ›¿æ¢ä¸º .
  let normalized = resource_name.replace(old="/", new=".")
  
  if normalized.has_suffix(".mbt") {
    let normalized_len = normalized.length()
    if normalized_len > 4 {
      try {
        normalized[0:normalized_len - 4].to_string()
      } catch {
        _ => ""
      }
    } else {
      ""
    }
  } else {
    ""
  }
}

// ========== æ–°å¢åŠŸèƒ½ 2ï¼šä¾èµ–æ³¨å…¥ï¼ˆ@Autowiredï¼‰==========

/// æ³¨å†Œ Bean çš„ä¾èµ–å…³ç³»ï¼ˆ@Autowired çš„æ˜¾å¼ç‰ˆæœ¬ï¼‰
pub fn ApplicationContext::register_dependency(
  self : ApplicationContext,
  bean_name : String,
  depends_on : Array[String]
) -> Unit {
  self.dependencies.set(bean_name, depends_on)
  if self.config.debug_mode {
    println("ğŸ“ æ³¨å†Œä¾èµ–: \{bean_name} ä¾èµ– \{depends_on.length()} ä¸ª Bean")
  }
}

/// æ³¨å†Œ Bean åˆ›å»ºå‡½æ•°ï¼ˆæ”¯æŒä¾èµ–æ³¨å…¥ï¼‰
pub fn ApplicationContext::register_bean_creator(
  self : ApplicationContext,
  bean_name : String,
  creator : BeanCreator
) -> Unit {
  self.creators.set(bean_name, creator)
}

/// åˆ›å»º Beanï¼ˆæ”¯æŒä¾èµ–æ³¨å…¥ï¼‰
pub fn ApplicationContext::create_bean_with_dependencies(
  self : ApplicationContext,
  bean_name : String
) -> String? {
  // æ£€æŸ¥æ˜¯å¦å·²åˆ›å»º
  match self.find_bean(bean_name) {
    Some(bean_def) => {
      if bean_def.has_instance() {
        // å·²åˆ›å»ºï¼Œè¿”å›ç°æœ‰å®ä¾‹ IDï¼ˆé¿å…é‡å¤åˆ›å»ºï¼‰
        match bean_def.get_instance() {
          @BeanDefinition.Instance(id) => {
            println("  â„¹ï¸  Bean \{bean_name} å·²åˆ›å»ºï¼Œè·³è¿‡ï¼ˆå®ä¾‹ ID: \{id}ï¼‰")
            Some(id)
          }
          None => None
        }
      } else {
        // 1. å…ˆåˆ›å»ºä¾èµ–çš„ Beanï¼ˆçœŸå®çš„ä¾èµ–æ³¨å…¥ï¼ï¼‰
        match self.dependencies.get(bean_name) {
          Some(deps) => {
            if deps.length() > 0 {
              // æ„å»ºä¾èµ–åˆ—è¡¨å­—ç¬¦ä¸²
              let mut deps_str = ""
              let mut is_first = true
              deps.iter().each(fn(dep_name) {
                if is_first {
                  deps_str = dep_name
                  is_first = false
                } else {
                  deps_str = deps_str + ", " + dep_name
                }
              })
              println("  ğŸ“¦ \{bean_name} ä¾èµ– \{deps.length()} ä¸ª Bean: [\{deps_str}]")
              println("  ğŸ”„ å¼€å§‹åˆ›å»ºä¾èµ–...")
            }
            deps.iter().each(fn(dep_name) {
              println("    â†’ é€’å½’åˆ›å»ºä¾èµ– Bean: \{dep_name}")
              // é€’å½’åˆ›å»ºä¾èµ–ï¼ˆçœŸå®çš„ä¾èµ–æ³¨å…¥ï¼ï¼‰
              match self.create_bean_with_dependencies(dep_name) {
                Some(instance_id) => {
                  println("    âœ“ ä¾èµ– Bean \{dep_name} åˆ›å»ºæˆåŠŸï¼ˆå®ä¾‹ ID: \{instance_id}ï¼‰")
                }
                None => {
                  println("    âŒ ä¾èµ– Bean \{dep_name} åˆ›å»ºå¤±è´¥")
                }
              }
            })
            if deps.length() > 0 {
              println("  âœ“ æ‰€æœ‰ä¾èµ–åˆ›å»ºå®Œæˆ")
            }
          }
          None => ()
        }
        
        // 2. è°ƒç”¨åˆ›å»ºå‡½æ•°ï¼ˆçœŸå®çš„å®ä¾‹åˆ›å»ºï¼ï¼‰
        match self.creators.get(bean_name) {
          Some(creator) => {
            println("  ğŸ­ è°ƒç”¨åˆ›å»ºå‡½æ•°åˆ›å»º Bean: \{bean_name}")
            let instance_id = creator(self)
            
            // 3. è®¾ç½®å®ä¾‹ï¼ˆçœŸå®çš„å®ä¾‹å­˜å‚¨ï¼ï¼‰
            match self.find_bean(bean_name) {
              Some(def) => {
                def.set_instance(instance_id)
                self.instances.set(instance_id, bean_name)
                self.beans.set(bean_name, def)
                println("  ğŸ’¾ å­˜å‚¨ Bean å®ä¾‹: \{bean_name} -> \{instance_id}")
                
                // 4. è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•ï¼ˆçœŸå®çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒï¼ï¼‰
                println("  ğŸ”§ å‡†å¤‡è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•...")
                self.call_init_method(bean_name, instance_id)
                
                println("  âœ… Bean \{bean_name} åˆ›å»ºæˆåŠŸï¼ˆå®ä¾‹ ID: \{instance_id}ï¼‰")
                Some(instance_id)
              }
              None => {
                println("  âŒ Bean å®šä¹‰ä¸å­˜åœ¨: \{bean_name}")
                None
              }
            }
          }
          None => {
            // å¦‚æœæ²¡æœ‰æ³¨å†Œåˆ›å»ºå‡½æ•°ï¼Œä½¿ç”¨é»˜è®¤æ–¹å¼
            println("  âš ï¸  Bean åˆ›å»ºå‡½æ•°ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤æ–¹å¼: \{bean_name}")
            bean_def.set_instance(bean_name)
            self.instances.set(bean_name, bean_name)
            self.beans.set(bean_name, bean_def)
            self.call_init_method(bean_name, bean_name)
            Some(bean_name)
          }
        }
      }
    }
    None => {
      println("  âŒ Bean ä¸å­˜åœ¨: \{bean_name}")
      None
    }
  }
}

// ========== æ–°å¢åŠŸèƒ½ 3ï¼šåˆå§‹åŒ–å’Œé”€æ¯æ–¹æ³•è°ƒç”¨ ==========

/// æ³¨å†Œ Bean åˆå§‹åŒ–å‡½æ•°
pub fn ApplicationContext::register_init_method(
  self : ApplicationContext,
  bean_name : String,
  init_fn : BeanInitializer
) -> Unit {
  self.initializers.set(bean_name, init_fn)
}

/// æ³¨å†Œ Bean é”€æ¯å‡½æ•°
pub fn ApplicationContext::register_destroy_method(
  self : ApplicationContext,
  bean_name : String,
  destroy_fn : BeanDestroyer
) -> Unit {
  self.destroyers.set(bean_name, destroy_fn)
}

/// è°ƒç”¨ Bean åˆå§‹åŒ–æ–¹æ³•
pub fn ApplicationContext::call_init_method(
  self : ApplicationContext,
  bean_name : String,
  instance_id : String
) -> Unit {
  // 1. æ£€æŸ¥ BeanDefinition ä¸­çš„ init_method_name
  match self.find_bean(bean_name) {
    Some(bean_def) => {
      match bean_def.get_init_method_name() {
        Some(init_method_name) => {
          if self.config.debug_mode {
            println("  ğŸ”§ è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•: \{bean_name}.\{init_method_name}()")
          }
          // å®é™…åº”è¯¥é€šè¿‡å‡½æ•°æ³¨å†Œè¡¨è°ƒç”¨
          match self.initializers.get(bean_name) {
            Some(init_fn) => init_fn(self, instance_id)
            None => {
              if self.config.debug_mode {
                println("    âš ï¸  åˆå§‹åŒ–å‡½æ•°æœªæ³¨å†Œ: \{bean_name}")
              }
            }
          }
        }
        None => ()
      }
      
      // 2. è°ƒç”¨æ³¨å†Œçš„åˆå§‹åŒ–å‡½æ•°ï¼ˆå³ä½¿æ²¡æœ‰ init_method_nameï¼‰
      match self.initializers.get(bean_name) {
        Some(init_fn) => init_fn(self, instance_id)
        None => ()
      }
    }
    None => ()
  }
}

/// è°ƒç”¨ Bean é”€æ¯æ–¹æ³•
pub fn ApplicationContext::call_destroy_method(
  self : ApplicationContext,
  bean_name : String,
  instance_id : String
) -> Unit {
  match self.find_bean(bean_name) {
    Some(bean_def) => {
      match bean_def.get_destroy_method_name() {
        Some(destroy_method_name) => {
          if self.config.debug_mode {
            println("  ğŸ—‘ï¸  è°ƒç”¨é”€æ¯æ–¹æ³•: \{bean_name}.\{destroy_method_name}()")
          }
          match self.destroyers.get(bean_name) {
            Some(destroy_fn) => destroy_fn(self, instance_id)
            None => {
              if self.config.debug_mode {
                println("    âš ï¸  é”€æ¯å‡½æ•°æœªæ³¨å†Œ: \{bean_name}")
              }
            }
          }
        }
        None => ()
      }
      
      // è°ƒç”¨æ³¨å†Œçš„é”€æ¯å‡½æ•°
      match self.destroyers.get(bean_name) {
        Some(destroy_fn) => destroy_fn(self, instance_id)
        None => ()
      }
    }
    None => ()
  }
}

/// é”€æ¯æ‰€æœ‰ Beanï¼ˆè°ƒç”¨æ‰€æœ‰ destroy æ–¹æ³•ï¼‰
pub fn ApplicationContext::destroy_all_beans(self : ApplicationContext) -> Unit {
  println("ğŸ—‘ï¸  å¼€å§‹é”€æ¯æ‰€æœ‰ Bean...")
  
  // è·å–æ‰€æœ‰å·²åˆ›å»ºçš„ Bean å®ä¾‹
  self.instances.iter().each(fn(entry) {
    let (instance_id, bean_name) = entry
    self.call_destroy_method(bean_name, instance_id)
  })
  
  println("âœ… Bean é”€æ¯å®Œæˆ")
}

// ========== æ–°å¢åŠŸèƒ½ 4ï¼šå·¥å‚æ–¹æ³•åˆ›å»º Bean ==========

/// æ³¨å†Œ Bean å·¥å‚å‡½æ•°
pub fn ApplicationContext::register_factory_method(
  self : ApplicationContext,
  bean_name : String,
  factory_bean_name : String,
  factory_fn : BeanFactoryFn
) -> Unit {
  self.factories.set(bean_name, factory_fn)
  
  // æ³¨å†Œä¸ºå·¥å‚æ–¹æ³•åˆ›å»ºçš„ BeanDefinition
  match self.find_bean(bean_name) {
    Some(_) => {
      // Bean å·²å­˜åœ¨ï¼Œæ›´æ–°ä¸ºå·¥å‚æ–¹æ³•åˆ›å»º
      let _ = ()  // æ˜¾å¼å¿½ç•¥
    }
    None => {
      // åˆ›å»ºæ–°çš„ BeanDefinitionï¼ˆå·¥å‚æ–¹æ³•ï¼‰
      let bean_def = @BeanDefinition.BeanDefinition::new_from_factory(
        bean_name,
        "",  // bean_classï¼ˆå¯ä»¥åç»­è®¾ç½®ï¼‰
        factory_bean_name,
        "create_" + bean_name,  // å·¥å‚æ–¹æ³•åç§°
        0,
        false,
        None,
        None
      )
      self.beans.set(bean_name, bean_def)
    }
  }
  
  if self.config.debug_mode {
    println("ğŸ­ æ³¨å†Œå·¥å‚æ–¹æ³•: \{bean_name} (å·¥å‚ Bean: \{factory_bean_name})")
  }
}

/// é€šè¿‡å·¥å‚æ–¹æ³•åˆ›å»º Bean
pub fn ApplicationContext::create_bean_from_factory(
  self : ApplicationContext,
  bean_name : String
) -> String? {
  match self.find_bean(bean_name) {
    Some(bean_def) => {
      if bean_def.is_factory_creation() {
        match self.factories.get(bean_name) {
          Some(factory_fn) => {
            println("  ğŸ­ é€šè¿‡å·¥å‚æ–¹æ³•åˆ›å»º Bean: \{bean_name}")
            
            // 1. å…ˆç¡®ä¿å·¥å‚ Bean å·²åˆ›å»º
            match bean_def.get_factory_bean_name() {
              Some(factory_bean_name) => {
                println("  ğŸ“¦ æ£€æŸ¥å·¥å‚ Bean: \{factory_bean_name}")
                // é€’å½’åˆ›å»ºå·¥å‚ Beanï¼ˆå¦‚æœéœ€è¦ï¼‰
                match self.find_bean(factory_bean_name) {
                  Some(factory_bean_def) => {
                    if factory_bean_def.has_instance() {
                      println("  âœ“ å·¥å‚ Bean \{factory_bean_name} å·²å­˜åœ¨")
                    } else {
                      println("  âš ï¸  å·¥å‚ Bean \{factory_bean_name} æœªåˆ›å»ºï¼Œå…ˆåˆ›å»ºå®ƒ...")
                      // å…ˆåˆ›å»ºå·¥å‚ Bean
                      let _ = self.create_bean_with_dependencies(factory_bean_name)
                    }
                  }
                  None => {
                    println("  âš ï¸  å·¥å‚ Bean ä¸å­˜åœ¨: \{factory_bean_name}")
                  }
                }
              }
              None => ()
            }
            
            // 2. è°ƒç”¨å·¥å‚å‡½æ•°ï¼ˆçœŸå®çš„å·¥å‚æ–¹æ³•è°ƒç”¨ï¼ï¼‰
            println("  ğŸ”§ è°ƒç”¨å·¥å‚å‡½æ•°...")
            let instance_id = factory_fn(self)
            
            // 3. è®¾ç½®å®ä¾‹ï¼ˆçœŸå®çš„å®ä¾‹å­˜å‚¨ï¼ï¼‰
            bean_def.set_instance(instance_id)
            self.instances.set(instance_id, bean_name)
            self.beans.set(bean_name, bean_def)
            println("  ğŸ’¾ å­˜å‚¨ Bean å®ä¾‹: \{bean_name} -> \{instance_id}")
            
            // 4. è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•ï¼ˆçœŸå®çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒï¼ï¼‰
            println("  ğŸ”§ å‡†å¤‡è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•...")
            self.call_init_method(bean_name, instance_id)
            
            println("  âœ… é€šè¿‡å·¥å‚æ–¹æ³•åˆ›å»º Bean æˆåŠŸ: \{bean_name} (å®ä¾‹ ID: \{instance_id})")
            Some(instance_id)
          }
          None => {
            println("  âŒ å·¥å‚å‡½æ•°ä¸å­˜åœ¨: \{bean_name}")
            None
          }
        }
      } else {
        println("  âŒ Bean ä¸æ˜¯å·¥å‚æ–¹æ³•åˆ›å»º: \{bean_name}")
        None
      }
    }
    None => {
      println("  âŒ Bean ä¸å­˜åœ¨: \{bean_name}")
      None
    }
  }
}

/// åˆ›å»ºæ‰€æœ‰ Beanï¼ˆå¢å¼ºç‰ˆï¼Œæ”¯æŒä¾èµ–æ³¨å…¥ã€ç”Ÿå‘½å‘¨æœŸã€å·¥å‚æ–¹æ³•ï¼‰
pub fn ApplicationContext::create_all_beans_enhanced(self : ApplicationContext) -> Unit {
  println("ğŸš€ å¼€å§‹åˆ›å»ºæ‰€æœ‰ Beanï¼ˆå¢å¼ºç‰ˆï¼‰...")
  println("")
  
  // è·å–æ‰€æœ‰ Bean åç§°
  let bean_names = self.get_all_bean_names()
  println("ğŸ“‹ éœ€è¦åˆ›å»ºçš„ Bean æ•°é‡: \{bean_names.length()}")
  println("")
  
  // æŒ‰ order æ’åºï¼ˆç®€åŒ–å®ç°ï¼Œç›´æ¥éå†ï¼‰
  bean_names.iter().each(fn(bean_name) {
    println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
    println("å¤„ç† Bean: \{bean_name}")
    match self.find_bean(bean_name) {
      Some(bean_def) => {
        if bean_def.is_factory_creation() {
          // å·¥å‚æ–¹æ³•åˆ›å»º
          println("  ğŸ“Œ ç±»å‹: å·¥å‚æ–¹æ³•åˆ›å»º")
          let _ = self.create_bean_from_factory(bean_name)
        } else {
          // æ™®é€šåˆ›å»ºï¼ˆæ”¯æŒä¾èµ–æ³¨å…¥ï¼‰
          println("  ğŸ“Œ ç±»å‹: æ„é€ å‡½æ•°åˆ›å»º")
          match self.creators.get(bean_name) {
            Some(_) => {
              println("  ğŸ“Œ æ–¹å¼: ä½¿ç”¨æ³¨å†Œçš„åˆ›å»ºå‡½æ•°ï¼ˆæ”¯æŒä¾èµ–æ³¨å…¥ï¼‰")
              let _ = self.create_bean_with_dependencies(bean_name)
            }
            None => {
              // å¦‚æœæ²¡æœ‰æ³¨å†Œåˆ›å»ºå‡½æ•°ï¼Œä½¿ç”¨é»˜è®¤æ–¹å¼
              println("  ğŸ“Œ æ–¹å¼: ä½¿ç”¨é»˜è®¤æ–¹å¼ï¼ˆæ— ä¾èµ–æ³¨å…¥ï¼‰")
              println("  åˆ›å»º Bean: \{bean_name} (\{bean_def.get_bean_class()})")
              bean_def.set_instance(bean_name)
              self.instances.set(bean_name, bean_name)
              self.beans.set(bean_name, bean_def)
              self.call_init_method(bean_name, bean_name)
            }
          }
        }
      }
      None => {
        println("  âŒ Bean å®šä¹‰ä¸å­˜åœ¨")
      }
    }
    println("")
  })
  
  self.set_status(Initialized)
  println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
  println("âœ… æ‰€æœ‰ Bean åˆ›å»ºå®Œæˆ")
}

// ========== ç‰¹å¾å®šä¹‰ ==========

/// IoC å®¹å™¨æ ¸å¿ƒç‰¹å¾
pub trait IoCContainer {
  register_bean(Self, String, String, Int, Bool) -> Unit
  find_bean(Self, String) -> @BeanDefinition.BeanDefinition?
  get_bean_count(Self) -> Int
  get_all_bean_names(Self) -> Array[String]
}

/// å®¹å™¨çŠ¶æ€ç®¡ç†ç‰¹å¾
pub trait ContainerStatusManager {
  set_status(Self, ContainerStatus) -> Unit
  get_status(Self) -> ContainerStatus
  is_initialized(Self) -> Bool
}

/// å®¹å™¨é…ç½®ç‰¹å¾
pub trait ContainerConfiguration {
  get_config(Self) -> ContainerConfig
  set_config(Self, ContainerConfig) -> Unit
  is_debug_mode(Self) -> Bool
}

// ========== ç‰¹å¾å®ç° ==========

/// å®ç° IoCContainer ç‰¹å¾
pub impl IoCContainer for ApplicationContext with register_bean(self, name, bean_class, order, primary) {
  // âœ… ä½¿ç”¨ BeanDefinition æ¨¡å—çš„æ–¹æ³•
  let bean_def = @BeanDefinition.BeanDefinition::new_from_constructor(
    name,
    bean_class,
    order,
    primary,
    None,
    None
  )
  self.beans.set(name, bean_def)
}

pub impl IoCContainer for ApplicationContext with find_bean(self, name) {
  self.beans.get(name)
}

pub impl IoCContainer for ApplicationContext with get_bean_count(self) {
  self.beans.length()
}

pub impl IoCContainer for ApplicationContext with get_all_bean_names(self) {
  let names : Array[String] = []
  self.beans.iter().each(fn(entry) {
    let (name, _) = entry
    names.push(name)
  })
  names
}

/// å®ç° ContainerStatusManager ç‰¹å¾
pub impl ContainerStatusManager for ApplicationContext with set_status(self, status) {
  self.status = status
}

pub impl ContainerStatusManager for ApplicationContext with get_status(self) {
  self.status
}

pub impl ContainerStatusManager for ApplicationContext with is_initialized(self) {
  match self.status {
    Initialized => true
    _ => false
  }
}

/// å®ç° ContainerConfiguration ç‰¹å¾
pub impl ContainerConfiguration for ApplicationContext with get_config(self) {
  self.config
}

pub impl ContainerConfiguration for ApplicationContext with set_config(self, config) {
  self.config = config
}

pub impl ContainerConfiguration for ApplicationContext with is_debug_mode(self) {
  self.config.debug_mode
}

// ========== AOP é›†æˆæ–¹æ³• ==========
// 
// æ³¨æ„ï¼šAOP é›†æˆåŠŸèƒ½æš‚æ—¶ç§»é™¤ï¼Œé¿å…å¾ªç¯ä¾èµ–
// AOP åŠŸèƒ½å·²ç‹¬ç«‹å®ç°ï¼Œå¯ä»¥é€šè¿‡å¤–éƒ¨æ–¹å¼é›†æˆ
// 
// å¦‚æœéœ€è¦ä½¿ç”¨ AOPï¼Œå¯ä»¥ï¼š
// 1. åœ¨åº”ç”¨å±‚åˆ›å»º AopIntegration å®ä¾‹
// 2. æ‰‹åŠ¨ä¸ºéœ€è¦çš„ Bean åˆ›å»ºä»£ç†
// 3. é€šè¿‡ ApplicationContext çš„æ–¹æ³•è·å– Beanï¼Œç„¶ååº”ç”¨ AOP

// ========== æµ‹è¯• ==========

test "ApplicationContext åŸºæœ¬åŠŸèƒ½" {
  let config : Array[(String, String)] = []
  let ctx = ApplicationContext::new(config, "com.example")
  
  // æµ‹è¯•æ³¨å†Œ Bean
  ctx.register_bean("userService", "com.example.UserService", 10, false)
  ctx.register_bean("orderService", "com.example.OrderService", 20, true)
  
  // æµ‹è¯•æŸ¥æ‰¾ Beanï¼ˆä½¿ç”¨ BeanDefinition æ¨¡å—çš„æ–¹æ³•ï¼‰
  match ctx.find_bean("userService") {
    Some(bean_def) => {
      if bean_def.get_name() != "userService" { abort("bean name mismatch") }
      if bean_def.get_bean_class() != "com.example.UserService" { abort("bean class mismatch") }
      if bean_def.get_order() != 10 { abort("bean order mismatch") }
      if bean_def.is_primary() { abort("bean should not be primary") }
    }
    None => abort("bean not found")
  }
  
  // æµ‹è¯• Bean æ•°é‡
  if ctx.get_bean_count() != 2 { abort("bean count mismatch") }
  
  // æµ‹è¯•çŠ¶æ€ç®¡ç†
  ctx.set_status(Initialized)
  if not(ctx.is_initialized()) { abort("should be initialized") }
}

test "ApplicationContext ç‰¹å¾ä½¿ç”¨" {
  let config : Array[(String, String)] = []
  let ctx = ApplicationContext::new(config, "com.example")
  
  // ä½¿ç”¨ IoCContainer ç‰¹å¾
  ctx.register_bean("testBean", "com.example.TestBean", 0, false)
  
  // ä½¿ç”¨ ContainerStatusManager ç‰¹å¾
  ctx.set_status(Initialized)
  
  // ä½¿ç”¨ ContainerConfiguration ç‰¹å¾
  if not(ctx.is_debug_mode()) { abort("should not be debug mode") }
  
  // éªŒè¯ç»“æœ
  match ctx.find_bean("testBean") {
    Some(_) => ()
    None => abort("bean not found")
  }
}
