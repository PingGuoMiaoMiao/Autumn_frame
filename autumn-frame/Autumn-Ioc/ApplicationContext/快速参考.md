# ApplicationContext 快速参考

## 5 分钟快速上手

### 1. 基本使用

```moonbit
// 创建容器
let config = [("app.name", "MyApp"), ("db.port", "3306")]
let ctx = @ApplicationContext.ApplicationContext::new(config, "com.example")

// 获取配置
ctx.get_property("app.name")      // Some("MyApp")
ctx.get_property_int("db.port")   // Some(3306)

// 注册 Bean
ctx.register_bean("userService", "com.example.UserService", 1, false)

// 创建 Bean
ctx.create_bean("userService")

// 查找 Bean
match ctx.find_bean("userService") {
  Some(def) => println("找到: \{def.get_name()}")
  None => ()
}
```

### 2. 完整流程

```moonbit
fn main {
  // 1. 准备配置
  let config = [
    ("app.name", "MyApp"),
    ("db.host", "localhost"),
    ("db.port", "3306")
  ]
  
  // 2. 创建容器
  let ctx = @ApplicationContext.ApplicationContext::new(config, "com.example")
  
  // 3. 注册 Bean（按依赖顺序）
  ctx.register_bean("dataSource", "com.example.DataSource", 10, true)
  ctx.register_bean("userService", "com.example.UserService", 20, false)
  ctx.register_bean("userController", "com.example.UserController", 30, false)
  
  // 4. 创建所有 Bean（自动排序）
  ctx.create_all_beans()
  
  // 5. 查看状态
  ctx.print_summary()
}
```

## 常用 API

### 容器创建

```moonbit
ApplicationContext::new(
  config_properties : Array[(String, String)],
  base_package : String
) -> ApplicationContext
```

### Bean 管理

```moonbit
// 注册
ctx.register_bean(name, bean_class, order, primary)

// 查找
ctx.find_bean(name) -> BeanDefinition?

// 创建
ctx.create_bean(name) -> Bool
ctx.create_all_beans()  // 按 order 排序创建
```

### 配置访问

```moonbit
ctx.get_property(key) -> String?
ctx.get_property_int(key) -> Int?
ctx.get_property_bool(key) -> Bool?
```

### 容器信息

```moonbit
ctx.print_summary()  // 打印容器状态
```

## Bean Order 说明

数值越小，创建越早：

```moonbit
ctx.register_bean("db", "...", 10, false)    // 第一个
ctx.register_bean("service", "...", 20, false) // 第二个
ctx.register_bean("controller", "...", 30, false) // 第三个
```

## @Primary 用法

当有多个相同类型的 Bean 时，标记 primary：

```moonbit
ctx.register_bean("mainDB", "DataSource", 10, true)   // Primary
ctx.register_bean("cacheDB", "DataSource", 10, false) // 普通
```

## 完整示例

参考 `integration-demo/main.mbt` 查看完整的端到端示例。

运行：

```bash
moon run integration-demo
```

## 配置文件

`moon.pkg.json`:

```json
{
  "is-main": true,
  "import": [
    {
      "path": "username/Autumn_frame/autumn-frame/Autumn-Ioc/ApplicationContext",
      "alias": "ApplicationContext"
    }
  ]
}
```

## 三模块集成

ApplicationContext 集成了：

1. **PropertyResolver** - 配置管理
   ```moonbit
   ctx.get_property("key")  // 内部调用 property_resolver
   ```

2. **ResourceResolver** - 资源扫描
   ```moonbit
   // 创建时传入 base_package
   ApplicationContext::new(config, "com.example")
   ```

3. **BeanDefinition** - Bean 定义
   ```moonbit
   ctx.register_bean(...)  // 创建 BeanDefinition
   ctx.find_bean(...)      // 查询 BeanDefinition
   ```

## 实用技巧

### 1. 批量注册 Bean

```moonbit
let services = [
  ("userService", "com.example.UserService", 20),
  ("orderService", "com.example.OrderService", 20),
  ("productService", "com.example.ProductService", 20)
]

for i = 0; i < services.length(); i = i + 1 {
  let (name, class, order) = services[i]
  ctx.register_bean(name, class, order, false)
}
```

### 2. 条件注册

```moonbit
match ctx.get_property("feature.enabled") {
  Some("true") => {
    ctx.register_bean("featureService", "...", 30, false)
  }
  _ => ()
}
```

### 3. 验证 Bean 是否创建

```moonbit
fn check_bean(ctx : ApplicationContext, name : String) -> Bool {
  match ctx.find_bean(name) {
    Some(def) => def.has_instance()
    None => false
  }
}

if check_bean(ctx, "userService") {
  println("userService 已准备就绪")
}
```

## 常见问题

**Q: 如何实现依赖注入？**  
A: 当前版本需要手动管理依赖，未来版本会支持 @Autowired。

**Q: Bean 的创建顺序重要吗？**  
A: 是的！使用 order 字段确保依赖的 Bean 先创建。

**Q: 如何获取 Bean 实例？**  
A: 当前版本 Bean 实例用字符串标识符模拟，实际使用需要等待反射支持。

**Q: 支持工厂方法吗？**  
A: BeanDefinition 支持工厂方法定义，但 ApplicationContext 暂未实现。

## 相关文档

- [完整文档](README.md)
- [集成报告](集成完成报告.md)
- [集成示例](../../../integration-demo/main.mbt)

---

**更新**: 2025-10-12
