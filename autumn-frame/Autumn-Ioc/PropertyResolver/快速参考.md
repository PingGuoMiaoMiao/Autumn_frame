# PropertyResolver 快速参考

## 快速开始

```moonbit
// 1. 创建 PropertyResolver
let resolver = PropertyResolver::from_array([
  ("app.name", "MyApp"),
  ("server.port", "8080"),
  ("debug", "true")
])

// 2. 查询配置
let name = resolver.get_property("app.name")            // Some("MyApp")
let port = resolver.get_property_int("server.port")    // Some(8080)
let debug = resolver.get_property_bool("debug")        // Some(true)
```

## 查询方式

### 1. 普通查询
```moonbit
resolver.get_property("app.name")  // Some("MyApp") 或 None
```

### 2. ${key} 查询
```moonbit
resolver.get_property("${app.name}")  // Some("MyApp")
```

### 3. ${key:default} 带默认值
```moonbit
resolver.get_property("${app.missing:Default}")  // Some("Default")
```

### 4. 嵌套查询
```moonbit
// 配置: app.title = "${APP_NAME}"
//      APP_NAME = "Production"
resolver.get_property("app.title")  // Some("Production")
```

## 类型转换

```moonbit
// String (默认)
resolver.get_property("key") -> String?

// Int
resolver.get_property_int("server.port") -> Int?

// Bool
resolver.get_property_bool("debug") -> Bool?

// Double
resolver.get_property_double("ratio") -> Double?

// 带默认值
resolver.get_property_or_default("key", "default") -> String
```

## 常用方法

| 方法 | 说明 | 返回值 |
|------|------|--------|
| `get_property(key)` | 获取属性值 | `String?` |
| `get_property_int(key)` | 获取 Int 属性 | `Int?` |
| `get_property_bool(key)` | 获取 Bool 属性 | `Bool?` |
| `get_property_double(key)` | 获取 Double 属性 | `Double?` |
| `get_property_or_default(key, default)` | 获取属性或返回默认值 | `String` |
| `contains_property(key)` | 检查属性是否存在 | `Bool` |
| `set_property(key, value)` | 设置属性 | `Unit` |
| `get_property_names()` | 获取所有属性名 | `Array[String]` |

## Bool 值映射

| 字符串值 | Bool 值 |
|---------|---------|
| "true", "True", "TRUE", "1", "yes" | `true` |
| "false", "False", "FALSE", "0", "no" | `false` |
| 其他 | 转换错误（返回 None） |

## 错误处理

```moonbit
// 方式 1: 使用 match
match resolver.get_property("key") {
  Some(v) => println(v)
  None => println("未找到")
}

// 方式 2: 使用 or
let value = resolver.get_property_int("port").or(8080)

// 方式 3: 使用默认值方法
let name = resolver.get_property_or_default("app.name", "DefaultApp")
```

## 典型用例

### 数据库配置
```moonbit
let db_config = PropertyResolver::from_array([
  ("DB_HOST", "localhost"),
  ("DB_PORT", "5432"),
  ("db.url", "postgresql://${DB_HOST}:${DB_PORT}/mydb"),
  ("db.pool.size", "10")
])

let url = db_config.get_property("db.url")
let pool_size = db_config.get_property_int("db.pool.size")
```

### 应用配置
```moonbit
let app_config = PropertyResolver::from_array([
  ("app.name", "MyApp"),
  ("app.version", "1.0"),
  ("app.debug", "false"),
  ("app.max.connections", "100")
])

struct AppSettings {
  name : String
  version : String
  debug : Bool
  max_connections : Int
}

fn load_settings(config : PropertyResolver) -> AppSettings {
  {
    name: config.get_property_or_default("app.name", "App"),
    version: config.get_property_or_default("app.version", "1.0"),
    debug: config.get_property_bool("app.debug").or(false),
    max_connections: config.get_property_int("app.max.connections").or(100)
  }
}
```

### 环境差异配置
```moonbit
let config = PropertyResolver::from_array([
  ("ENV", "production"),
  ("app.url", "${${ENV}.url:http://localhost}"),
  ("production.url", "https://example.com"),
  ("development.url", "http://localhost:3000")
])

// 根据环境自动选择
let url = config.get_property("app.url")
```

## 注意事项

1. **不支持组合表达式**：`"${HOST}:${PORT}"` 需要分别解析
2. **不支持 #{...} 表达式**：SpEL 表达式不支持
3. **类型转换失败返回 None**：需要处理转换失败的情况
4. **嵌套深度**：理论上无限，但过深可能导致性能问题

## 测试示例

```moonbit
test "PropertyResolver 基本功能" {
  let resolver = PropertyResolver::from_array([
    ("key1", "value1"),
    ("port", "8080"),
    ("debug", "true")
  ])
  
  // 断言
  match resolver.get_property("key1") {
    Some(v) => if v != "value1" { abort("test failed") }
    None => abort("key1 not found")
  }
  
  match resolver.get_property_int("port") {
    Some(p) => if p != 8080 { abort("port conversion failed") }
    None => abort("port not found")
  }
}
```

## 性能提示

1. **避免过深的嵌套**：每层嵌套都会触发一次查询
2. **缓存常用值**：频繁访问的配置可以缓存
3. **批量设置**：初始化时一次性设置所有配置

```moonbit
// ❌ 不推荐：多次小规模设置
resolver.set_property("key1", "value1")
resolver.set_property("key2", "value2")
// ...

// ✅ 推荐：一次性创建
let resolver = PropertyResolver::from_array([
  ("key1", "value1"),
  ("key2", "value2"),
  // ...
])
```

## 完整示例

```moonbit
fn main {
  // 创建配置
  let config = PropertyResolver::from_array([
    ("app.name", "Autumn Framework"),
    ("app.version", "1.0"),
    ("server.host", "localhost"),
    ("server.port", "8080"),
    ("db.url", "jdbc:postgresql://${server.host}:5432/mydb"),
    ("debug", "false")
  ])
  
  // 读取配置
  println("Application: " + config.get_property_or_default("app.name", "Unknown"))
  println("Version: " + config.get_property_or_default("app.version", "0.0"))
  
  match config.get_property_int("server.port") {
    Some(port) => println("Server will listen on port: " + port.to_string())
    None => println("Invalid port configuration")
  }
  
  match config.get_property("db.url") {
    Some(url) => println("Database URL: " + url)
    None => println("Database URL not configured")
  }
  
  let debug_mode = config.get_property_bool("debug").or(false)
  if debug_mode {
    println("Debug mode enabled")
  }
}
```

## 更多资源

- [完整文档](README.md)
- [测试示例](../../../property-test/main.mbt)
- [源代码](PropertyResolver.mbt)
