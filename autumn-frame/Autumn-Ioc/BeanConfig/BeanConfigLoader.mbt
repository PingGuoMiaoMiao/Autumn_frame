/// BeanConfigLoader - Bean é…ç½®åŠ è½½å™¨
/// 
/// ä»é…ç½®æ–‡ä»¶è‡ªåŠ¨åŠ è½½ Bean å®šä¹‰å’Œä¾èµ–å…³ç³»
/// 
/// æ”¯æŒçš„é…ç½®æ ¼å¼ï¼š
/// 1. JSON æ ¼å¼
/// 2. YAML æ ¼å¼ï¼ˆéœ€è¦ YAML è§£æå™¨ï¼‰
/// 
/// é…ç½®æ–‡ä»¶ç¤ºä¾‹ï¼ˆbeans.jsonï¼‰ï¼š
/// {
///   "beans": [
///     {
///       "name": "userService",
///       "class": "UserService",
///       "order": 0,
///       "primary": false,
///       "dependencies": ["userRepository"],
///       "init_method": "init",
///       "destroy_method": "destroy"
///     },
///     {
///       "name": "userRepository",
///       "class": "UserRepository",
///       "dependencies": ["dataSource"]
///     }
///   ]
/// }

// ========== Bean é…ç½®ç»“æ„ ==========

/// Bean é…ç½®å®šä¹‰
pub struct BeanConfig {
  name : String
  class : String
  order : Int
  primary : Bool
  dependencies : Array[String]
  init_method : String?
  destroy_method : String?
  factory_method : String?  // å·¥å‚æ–¹æ³•åç§°
} derive(Eq, Show)

/// åˆ›å»º Bean é…ç½®
pub fn BeanConfig::new(
  name : String,
  class : String
) -> BeanConfig {
  {
    name,
    class,
    order: 0,
    primary: false,
    dependencies: [],
    init_method: None,
    destroy_method: None,
    factory_method: None
  }
}

/// Bean é…ç½®é›†åˆ
pub struct BeanConfigCollection {
  beans : Array[BeanConfig]
} derive(Eq, Show)

// ========== é…ç½®åŠ è½½å™¨ ==========

/// ä» JSON å­—ç¬¦ä¸²åŠ è½½ Bean é…ç½®
/// 
/// æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªç®€åŒ–å®ç°ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦ï¼š
/// 1. é›†æˆ JSON è§£æå™¨ï¼ˆå¦‚ moonbitlang/x/json5ï¼‰
/// 2. å¤„ç†é…ç½®éªŒè¯å’Œé”™è¯¯
pub fn load_from_json(json_str : String) -> BeanConfigCollection? {
  // TODO: å®é™…å®ç°
  // 1. è§£æ JSON
  // 2. æå– beans æ•°ç»„
  // 3. è½¬æ¢ä¸º BeanConfig æ•°ç»„
  
  // æ¨¡æ‹Ÿå®ç°
  None
}

/// ä»æ–‡ä»¶åŠ è½½ Bean é…ç½®
pub fn load_from_file(filename : String) -> BeanConfigCollection? {
  // TODO: å®é™…å®ç°
  // 1. è¯»å–æ–‡ä»¶å†…å®¹
  // 2. è§£æ JSON/YAML
  // 3. è¿”å›é…ç½®é›†åˆ
  
  // æ¨¡æ‹Ÿå®ç°
  None
}

/// å°† Bean é…ç½®æ³¨å†Œåˆ° ApplicationContext
pub fn ApplicationContext::register_from_config(
  mut self : ApplicationContext,
  config : BeanConfigCollection
) -> Unit {
  // ç¬¬ä¸€éï¼šæ³¨å†Œæ‰€æœ‰ Bean å®šä¹‰
  let _ = config.beans.map(fn(bean_config) {
    self.register_bean(
      bean_config.name,
      bean_config.class,
      bean_config.order,
      bean_config.primary
    )
  })
  
  // ç¬¬äºŒéï¼šæ³¨å†Œä¾èµ–å…³ç³»
  let _ = config.beans.map(fn(bean_config) {
    if bean_config.dependencies.length() > 0 {
      self.register_dependency(
        bean_config.name,
        bean_config.dependencies
      )
    }
  })
  
  // ç¬¬ä¸‰éï¼šæ³¨å†Œç”Ÿå‘½å‘¨æœŸæ–¹æ³•
  let _ = config.beans.map(fn(bean_config) {
    match bean_config.init_method {
      Some(init_method) => {
        self.register_init_method(
          bean_config.name,
          fn(_ctx, instance_id) {
            println("  ğŸ”§ è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•: \{init_method} (Bean: \{bean_config.name})")
          }
        )
      },
      None => ()
    }
    
    match bean_config.destroy_method {
      Some(destroy_method) => {
        self.register_destroy_method(
          bean_config.name,
          fn(_ctx, instance_id) {
            println("  ğŸ—‘ï¸  è°ƒç”¨é”€æ¯æ–¹æ³•: \{destroy_method} (Bean: \{bean_config.name})")
          }
        )
      },
      None => ()
    }
  })
  
  println("  âœ… ä»é…ç½®åŠ è½½äº† \{config.beans.length()} ä¸ª Bean å®šä¹‰")
}


