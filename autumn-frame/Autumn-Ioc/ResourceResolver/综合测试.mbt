///|
/// ç»¼åˆæµ‹è¯•ï¼šå±•ç¤ºæ‰€æœ‰æ–°å¢åŠŸèƒ½
/// åŒ…æ‹¬ï¼šURL è§£ç ã€å¤šè·¯å¾„æ‰«æã€ClassLoader æ›¿ä»£
test "URL è§£ç åŠŸèƒ½æµ‹è¯•" {
  println("\n=== URL è§£ç åŠŸèƒ½æµ‹è¯• ===")

  // æµ‹è¯•åŸºæœ¬ URL è§£ç 
  let decoded1 = url_decode("hello%20world")
  println("è§£ç  'hello%20world': " + decoded1)
  if decoded1 != "hello world" {
    abort("URL decode failed")
  }

  // æµ‹è¯•è·¯å¾„è§£ç 
  let decoded2 = url_decode("path%2Fto%2Ffile")
  println("è§£ç  'path%2Fto%2Ffile': " + decoded2)
  if decoded2 != "path/to/file" {
    abort("Path decode failed")
  }

  // æµ‹è¯• + å·è½¬ç©ºæ ¼
  let decoded3 = url_decode("hello+world")
  println("è§£ç  'hello+world': " + decoded3)
  if decoded3 != "hello world" {
    abort("Plus decode failed")
  }
  println("âœ… URL è§£ç æµ‹è¯•é€šè¿‡")
}

///|
test "URL ç¼–ç åŠŸèƒ½æµ‹è¯•" {
  println("\n=== URL ç¼–ç åŠŸèƒ½æµ‹è¯• ===")

  // æµ‹è¯•åŸºæœ¬ç¼–ç 
  let encoded1 = url_encode("hello world")
  println("ç¼–ç  'hello world': " + encoded1)
  if encoded1 != "hello+world" {
    abort("Space encode failed")
  }

  // æµ‹è¯•è·¯å¾„ç¼–ç 
  let encoded2 = url_encode("path/to/file")
  println("ç¼–ç  'path/to/file': " + encoded2)

  // æµ‹è¯•å¾€è¿”è½¬æ¢
  let original = "test value"
  let encoded = url_encode(original)
  let decoded = url_decode(encoded)
  if decoded != original {
    abort("Roundtrip failed")
  }
  println("âœ… URL ç¼–ç æµ‹è¯•é€šè¿‡")
}

///|
test "å¤šè·¯å¾„æ‰«æåŠŸèƒ½æµ‹è¯•ï¼ˆClassLoader æ›¿ä»£ï¼‰" {
  println(
    "\n=== å¤šè·¯å¾„æ‰«ææµ‹è¯•ï¼ˆæ¨¡æ‹Ÿ ClassLoader.getResources()ï¼‰===",
  )
  let resolver = ResourceResolver::new("autumn-frame.Autumn-Ioc").with_debug(
    false,
  )

  // å®šä¹‰å¤šä¸ªæœç´¢è·¯å¾„ï¼ˆæ¨¡æ‹Ÿ Java classpathï¼‰
  let search_paths = @list.List::from_array([
    "./autumn-frame/Autumn-Ioc", // ä¸»æºç ç›®å½•
     "./src/main/resources", // èµ„æºç›®å½•ï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰
     "./config", // é…ç½®ç›®å½•ï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰
  ])
  println("æœç´¢è·¯å¾„:")
  let _ = search_paths.map(fn(path) { println("  - " + path) })

  // æ‰«ææ‰€æœ‰è·¯å¾„ä¸­çš„ .mbt æ–‡ä»¶
  let mbt_files = resolver.scan_paths(search_paths, fn(res) {
    if res.name.has_suffix(".mbt") {
      Some(res.name)
    } else {
      None
    }
  })
  println("\næ‰¾åˆ°çš„ .mbt æ–‡ä»¶:")
  let mut count = 0
  let _ = mbt_files.map(fn(name) {
    if count < 5 {
      println("  " + (count + 1).to_string() + ". " + name)
      count = count + 1
    }
  })
  if mbt_files.length() > 5 {
    println(
      "  ... è¿˜æœ‰ " + (mbt_files.length() - 5).to_string() + " ä¸ªæ–‡ä»¶",
    )
  }
  println("\næ€»è®¡: " + mbt_files.length().to_string() + " ä¸ªæ–‡ä»¶")
  println("âœ… å¤šè·¯å¾„æ‰«ææµ‹è¯•é€šè¿‡")
}

///|
test "ç»¼åˆåœºæ™¯ï¼šå¸¦ URL è§£ç çš„å¤šè·¯å¾„æ‰«æ" {
  println("\n=== ç»¼åˆåœºæ™¯æµ‹è¯• ===")
  let resolver = ResourceResolver::new("autumn-frame.Autumn-Ioc")

  // æ¨¡æ‹ŸåŒ…å« URL ç¼–ç çš„è·¯å¾„
  let encoded_path = url_encode("autumn-frame/Autumn-Ioc")
  let decoded_path = url_decode(encoded_path)
  println("åŸå§‹è·¯å¾„: autumn-frame/Autumn-Ioc")
  println("URL ç¼–ç : " + encoded_path)
  println("URL è§£ç : " + decoded_path)

  // ä½¿ç”¨è§£ç åçš„è·¯å¾„æ‰«æ
  let paths = @list.List::from_array(["./autumn-frame/Autumn-Ioc"])
  let results = resolver.scan_paths(paths, fn(res) {
    // åªæ”¶é›†æ–‡æ¡£æ–‡ä»¶
    if res.name.has_suffix(".md") {
      Some(res.name)
    } else {
      None
    }
  })
  println("\næ‰¾åˆ°çš„æ–‡æ¡£æ–‡ä»¶:")
  let _ = results.map(fn(name) { println("  ğŸ“„ " + name) })
  println("\nâœ… ç»¼åˆæµ‹è¯•é€šè¿‡")
}

///|
test "æ¨¡æ‹Ÿ Java ClassLoader åœºæ™¯" {
  println("\n=== æ¨¡æ‹Ÿ Java ClassLoader.getResources() ===")
  println("Java ä»£ç :")
  println(
    "  Enumeration<URL> urls = classLoader.getResources(\"com/example\");",
  )
  println("  while (urls.hasMoreElements()) { ... }")
  println("\nMoonbit ç­‰ä»·ä»£ç :")
  println("  let paths = @list.List::from_array([...])")
  println("  let results = resolver.scan_paths(paths, mapper)")

  // å®é™…æ¼”ç¤º
  let resolver = ResourceResolver::new("")
  let classpath = @list.List::from_array([
    "./autumn-frame/Autumn-Ioc", "./target/classes", // å¯èƒ½ä¸å­˜åœ¨
     "./resources", // å¯èƒ½ä¸å­˜åœ¨
  ])
  println("\nç±»è·¯å¾„ (classpath):")
  let _ = classpath.map(fn(path) {
    let exists = if @fs.path_exists(path) { "âœ…" } else { "âŒ" }
    println("  " + exists + " " + path)
  })
  let all_files = resolver.scan_paths(classpath, fn(res) { Some(res) })
  println(
    "\nä»æ‰€æœ‰ç±»è·¯å¾„ä¸­æ‰¾åˆ°: " +
    all_files.length().to_string() +
    " ä¸ªèµ„æº",
  )
  println("âœ… ClassLoader æ¨¡æ‹Ÿæµ‹è¯•é€šè¿‡")
}
