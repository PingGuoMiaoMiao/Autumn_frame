/// TransactionManager - äº‹åŠ¡ç®¡ç†å™¨å®ç°
/// 
/// ç®¡ç†æ•°æ®åº“äº‹åŠ¡çš„åˆ›å»ºã€æäº¤å’Œå›æ»š

// ========== å¯¼å…¥ä¾èµ– ==========

// ========== äº‹åŠ¡ç®¡ç†å™¨ ==========

///|
/// äº‹åŠ¡ç®¡ç†å™¨
pub struct TransactionManager {
  // å½“å‰æ´»åŠ¨çš„äº‹åŠ¡æ ˆï¼ˆæ”¯æŒåµŒå¥—äº‹åŠ¡ï¼‰
  active_transactions : @hashmap.HashMap[String, Transaction]

  // äº‹åŠ¡è®¡æ•°å™¨ï¼ˆç”¨äºç”Ÿæˆå”¯ä¸€äº‹åŠ¡ IDï¼‰
  mut transaction_counter : Int
}

///|
/// åˆ›å»ºäº‹åŠ¡ç®¡ç†å™¨
pub fn TransactionManager::new() -> TransactionManager {
  { active_transactions: @hashmap.new(), transaction_counter: 0 }
}

// ========== äº‹åŠ¡ç®¡ç†æ–¹æ³• ==========

///|
/// è·å–å½“å‰äº‹åŠ¡
/// 
/// å‚æ•°ï¼š
/// - bean_name: Bean åç§°ï¼ˆç”¨äºæ ‡è¯†äº‹åŠ¡ä¸Šä¸‹æ–‡ï¼‰
/// 
/// è¿”å›å€¼ï¼š
/// - Some(transaction): å­˜åœ¨äº‹åŠ¡
/// - None: ä¸å­˜åœ¨äº‹åŠ¡
pub fn TransactionManager::get_transaction(
  self : TransactionManager,
  bean_name : String,
) -> Transaction? {
  self.active_transactions.get(bean_name)
}

///|
/// å¼€å§‹äº‹åŠ¡
/// 
/// å‚æ•°ï¼š
/// - bean_name: Bean åç§°ï¼ˆç”¨äºæ ‡è¯†äº‹åŠ¡ä¸Šä¸‹æ–‡ï¼‰
/// - definition: äº‹åŠ¡å®šä¹‰
/// 
/// è¿”å›å€¼ï¼š
/// - äº‹åŠ¡å¯¹è±¡
pub fn TransactionManager::begin_transaction(
  self : TransactionManager,
  bean_name : String,
  _definition : TransactionDefinition,
) -> Transaction {
  // ç”Ÿæˆå”¯ä¸€äº‹åŠ¡ ID
  self.transaction_counter = self.transaction_counter + 1
  let transaction_id = "tx_" +
    bean_name +
    "_" +
    self.transaction_counter.to_string()

  // åˆ›å»ºäº‹åŠ¡å¯¹è±¡
  let transaction = Transaction::new(transaction_id, Active)

  // å­˜å‚¨æ´»åŠ¨äº‹åŠ¡
  self.active_transactions.set(bean_name, transaction)
  println("  ğŸ”µ å¼€å§‹äº‹åŠ¡: \{transaction_id} (Bean: \{bean_name})")
  transaction
}

///|
/// æäº¤äº‹åŠ¡
/// 
/// å‚æ•°ï¼š
/// - bean_name: Bean åç§°
pub fn TransactionManager::commit_transaction(
  self : TransactionManager,
  bean_name : String,
) -> Unit {
  match self.active_transactions.get(bean_name) {
    Some(transaction) => {
      println(
        "  âœ… æäº¤äº‹åŠ¡: \{transaction.get_id()} (Bean: \{bean_name})",
      )

      // ç§»é™¤å·²æäº¤çš„äº‹åŠ¡
      self.active_transactions.remove(bean_name)
    }
    None => println("  âš ï¸  äº‹åŠ¡ä¸å­˜åœ¨: \{bean_name}")
  }
}

///|
/// å›æ»šäº‹åŠ¡
/// 
/// å‚æ•°ï¼š
/// - bean_name: Bean åç§°
pub fn TransactionManager::rollback_transaction(
  self : TransactionManager,
  bean_name : String,
) -> Unit {
  match self.active_transactions.get(bean_name) {
    Some(transaction) => {
      println(
        "  âŒ å›æ»šäº‹åŠ¡: \{transaction.get_id()} (Bean: \{bean_name})",
      )

      // ç§»é™¤å·²å›æ»šçš„äº‹åŠ¡
      self.active_transactions.remove(bean_name)
    }
    None => println("  âš ï¸  äº‹åŠ¡ä¸å­˜åœ¨: \{bean_name}")
  }
}

///|
/// æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ´»åŠ¨äº‹åŠ¡
/// 
/// å‚æ•°ï¼š
/// - bean_name: Bean åç§°
/// 
/// è¿”å›å€¼ï¼š
/// - true: å­˜åœ¨æ´»åŠ¨äº‹åŠ¡
/// - false: ä¸å­˜åœ¨æ´»åŠ¨äº‹åŠ¡
pub fn TransactionManager::has_active_transaction(
  self : TransactionManager,
  bean_name : String,
) -> Bool {
  match self.active_transactions.get(bean_name) {
    Some(transaction) =>
      match transaction.get_status() {
        Active => true
        _ => false
      }
    None => false
  }
}
