/// JdbcTemplate - JDBC æ¨¡æ¿ç±»
/// 
/// ç®€åŒ– JDBC æ“ä½œï¼Œæä¾›ä¾¿æ·çš„æ•°æ®åº“è®¿é—®æ–¹æ³•

// ========== JdbcTemplate ç»“æ„ ==========

/// JdbcTemplate
pub struct JdbcTemplate {
  data_source_fn : DataSource  // æ•°æ®æºï¼ˆå‡½æ•°ç±»å‹ï¼‰
  // å¯é€‰çš„æ•°æ®åº“å¼•ç”¨ï¼ˆç”¨äºå†…å­˜æ•°æ®åº“ï¼‰
  // æ³¨æ„ï¼šç”±äº MemoryDatabase æ˜¯ä¸å¯å˜çš„ï¼Œæ¯æ¬¡æ“ä½œåéœ€è¦æ›´æ–°å¼•ç”¨
  mut database_ref : MemoryDatabase?
}

/// åˆ›å»º JdbcTemplateï¼ˆä»æ•°æ®æºå‡½æ•°ï¼‰
pub fn JdbcTemplate::new(data_source_fn : DataSource) -> JdbcTemplate {
  {
    data_source_fn,
    database_ref: None
  }
}

/// åˆ›å»º JdbcTemplateï¼ˆä»å†…å­˜æ•°æ®åº“ï¼‰
pub fn JdbcTemplate::new_with_memory_database(database : MemoryDatabase) -> JdbcTemplate {
  // åˆ›å»ºä¸€ä¸ªæ•°æ®æºå‡½æ•°ï¼Œè¿”å›æ ‡è¯†è¿æ¥çš„ Connection
  let data_source_fn : DataSource = fn() {
    Connection::new("memory_db")
  }
  { data_source_fn, database_ref: Some(database) }
}

// ========== æ ¸å¿ƒæ–¹æ³• ==========

/// æ‰§è¡Œ SQLï¼ˆä¸è¿”å›ç»“æœï¼‰
/// 
/// å‚æ•°ï¼š
/// - sql: SQL è¯­å¥
/// - params: å‚æ•°æ•°ç»„ï¼ˆé¡ºåºå¯¹åº” SQL ä¸­çš„ ?ï¼‰
/// 
/// è¿”å›å€¼ï¼š
/// - å½±å“çš„è¡Œæ•°
pub fn JdbcTemplate::execute(
  self : JdbcTemplate,
  sql : String,
  params : Array[String]
) -> Int {
  // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨å†…å­˜æ•°æ®åº“
  match self.database_ref {
    Some(db) => {
      // ä½¿ç”¨å†…å­˜æ•°æ®åº“æ‰§è¡Œ SQL
      let (result, updated_db) = db.execute(sql, params)
      // æ›´æ–°æ•°æ®åº“å¼•ç”¨ï¼ˆä¿å­˜çŠ¶æ€ï¼‰
      self.database_ref = Some(updated_db)
      result
    }
    None => {
      // ä½¿ç”¨ä¼ ç»Ÿæ•°æ®æºï¼ˆæ¨¡æ‹Ÿå®ç°ï¼‰
      println("  ğŸ“ æ‰§è¡Œ SQL: \{sql}")
      println("  ğŸ“‹ å‚æ•°: \{params.length()} ä¸ª")
      println("  âš ï¸  ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æºï¼Œå®é™…éœ€è¦ä½¿ç”¨å†…å­˜æ•°æ®åº“")
      0  // æ¨¡æ‹Ÿå½±å“è¡Œæ•°
    }
  }
}

/// æŸ¥è¯¢å¹¶æ˜ å°„ä¸ºå•ä¸ªå¯¹è±¡
/// 
/// å‚æ•°ï¼š
/// - sql: SQL è¯­å¥
/// - params: å‚æ•°æ•°ç»„
/// - row_mapper: è¡Œæ˜ å°„å™¨
/// 
/// è¿”å›å€¼ï¼š
/// - Some(å¯¹è±¡): æŸ¥è¯¢æˆåŠŸ
/// - None: æœªæ‰¾åˆ°è®°å½•
pub fn JdbcTemplate::query(
  self : JdbcTemplate,
  sql : String,
  params : Array[String],
  row_mapper : RowMapper
) -> String? {
  // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨å†…å­˜æ•°æ®åº“
  match self.database_ref {
    Some(db) => {
      // ä½¿ç”¨å†…å­˜æ•°æ®åº“æŸ¥è¯¢
      let rows = db.query(sql, params)
      if rows.length() > 0 {
        Some(row_mapper(rows[0]))
      } else {
        None
      }
    }
    None => {
      // ä½¿ç”¨ä¼ ç»Ÿæ•°æ®æºï¼ˆæ¨¡æ‹Ÿå®ç°ï¼‰
      println("  ğŸ“ æŸ¥è¯¢ SQL: \{sql}")
      println("  ğŸ“‹ å‚æ•°: \{params.length()} ä¸ª")
      println("  âš ï¸  ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æºï¼Œå®é™…éœ€è¦ä½¿ç”¨å†…å­˜æ•°æ®åº“")
      
      // åˆ›å»ºæ¨¡æ‹Ÿè¡Œæ•°æ®
      let mock_row : @hashmap.HashMap[String, String] = @hashmap.new()
      mock_row.set("id", "1")
      mock_row.set("name", "test")
      
      Some(row_mapper(mock_row))
    }
  }
}

/// æŸ¥è¯¢å¹¶æ˜ å°„ä¸ºåˆ—è¡¨
/// 
/// å‚æ•°ï¼š
/// - sql: SQL è¯­å¥
/// - params: å‚æ•°æ•°ç»„
/// - row_mapper: è¡Œæ˜ å°„å™¨
/// 
/// è¿”å›å€¼ï¼š
/// - å¯¹è±¡åˆ—è¡¨
pub fn JdbcTemplate::query_for_list(
  self : JdbcTemplate,
  sql : String,
  params : Array[String],
  row_mapper : RowMapper
) -> Array[String] {
  // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨å†…å­˜æ•°æ®åº“
  match self.database_ref {
    Some(db) => {
      // ä½¿ç”¨å†…å­˜æ•°æ®åº“æŸ¥è¯¢
      let rows = db.query(sql, params)
         let result : Array[String] = []
         let result_mut = result
      let mut i = 0
      while i < rows.length() {
        result_mut.push(row_mapper(rows[i]))
        i = i + 1
      }
      result_mut
    }
    None => {
      // ä½¿ç”¨ä¼ ç»Ÿæ•°æ®æºï¼ˆæ¨¡æ‹Ÿå®ç°ï¼‰
      println("  ğŸ“ æŸ¥è¯¢åˆ—è¡¨ SQL: \{sql}")
      println("  ğŸ“‹ å‚æ•°: \{params.length()} ä¸ª")
      println("  âš ï¸  ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æºï¼Œå®é™…éœ€è¦ä½¿ç”¨å†…å­˜æ•°æ®åº“")
      
      // åˆ›å»ºæ¨¡æ‹Ÿè¡Œæ•°æ®
      let mock_row : @hashmap.HashMap[String, String] = @hashmap.new()
      mock_row.set("id", "1")
      mock_row.set("name", "test")
      
      [row_mapper(mock_row)]
    }
  }
}

/// æ›´æ–°æ“ä½œï¼ˆINSERT/UPDATE/DELETEï¼‰
/// 
/// å‚æ•°ï¼š
/// - sql: SQL è¯­å¥
/// - params: å‚æ•°æ•°ç»„
/// 
/// è¿”å›å€¼ï¼š
/// - å½±å“çš„è¡Œæ•°
pub fn JdbcTemplate::update(
  self : JdbcTemplate,
  sql : String,
  params : Array[String]
) -> Int {
  // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨å†…å­˜æ•°æ®åº“
  match self.database_ref {
    Some(db) => {
      // ä½¿ç”¨å†…å­˜æ•°æ®åº“æ‰§è¡Œæ›´æ–°
      let (result, updated_db) = db.execute(sql, params)
      // æ›´æ–°æ•°æ®åº“å¼•ç”¨
      self.database_ref = Some(updated_db)
      result
    }
    None => {
      // ä½¿ç”¨ä¼ ç»Ÿæ•°æ®æºï¼ˆæ¨¡æ‹Ÿå®ç°ï¼‰
      println("  ğŸ“ æ›´æ–° SQL: \{sql}")
      println("  ğŸ“‹ å‚æ•°: \{params.length()} ä¸ª")
      println("  âš ï¸  ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æºï¼Œå®é™…éœ€è¦ä½¿ç”¨å†…å­˜æ•°æ®åº“")
      1  // æ¨¡æ‹Ÿå½±å“è¡Œæ•°
    }
  }
}

/// æ‰¹é‡æ›´æ–°
/// 
/// å‚æ•°ï¼š
/// - sql: SQL è¯­å¥ï¼ˆä½¿ç”¨ ? ä½œä¸ºå ä½ç¬¦ï¼‰
/// - params_list: å‚æ•°åˆ—è¡¨æ•°ç»„ï¼ˆæ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªå‚æ•°æ•°ç»„ï¼‰
/// 
/// è¿”å›å€¼ï¼š
/// - æ¯æ¡è¯­å¥å½±å“çš„è¡Œæ•°æ•°ç»„
pub fn JdbcTemplate::batch_update(
  self : JdbcTemplate,
  sql : String,
  params_list : Array[Array[String]]
) -> Array[Int] {
  // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨å†…å­˜æ•°æ®åº“
  match self.database_ref {
    Some(db) => {
      // ä½¿ç”¨å†…å­˜æ•°æ®åº“æ‰¹é‡æ‰§è¡Œ
      let result : Array[Int] = []
      let result_mut = result
      let mut current_db = db
      let mut i = 0
      while i < params_list.length() {
        let (affected_rows, updated_db) = current_db.execute(sql, params_list[i])
        current_db = updated_db
        result_mut.push(affected_rows)
        i = i + 1
      }
      // æ›´æ–°æ•°æ®åº“å¼•ç”¨
      self.database_ref = Some(current_db)
      result_mut
    }
    None => {
      // ä½¿ç”¨ä¼ ç»Ÿæ•°æ®æºï¼ˆæ¨¡æ‹Ÿå®ç°ï¼‰
      println("  ğŸ“ æ‰¹é‡æ›´æ–° SQL: \{sql}")
      println("  ğŸ“‹ æ‰¹æ¬¡æ•°é‡: \{params_list.length()}")
      println("  âš ï¸  ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æºï¼Œå®é™…éœ€è¦ä½¿ç”¨å†…å­˜æ•°æ®åº“")
      
      // è¿”å›æ¯æ¡è¯­å¥çš„å½±å“è¡Œæ•°
      let result : Array[Int] = []
      let mut i = 0
      while i < params_list.length() {
        result.push(1)  // æ¨¡æ‹Ÿæ¯æ¡è¯­å¥å½±å“ 1 è¡Œ
        i = i + 1
      }
      result
    }
  }
}

/// æŸ¥è¯¢å•ä¸ªå€¼ï¼ˆå¦‚ COUNTã€MAX ç­‰èšåˆå‡½æ•°ï¼‰
/// 
/// å‚æ•°ï¼š
/// - sql: SQL è¯­å¥
/// - params: å‚æ•°æ•°ç»„
/// 
/// è¿”å›å€¼ï¼š
/// - Some(å€¼): æŸ¥è¯¢æˆåŠŸ
/// - None: æœªæ‰¾åˆ°è®°å½•
pub fn JdbcTemplate::query_for_scalar(
  self : JdbcTemplate,
  sql : String,
  params : Array[String]
) -> String? {
  // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨å†…å­˜æ•°æ®åº“
  match self.database_ref {
    Some(db) => {
      // ä½¿ç”¨å†…å­˜æ•°æ®åº“æŸ¥è¯¢
      let rows = db.query(sql, params)
      if rows.length() > 0 {
        // è·å–ç¬¬ä¸€è¡Œç¬¬ä¸€åˆ—çš„å€¼ï¼ˆç®€åŒ–å®ç°ï¼‰
        let first_row = rows[0]
        // ç®€åŒ–å®ç°ï¼šè¿”å›ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„å€¼
        let mut first_value : String? = None
        first_row.iter().each(fn(entry) {
          let (_key, value) = entry
          match first_value {
            None => first_value = Some(value)
            Some(_) => ()
          }
        })
        first_value
      } else {
        None
      }
    }
    None => {
      // ä½¿ç”¨ä¼ ç»Ÿæ•°æ®æºï¼ˆæ¨¡æ‹Ÿå®ç°ï¼‰
      println("  ğŸ“ æŸ¥è¯¢æ ‡é‡ SQL: \{sql}")
      println("  ğŸ“‹ å‚æ•°: \{params.length()} ä¸ª")
      println("  âš ï¸  ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æºï¼Œå®é™…éœ€è¦ä½¿ç”¨å†…å­˜æ•°æ®åº“")
      Some("42")  // æ¨¡æ‹Ÿè¿”å›å€¼
    }
  }
}
