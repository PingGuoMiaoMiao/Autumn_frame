///|
/// FFI æ•°æ®åº“è¿æ¥æ¼”ç¤º
/// 
/// æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ FFI è¿æ¥çœŸå®çš„ SQLite æ•°æ®åº“
/// 
/// æ³¨æ„ï¼š
/// - ä»…åœ¨ native åç«¯å¯ç”¨ï¼ˆC åç«¯ï¼‰
/// - éœ€è¦ç³»ç»Ÿå®‰è£… SQLite åº“ï¼ˆ-lsqlite3ï¼‰
/// - éœ€è¦ç¼–è¯‘æ—¶æŒ‡å®š --target native
fn main {
  println("=".repeat(60))
  println("ğŸŒŸ Autumn Frame - FFI æ•°æ®åº“è¿æ¥æ¼”ç¤º")
  println("=".repeat(60))
  println("")
  println("ğŸ“ æ³¨æ„ï¼šFFI åŠŸèƒ½ä»…åœ¨ native åç«¯å¯ç”¨")
  println("   ä½¿ç”¨å‘½ä»¤ï¼šmoon build --target native")
  println("   æˆ–ï¼šmoon run --target native ffi-demo")
  println("")

  // ========== ç¬¬ä¸€éƒ¨åˆ†ï¼šåˆ›å»º FFI æ•°æ®æº ==========
  println("ğŸ“¦ ç¬¬ä¸€æ­¥ï¼šåˆ›å»º FFI æ•°æ®æº")
  println("â”€".repeat(60))

  // åˆ›å»º FFI æ•°æ®æºé…ç½®
  let config = @JdbcTemplate.FFIDataSourceConfig::new("sqlite:test.db")
  let data_source = @JdbcTemplate.FFIDataSource::new(config)
  println("âœ“ FFI æ•°æ®æºåˆ›å»ºæˆåŠŸ")
  println("")

  // ========== ç¬¬äºŒéƒ¨åˆ†ï¼šè¿æ¥åˆ°æ•°æ®åº“ ==========
  println("ğŸ“ ç¬¬äºŒæ­¥ï¼šè¿æ¥åˆ°æ•°æ®åº“")
  println("â”€".repeat(60))
  let connected_source = data_source.connect()
  println("")

  // ========== ç¬¬ä¸‰éƒ¨åˆ†ï¼šåˆ›å»ºè¡¨ ==========
  println("ğŸ“ ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºè¡¨")
  println("â”€".repeat(60))
  match
    connected_source.execute(
      "CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY, name TEXT, email TEXT)",
    ) {
    Some(_) => println("âœ“ è¡¨åˆ›å»ºæˆåŠŸ")
    None => println("âŒ è¡¨åˆ›å»ºå¤±è´¥")
  }
  println("")

  // ========== ç¬¬å››éƒ¨åˆ†ï¼šæ’å…¥æ•°æ® ==========
  println("ğŸ“ ç¬¬å››æ­¥ï¼šæ’å…¥æ•°æ®")
  println("â”€".repeat(60))
  match
    connected_source.execute(
      "INSERT INTO users (name, email) VALUES ('Alice', 'alice@example.com')",
    ) {
    Some(rows) => println("âœ“ æ’å…¥æˆåŠŸï¼Œå½±å“è¡Œæ•°: \{rows}")
    None => println("âŒ æ’å…¥å¤±è´¥")
  }
  match
    connected_source.execute(
      "INSERT INTO users (name, email) VALUES ('Bob', 'bob@example.com')",
    ) {
    Some(rows) => println("âœ“ æ’å…¥æˆåŠŸï¼Œå½±å“è¡Œæ•°: \{rows}")
    None => println("âŒ æ’å…¥å¤±è´¥")
  }
  println("")

  // ========== ç¬¬äº”éƒ¨åˆ†ï¼šæŸ¥è¯¢æ•°æ® ==========
  println("ğŸ“ ç¬¬äº”æ­¥ï¼šæŸ¥è¯¢æ•°æ®")
  println("â”€".repeat(60))
  let row_mapper : @JdbcTemplate.RowMapper = fn(row : @JdbcTemplate.Row) {
    let mut result = ""
    row
    .iter()
    .each(fn(entry : (String, String)) {
      let (key, value) = entry
      if result.length() > 0 {
        result = result + ", "
      }
      result = result + key + "=" + value
    })
    result
  }
  match
    connected_source.query(
      "SELECT name, email FROM users WHERE name = 'Alice'", row_mapper,
    ) {
    Some(results) => {
      println("âœ“ æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° \{results.length()} æ¡è®°å½•ï¼š")
      let mut i = 0
      while i < results.length() {
        println("  - \{results[i]}")
        i = i + 1
      }
    }
    None => println("â„¹ï¸  æœªæ‰¾åˆ°è®°å½•")
  }
  println("")

  // ========== ç¬¬å…­éƒ¨åˆ†ï¼šæ–­å¼€è¿æ¥ ==========
  println("ğŸ“ ç¬¬å…­æ­¥ï¼šæ–­å¼€è¿æ¥")
  println("â”€".repeat(60))
  let _ = connected_source.disconnect()
  println("âœ“ æ–­å¼€è¿æ¥æˆåŠŸ")
  println("")

  // ========== æ€»ç»“ ==========
  println("=".repeat(60))
  println("ğŸ“Š æ€»ç»“")
  println("=".repeat(60))
  println("âœ… å·²å®Œæˆçš„åŠŸèƒ½ï¼š")
  println("  1. âœ“ DatabaseFFI - SQLite FFI å¤–éƒ¨å‡½æ•°å£°æ˜")
  println("  2. âœ“ FFIDataSource - FFI æ•°æ®æºå®ç°")
  println("  3. âœ“ C èƒ¶æ°´å‡½æ•° - sqlite_wrapper.c")
  println("  4. âœ“ æ•°æ®åº“è¿æ¥ - connect/disconnect")
  println("  5. âœ“ SQL æ‰§è¡Œ - execute/query/batch_execute")
  println("")
  println("ğŸ‰ FFI æ•°æ®åº“è¿æ¥åŠŸèƒ½æ¼”ç¤ºå®Œæˆï¼")
  println("")
  println("âš ï¸  æ³¨æ„ï¼š")
  println("  - æ­¤åŠŸèƒ½ä»…åœ¨ native åç«¯å¯ç”¨")
  println("  - wasm-gc åç«¯ä¸æ”¯æŒ extern \"C\" fn")
  println("  - éœ€è¦ç³»ç»Ÿå®‰è£… SQLite åº“")
}
