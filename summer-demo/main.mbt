/// Summer Demo - Autumn Framework ç¤ºä¾‹
/// 
/// å‚è€ƒ summer-framework çš„å®ç°æ–¹å¼ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ Autumn Framework
/// åˆ›å»ºä¸€ä¸ªç®€å•çš„ Web åº”ç”¨

// ========== å¯¼å…¥ä¾èµ– ==========

/// ä¸»å‡½æ•°
fn main {
  println("============================================================")
  println("Autumn Framework ç¤ºä¾‹åº”ç”¨")
  println("============================================================")
  println("")
  
  // ========== ç¬¬ä¸€æ­¥ï¼šåˆ›å»º IoC å®¹å™¨ ==========
  println("ğŸ“ ç¬¬ä¸€æ­¥ï¼šåˆ›å»º IoC å®¹å™¨")
  println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
  
  let config = [
    ("app.name", "Summer Demo"),
    ("app.version", "1.0.0"),
    ("server.port", "8080"),
    ("db.url", "jdbc:mysql://localhost:3306/test"),
    ("db.username", "root"),
    ("db.password", "password")
  ]
  
  let ctx = @ApplicationContext.ApplicationContext::new(config, "com.example")
  println("âœ“ IoC å®¹å™¨åˆ›å»ºæˆåŠŸ")
  println("  - é…ç½®é¡¹æ•°é‡: " + config.length().to_string())
  println("")
  
  // ========== ç¬¬äºŒæ­¥ï¼šæ³¨å†Œ Bean ==========
  println("ğŸ“¦ ç¬¬äºŒæ­¥ï¼šæ³¨å†Œ Bean")
  println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
  
  ctx.register_bean("userService", "com.example.service.UserService", 10, false)
  ctx.register_bean("userController", "com.example.controller.UserController", 20, false)
  
  println("âœ“ æ³¨å†Œ Bean: userService")
  println("âœ“ æ³¨å†Œ Bean: userController")
  println("")
  
  // ========== ç¬¬ä¸‰æ­¥ï¼šåˆ›å»º Bean å®ä¾‹ ==========
  println("ğŸ”¨ ç¬¬ä¸‰æ­¥ï¼šåˆ›å»º Bean å®ä¾‹")
  println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
  
  ctx.create_all_beans()
  println("âœ“ æ‰€æœ‰ Bean åˆ›å»ºå®Œæˆ")
  println("")
  
  // ========== ç¬¬å››æ­¥ï¼šåˆ›å»º Web MVC åº”ç”¨ ==========
  println("ğŸŒ ç¬¬å››æ­¥ï¼šåˆ›å»º Web MVC åº”ç”¨")
  println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
  
  // 4.1 åˆ›å»º Controller
  let user_controller = @Controller.Controller::new("/users")
    .get("/", fn(request : @Http.HttpRequest) {
      let html_part1 = "<html><head><title>ç”¨æˆ·åˆ—è¡¨</title></head><body>"
      let html_part2 = html_part1 + "<h1>ç”¨æˆ·åˆ—è¡¨</h1>"
      let html_part3 = html_part2 + "<ul>"
      let html_part4 = html_part3 + "<li>ç”¨æˆ· 1: Alice</li>"
      let html_part5 = html_part4 + "<li>ç”¨æˆ· 2: Bob</li>"
      let html_part6 = html_part5 + "<li>ç”¨æˆ· 3: Charlie</li>"
      let html_part7 = html_part6 + "</ul>"
      let html = html_part7 + "</body></html>"
      @Http.HttpResponse::ok(html)
    })
    .get("/{id}", fn(request : @Http.HttpRequest) {
      let path = request.get_path()
      let html_part1 = "<html><head><title>ç”¨æˆ·è¯¦æƒ…</title></head><body>"
      let html_part2 = html_part1 + "<h1>ç”¨æˆ·è¯¦æƒ…</h1>"
      let html_part3 = html_part2 + "<p>è·¯å¾„: " + path + "</p>"
      let html = html_part3 + "</body></html>"
      @Http.HttpResponse::ok(html)
    })
    .post("/", fn(request : @Http.HttpRequest) {
      let html_part1 = "<html><head><title>åˆ›å»ºç”¨æˆ·</title></head><body>"
      let html_part2 = html_part1 + "<h1>åˆ›å»ºç”¨æˆ·æˆåŠŸ</h1>"
      let html = html_part2 + "</body></html>"
      @Http.HttpResponse::created(html)
    })
  
  println("âœ“ åˆ›å»º Controller: /users")
  
  // 4.2 åˆ›å»º RestController
  let api_controller = @Controller.RestController::new("/api/users")
    .get("/", fn(request : @Http.HttpRequest) {
      let data = @hashmap.new()
      data.set("id", "1")
      data.set("name", "Alice")
      data.set("email", "alice@example.com")
      @Controller.JsonResponse::new(data)
    })
    .get("/{id}", fn(request : @Http.HttpRequest) {
      let data = @hashmap.new()
      data.set("id", request.get_path())
      data.set("name", "Bob")
      data.set("email", "bob@example.com")
      @Controller.JsonResponse::new(data)
    })
    .post("/", fn(request : @Http.HttpRequest) {
      let data = @hashmap.new()
      data.set("id", "2")
      data.set("name", "Charlie")
      data.set("email", "charlie@example.com")
      @Controller.JsonResponse::new(data)
    })
  
  println("âœ“ åˆ›å»º RestController: /api/users")
  
  // 4.3 åˆ›å»ºæ ¹è·¯å¾„ Controllerï¼ˆå¤„ç† / è¯·æ±‚ï¼‰
  let root_controller = @Controller.Controller::new("")
    .get("/", fn(_request : @Http.HttpRequest) {
      let html_part1 = "<!DOCTYPE html><html><head><title>Autumn Framework Demo</title>"
      let html_part2 = html_part1 + "<meta charset='utf-8'></head><body>"
      let html_part3 = html_part2 + "<h1>æ¬¢è¿ä½¿ç”¨ Autumn Framework</h1>"
      let html_part4 = html_part3 + "<p>è¿™æ˜¯ä¸€ä¸ªåŸºäº MoonBit çš„ Web æ¡†æ¶ç¤ºä¾‹</p>"
      let html_part5 = html_part4 + "<h2>å¯ç”¨è·¯ç”±ï¼š</h2>"
      let html_part6 = html_part5 + "<ul>"
      let html_part7 = html_part6 + "<li><a href='/users'>GET /users</a> - ç”¨æˆ·åˆ—è¡¨</li>"
      let html_part8 = html_part7 + "<li><a href='/api/users'>GET /api/users</a> - API ç”¨æˆ·åˆ—è¡¨</li>"
      let html_part9 = html_part8 + "<li><a href='/users/123'>GET /users/123</a> - ç”¨æˆ·è¯¦æƒ…</li>"
      let html = html_part9 + "</ul></body></html>"
      @Http.HttpResponse::ok(html)
    })
  
  // 4.4 åˆ›å»º DispatcherServlet
  let dispatcher = @Dispatcher.DispatcherServlet::new()
    .register_controller("rootController", root_controller)
    .register_controller("userController", user_controller)
    .register_rest_controller("apiController", api_controller)
  
  println("âœ“ åˆ›å»ºæ ¹è·¯å¾„ Controller: /")
  println("âœ“ åˆ›å»º DispatcherServlet")
  println("")
  
  // ========== ç¬¬äº”æ­¥ï¼šæµ‹è¯•è¯·æ±‚å¤„ç† ==========
  println("ğŸ§ª ç¬¬äº”æ­¥ï¼šæµ‹è¯•è¯·æ±‚å¤„ç†")
  println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
  
  // 5.1 æµ‹è¯• GET /
  let request0 = @Http.HttpRequest::new(
    @Http.HttpMethod::from_string("GET"),
    "/",
    @hashmap.new(),
    @hashmap.new(),
    None
  )
  let response0 = dispatcher.handle_request(request0)
  println("âœ“ GET /")
  println("  çŠ¶æ€ç : " + response0.get_status_code().to_string())
  match response0.get_body() {
    Some(body) => println("  å“åº”ä½“é•¿åº¦: " + body.length().to_string() + " å­—ç¬¦")
    None => println("  å“åº”ä½“: æ— ")
  }
  
  // 5.2 æµ‹è¯• GET /users
  let request1 = @Http.HttpRequest::new(
    @Http.HttpMethod::from_string("GET"),
    "/users",
    @hashmap.new(),
    @hashmap.new(),
    None
  )
  let response1 = dispatcher.handle_request(request1)
  println("âœ“ GET /users")
  println("  çŠ¶æ€ç : " + response1.get_status_code().to_string())
  match response1.get_body() {
    Some(body) => println("  å“åº”ä½“é•¿åº¦: " + body.length().to_string() + " å­—ç¬¦")
    None => println("  å“åº”ä½“: æ— ")
  }
  
  // 5.3 æµ‹è¯• GET /api/users
  let request2 = @Http.HttpRequest::new(
    @Http.HttpMethod::from_string("GET"),
    "/api/users",
    @hashmap.new(),
    @hashmap.new(),
    None
  )
  let response2 = dispatcher.handle_request(request2)
  println("âœ“ GET /api/users")
  println("  çŠ¶æ€ç : " + response2.get_status_code().to_string())
  match response2.get_body() {
    Some(body) => println("  å“åº”ä½“: " + body)
    None => println("  å“åº”ä½“: æ— ")
  }
  
  // 5.4 æµ‹è¯• GET /users/123
  let request3 = @Http.HttpRequest::new(
    @Http.HttpMethod::from_string("GET"),
    "/users/123",
    @hashmap.new(),
    @hashmap.new(),
    None
  )
  let response3 = dispatcher.handle_request(request3)
  println("âœ“ GET /users/123")
  println("  çŠ¶æ€ç : " + response3.get_status_code().to_string())
  
  // 5.5 æµ‹è¯• 404
  let request4 = @Http.HttpRequest::new(
    @Http.HttpMethod::from_string("GET"),
    "/not-found",
    @hashmap.new(),
    @hashmap.new(),
    None
  )
  let response4 = dispatcher.handle_request(request4)
  println("âœ“ GET /not-found (404)")
  println("  çŠ¶æ€ç : " + response4.get_status_code().to_string())
  println("")
  
  // ========== ç¬¬å…­æ­¥ï¼šæŸ¥çœ‹å®¹å™¨çŠ¶æ€ ==========
  println("ğŸ“Š ç¬¬å…­æ­¥ï¼šæŸ¥çœ‹å®¹å™¨çŠ¶æ€")
  println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
  
  ctx.print_summary()
  println("")
  
  // ========== ç¬¬ä¸ƒæ­¥ï¼šä½¿ç”¨ Boot å¯åŠ¨åº”ç”¨ ==========
  println("ğŸš€ ç¬¬ä¸ƒæ­¥ï¼šä½¿ç”¨ Boot å¯åŠ¨åº”ç”¨")
  println("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
  
  println("âœ“ å‡†å¤‡å¯åŠ¨åµŒå…¥å¼æœåŠ¡å™¨...")
  println("  ç«¯å£: 8080")
  println("  è®¿é—®åœ°å€: http://localhost:8080")
  println("")
  
  // ä½¿ç”¨ BootApplication å¯åŠ¨åº”ç”¨
  // æ³¨æ„ï¼šå½“å‰å®ç°æ˜¯å ä½å®ç°ï¼Œå®é™…æœåŠ¡å™¨å¯åŠ¨éœ€è¦ FFI è°ƒç”¨
  // BootApplication::run() ä¼šé˜»å¡ï¼Œç›´åˆ°æœåŠ¡å™¨åœæ­¢
  @Boot.BootApplication::run(8080, fn() {
    dispatcher
  })
  
  // æœåŠ¡å™¨åœæ­¢åæ‰ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ
  println("")
  println("============================================================")
  println("âœ¨ æœåŠ¡å™¨å·²åœæ­¢ï¼Œç¤ºä¾‹åº”ç”¨å®Œæˆï¼")
  println("============================================================")
}

