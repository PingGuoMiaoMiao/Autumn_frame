# MySQL FFI æ•°ç»„è¿”å›é—®é¢˜æ€»ç»“

## å½“å‰çŠ¶æ€

### âœ… å·²å®ç°çš„åŠŸèƒ½

1. **å­—ç¬¦ä¸²è½¬æ¢æ­£å¸¸**
   - å‚æ•°ä¼ é€’æ­£ç¡®ï¼šhost='localhost', user='root', password='123456', database='information_schema'
   - ä½¿ç”¨ç‹¬ç«‹ç¼“å†²åŒºé¿å…è¦†ç›–
   - UTF-16 åˆ° UTF-8 è½¬æ¢æ­£å¸¸

2. **MySQL è¿æ¥æˆåŠŸ**
   - æˆåŠŸè¿æ¥åˆ° `information_schema` æ•°æ®åº“
   - SQL æŸ¥è¯¢æ‰§è¡ŒæˆåŠŸ
   - ç»“æœé›†è·å–æˆåŠŸ

3. **æ•°ç»„åˆ›å»ºå’Œè®¾ç½®æˆåŠŸ**
   - âœ… å¯¹è±¡å¤´æ­£ç¡®åˆå§‹åŒ–ï¼ˆmeta=0x7000000a, rc=1, len=10ï¼‰
   - âœ… æ•°ç»„å…ƒç´ æ­£ç¡®è®¾ç½®ï¼ˆæ‰€æœ‰å…ƒç´ éƒ½è®¾ç½®äº†ï¼‰
   - âœ… å¼•ç”¨è®¡æ•°æ­£ç¡®ç®¡ç†ï¼ˆæ¯ä¸ªå…ƒç´ éƒ½å¢åŠ äº†å¼•ç”¨è®¡æ•°ï¼‰
   - âœ… å¯¹è±¡å¤´ä½ç½®æ­£ç¡®ï¼ˆé€šè¿‡ meta å­—æ®µéªŒè¯ï¼‰

### âŒ å­˜åœ¨çš„é—®é¢˜

**æ•°ç»„è¿”å›æ ¼å¼é—®é¢˜ï¼ˆå·²å®šä½ï¼‰**
- âœ… å¯¹è±¡å¤´å·²æ­£ç¡®åˆå§‹åŒ–ï¼ˆmeta=0x7000000a, rc=1ï¼‰
- âœ… æ•°ç»„å…ƒç´ å·²æ­£ç¡®è®¾ç½®
- âœ… å¯¹è±¡å¤´ä½ç½®å·²æ­£ç¡®è¯†åˆ«
- âŒ è¿”å›å¯¹è±¡å¤´æŒ‡é’ˆåï¼ŒMoonBit è¿è¡Œæ—¶ä»ç„¶å¤±è´¥ï¼ˆerror: failed to runï¼‰
- é—®é¢˜å¯èƒ½åœ¨äº MoonBit è¿è¡Œæ—¶å¯¹ FFI è¿”å› Array çš„ç‰¹æ®Šè¦æ±‚

## å·²å°è¯•çš„è§£å†³æ–¹æ¡ˆ

1. **å¯¹è±¡å¤´ä½ç½®éªŒè¯** âœ…
   - âœ… ç¡®è®¤ `moonbit_make_ref_array` è¿”å›çš„æ˜¯æ•°ç»„å…ƒç´ æŒ‡é’ˆ
   - âœ… å¯¹è±¡å¤´åœ¨æ•°ç»„å…ƒç´ ä¹‹å‰ï¼ˆåç§» 8 å­—èŠ‚ï¼‰
   - âœ… é€šè¿‡ meta å­—æ®µéªŒè¯å¯¹è±¡å¤´ä½ç½®ï¼ˆmeta=0x7000000a, len=10ï¼‰

2. **meta å­—æ®µåˆå§‹åŒ–** âœ…
   - âœ… ä½¿ç”¨ `moonbit_make_ref_array` ç¡®ä¿å¯¹è±¡å¤´è¢«æ­£ç¡®åˆå§‹åŒ–
   - âœ… meta å­—æ®µæ ¼å¼æ­£ç¡®ï¼škind=3 (REF_ARRAY), object_size_shift=0, len=10
   - âœ… rc å­—æ®µæ­£ç¡®åˆå§‹åŒ–ï¼ˆrc=1ï¼‰

3. **å¼•ç”¨è®¡æ•°ç®¡ç†** âœ…
   - âœ… ç¬¬ä¸€ä¸ªå…ƒç´ åœ¨åˆ›å»ºæ—¶å·²è®¾ç½®å¹¶å¢åŠ å¼•ç”¨è®¡æ•°
   - âœ… å…¶ä»–å…ƒç´ æ‰‹åŠ¨è®¾ç½®å¹¶å¢åŠ å¼•ç”¨è®¡æ•°
   - âœ… æ‰€æœ‰å…ƒç´ çš„å¼•ç”¨è®¡æ•°éƒ½æ­£ç¡®ç®¡ç†

4. **æ•°ç»„å…ƒç´ è®¾ç½®** âœ…
   - âœ… æ‰€æœ‰æ•°ç»„å…ƒç´ éƒ½æ­£ç¡®è®¾ç½®
   - âœ… å¯¹è±¡å¤´å’Œæ•°ç»„å…ƒç´ çš„ä½ç½®éƒ½æ­£ç¡®

**å½“å‰çŠ¶æ€ï¼š**
- âœ… æ•°ç»„åˆ›å»ºå’Œè®¾ç½®å®Œå…¨æ­£ç¡®
- âŒ è¿”å›å MoonBit è¿è¡Œæ—¶ä»ç„¶å¤±è´¥

## å¯èƒ½çš„åŸå› 

æ ¹æ® MoonBit C-FFI å¼€å‘æŒ‡å—ï¼Œ**è¿”å› Array[T] å¯èƒ½ä¸æ˜¯ç›´æ¥æ”¯æŒçš„**ã€‚

æŒ‡å—ä¸­ä¸»è¦è®¨è®ºï¼š
1. **ä¼ é€’æ•°ç»„**ï¼šä½¿ç”¨ `FixedArray[T]` ä¼ é€’æ•°ç»„ç»™ C å‡½æ•° âœ…
2. **è¿”å›å­—ç¬¦ä¸²**ï¼šéœ€è¦ C åŒ…è£…å‡½æ•°å°† `char*` è½¬æ¢ä¸º MoonBit String âœ…
3. **è¿”å›ç»“æ„ä½“**ï¼šéœ€è¦ C åŒ…è£…å‡½æ•°å°† C ç»“æ„ä½“è½¬æ¢ä¸º MoonBit å¯¹è±¡ âœ…
4. **è¿”å›æ•°ç»„**ï¼š**æŒ‡å—ä¸­æ²¡æœ‰è¯¦ç»†è¯´æ˜** âŒ

**å¯èƒ½çš„é—®é¢˜ï¼š**
1. MoonBit FFI å¯èƒ½ä¸æ”¯æŒç›´æ¥ä» C è¿”å› `Array[String]`
2. å¯èƒ½éœ€è¦ä½¿ç”¨ `FixedArray[String]` è€Œä¸æ˜¯ `Array[String]`
3. å¯èƒ½éœ€è¦ç¼–å†™ C åŒ…è£…å‡½æ•°ï¼Œå°† C æ•°ç»„è½¬æ¢ä¸º MoonBit Array
4. å¯èƒ½éœ€è¦ä½¿ç”¨å…¶ä»–æ–¹å¼ï¼ˆå¦‚è¿”å›å•ä¸ªå­—ç¬¦ä¸²ï¼Œåœ¨ MoonBit ä¾§è§£æï¼‰

**å½“å‰å®ç°ï¼š**
- ä½¿ç”¨ `moonbit_make_ref_array` åˆ›å»ºæ•°ç»„ âœ…
- å¯¹è±¡å¤´æ­£ç¡®åˆå§‹åŒ– âœ…
- æ•°ç»„å…ƒç´ æ­£ç¡®è®¾ç½® âœ…
- ä½†è¿”å›å MoonBit è¿è¡Œæ—¶ä»ç„¶å¤±è´¥ âŒ

## å»ºè®®çš„ä¸‹ä¸€æ­¥

æ ¹æ® MoonBit C-FFI å¼€å‘æŒ‡å—ï¼Œ**è¿”å› Array[T] å¯èƒ½ä¸æ˜¯ç›´æ¥æ”¯æŒçš„**ã€‚

### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ FixedArray[String]ï¼ˆæ¨èï¼‰

ä¿®æ”¹ FFI å‡½æ•°ç­¾åï¼Œè¿”å› `FixedArray[String]` è€Œä¸æ˜¯ `Array[String]`ï¼š

```moonbit
// DatabaseFFI.mbt
pub extern "C" fn mysql_query_ffi(
  handle : MysqlHandle,
  sql : String,
  params : Array[String]
) -> FixedArray[String] = "autumn_mysql_query"  // æ”¹ä¸º FixedArray
```

ç„¶ååœ¨ MoonBit ä¾§è½¬æ¢ä¸º Arrayï¼š

```moonbit
// MySQLDataSource.mbt
pub fn MySQLDataSource::query(...) -> Array[String]? {
  let fixed_array = mysql_query_ffi(...)
  Some(Array::from_fixed_array(fixed_array))  // è½¬æ¢ä¸º Array
}
```

### æ–¹æ¡ˆ 2ï¼šè¿”å›å•ä¸ªå­—ç¬¦ä¸²ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

è¿”å›ä¸€ä¸ªç‰¹æ®Šæ ¼å¼çš„å­—ç¬¦ä¸²ï¼ˆå¦‚ JSONï¼‰ï¼Œåœ¨ MoonBit ä¾§è§£æï¼š

```c
// mysql_wrapper.c
// è¿”å›æ ¼å¼ï¼šrow1\trow2\trow3...
char* combined = malloc(...);
// æ‹¼æ¥æ‰€æœ‰è¡Œ
return combined;
```

```moonbit
// MySQLDataSource.mbt
let result_str = mysql_query_ffi(...)
let rows = result_str.split("\t")  // åœ¨ MoonBit ä¾§è§£æ
```

### æ–¹æ¡ˆ 3ï¼šç ”ç©¶ MoonBit æºç 

- æŸ¥çœ‹ MoonBit æ ‡å‡†åº“ä¸­æ˜¯å¦æœ‰è¿”å› Array çš„ FFI ç¤ºä¾‹
- æŸ¥çœ‹ `moonbit_make_ref_array` çš„å®Œæ•´å®ç°
- æ£€æŸ¥æ˜¯å¦éœ€è¦ç‰¹æ®Šçš„åˆå§‹åŒ–é¡ºåºæˆ–æ ¼å¼

## æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

æ ¹æ® MoonBit C-FFI å¼€å‘æŒ‡å—å’Œ Array Package æ–‡æ¡£ï¼Œ**æœ€ç»ˆè§£å†³æ–¹æ¡ˆ**ï¼š

### 1. ä½¿ç”¨ FixedArray[String] ä½œä¸º FFI è¿”å›ç±»å‹

```moonbit
// DatabaseFFI.mbt
pub extern "C" fn mysql_query_ffi(
  handle : MysqlHandle,
  sql : String,
  params : Array[String]
) -> FixedArray[String] = "autumn_mysql_query"  // ä½¿ç”¨ FixedArray
```

### 2. åœ¨ MoonBit ä¾§ä½¿ç”¨ Array::from_iter è½¬æ¢

```moonbit
// MySQLDataSource.mbt
let fixed_results = mysql_query_ffi(db, sql, empty_params)
// ä½¿ç”¨ Array::from_iter ä» FixedArray çš„è¿­ä»£å™¨åˆ›å»º Array
let results = Array::from_iter(fixed_results.iter())
```

### 3. C ä¾§å®ç°ä¿æŒä¸å˜

ç»§ç»­ä½¿ç”¨ `moonbit_make_ref_array` åˆ›å»ºæ•°ç»„ï¼Œå¯¹è±¡å¤´æ­£ç¡®åˆå§‹åŒ–ï¼Œæ•°ç»„å…ƒç´ æ­£ç¡®è®¾ç½®ã€‚

## å½“å‰ä»£ç çŠ¶æ€

- âœ… å­—ç¬¦ä¸²è½¬æ¢æ­£å¸¸
- âœ… MySQL è¿æ¥æ­£å¸¸
- âœ… æŸ¥è¯¢æ‰§è¡Œæ­£å¸¸
- âœ… æ•°ç»„åˆ›å»ºæ­£å¸¸ï¼ˆä½¿ç”¨ moonbit_make_ref_arrayï¼‰
- âœ… å¯¹è±¡å¤´æ ¼å¼æ­£ç¡®ï¼ˆmeta=0x7000000a, kind=1, object_size_shift=3, len=10ï¼‰
- âœ… æ•°ç»„å…ƒç´ æ­£ç¡®è®¾ç½®ï¼ˆæ‰€æœ‰å…ƒç´ éƒ½è®¾ç½®äº†ï¼‰
- âœ… å¼•ç”¨è®¡æ•°æ­£ç¡®ç®¡ç†ï¼ˆæ¯ä¸ªå…ƒç´ éƒ½å¢åŠ äº†å¼•ç”¨è®¡æ•°ï¼‰
- âœ… ç¨‹åºè¿è¡Œæ­£å¸¸ï¼Œä¸å†å´©æºƒ
- âŒ **æ•°ç»„é•¿åº¦è¯»å–ä¸æ­£ç¡®**ï¼š`results.length()` è¿”å›è´Ÿæ•°ï¼ˆå¦‚ `-736230392`ï¼‰

## æœ€æ–°å‘ç°

### å¯¹è±¡å¤´æ ¼å¼éªŒè¯

ç»è¿‡éªŒè¯ï¼Œå¯¹è±¡å¤´çš„ meta å­—æ®µæ ¼å¼æ˜¯**æ­£ç¡®çš„**ï¼š
- `meta = 0x7000000a`
- `kind = 1` (REF_ARRAY) âœ…
- `object_size_shift = 3` (64ä½ç³»ç»Ÿä¸Šçš„ void* å¤§å°ï¼šlog2(8) = 3) âœ…
- `len = 10` âœ…

### é—®é¢˜åˆ†æ

è™½ç„¶å¯¹è±¡å¤´æ ¼å¼æ­£ç¡®ï¼Œä½† MoonBit è¿è¡Œæ—¶ä»ç„¶æ— æ³•æ­£ç¡®è¯»å–æ•°ç»„é•¿åº¦ã€‚å¯èƒ½çš„åŸå› ï¼š

1. **æŒ‡é’ˆåç§»é—®é¢˜**ï¼š
   - `Moonbit_object_header` å®å®šä¹‰ï¼š`((struct moonbit_object*)(obj) - 1)`
   - è¿™ä¸ªå®æœŸæœ›ä¼ å…¥æ•°ç»„å…ƒç´ æŒ‡é’ˆï¼Œç„¶åå‡å» 1ï¼ˆå³å‡å» `sizeof(struct moonbit_object*)` = 8 å­—èŠ‚ï¼‰
   - æˆ‘ä»¬çš„å¯¹è±¡å¤´åœ¨æ•°ç»„å…ƒç´ ä¹‹å‰ 8 å­—èŠ‚å¤„ï¼Œç†è®ºä¸Šåº”è¯¥åŒ¹é…
   - ä½† MoonBit è¿è¡Œæ—¶å¯èƒ½æœŸæœ›ä¸åŒçš„æŒ‡é’ˆæ ¼å¼

2. **æ•°ç»„ç±»å‹ä¸åŒ¹é…**ï¼š
   - å½“å‰è¿”å› `Array[String]`ï¼Œä½† MoonBit FFI å¯èƒ½ä¸æ”¯æŒç›´æ¥è¿”å› `Array`
   - å¯èƒ½éœ€è¦è¿”å› `FixedArray[String]` æˆ–ä½¿ç”¨å…¶ä»–æ–¹å¼

3. **å†…å­˜å¸ƒå±€é—®é¢˜**ï¼š
   - `moonbit_make_ref_array` åˆ›å»ºçš„æ•°ç»„æ ¼å¼å¯èƒ½ä¸ MoonBit è¿è¡Œæ—¶æœŸæœ›çš„æ ¼å¼ä¸å®Œå…¨åŒ¹é…
   - å¯èƒ½éœ€è¦ä½¿ç”¨ä¸åŒçš„æ•°ç»„åˆ›å»ºæ–¹å¼

## âœ… æœ€ç»ˆè§£å†³æ–¹æ¡ˆï¼ˆå·²è§£å†³ï¼‰

### é—®é¢˜æ ¹æº

æ ¹æ® MoonBit FFI å®˜æ–¹æ–‡æ¡£ï¼š
- **`FixedArray[T]` åœ¨ C ä¸­æ˜ å°„ä¸º `T*`**ï¼ˆæŒ‡å‘æ•°ç»„å…ƒç´ çš„æŒ‡é’ˆï¼‰âœ…
- **`Array[T]` çš„æ˜ å°„æ–¹å¼åœ¨æ–‡æ¡£ä¸­æœªæ˜ç¡®æåŠ**ï¼Œå¯èƒ½ä¸æ”¯æŒç›´æ¥è¿”å› âŒ

### è§£å†³æ–¹æ¡ˆ

1. **ä¿®æ”¹ FFI å‡½æ•°ç­¾åï¼Œè¿”å› `FixedArray[String]`**ï¼š
   ```moonbit
   // DatabaseFFI.mbt
   pub extern "C" fn mysql_query_ffi(
     handle : MysqlHandle,
     sql : String,
     params : Array[String]
   ) -> FixedArray[String] = "autumn_mysql_query"  // ä½¿ç”¨ FixedArray
   ```

2. **åœ¨ MoonBit ä¾§ä½¿ç”¨ `Array::from_iter` è½¬æ¢**ï¼š
   ```moonbit
   // MySQLDataSource.mbt
   let fixed_results = mysql_query_ffi(db, sql, empty_params)
   // ä½¿ç”¨ Array::from_iter ä» FixedArray çš„è¿­ä»£å™¨åˆ›å»º Array
   let results = Array::from_iter(fixed_results.iter())
   ```

3. **C ä¾§å®ç°ä¿æŒä¸å˜**ï¼š
   - ç»§ç»­ä½¿ç”¨ `moonbit_make_ref_array` åˆ›å»ºæ•°ç»„
   - è¿”å›æ•°ç»„å…ƒç´ æŒ‡é’ˆï¼ˆ`array_elements`ï¼‰
   - MoonBit è¿è¡Œæ—¶ä¼šè‡ªåŠ¨è¯†åˆ«ä¸º `FixedArray`

### éªŒè¯ç»“æœ

```
ğŸ” [MySQLæ•°æ®æº] æŸ¥è¯¢å®Œæˆ, FixedArray ç»“æœæ•°é‡=5
ğŸ” [MySQLæ•°æ®æº] è½¬æ¢ä¸º Array å, ç»“æœæ•°é‡=5
âœ“ æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° 5 æ¡è®°å½•
```

âœ… **æ•°ç»„é•¿åº¦ç°åœ¨å¯ä»¥æ­£ç¡®è¯»å–ï¼**

## å‚è€ƒèµ„æ–™

- MoonBit FFI æ–‡æ¡£ï¼šhttps://docs.moonbitlang.com/zh-cn/latest/language/ffi.html
- MoonBit Array Package æ–‡æ¡£ï¼šæä¾›äº† `Array::from_iter` å’Œ `FixedArray::iter` çš„ä½¿ç”¨æ–¹æ³•
- MoonBit è¿è¡Œæ—¶å¤´æ–‡ä»¶ï¼š`~/.moon/include/moonbit.h`
- REF_ARRAY çš„ meta å­—æ®µæ ¼å¼ï¼šé«˜ 2 ä½æ˜¯ kindï¼Œæ¥ä¸‹æ¥ 2 ä½æ˜¯ object_size_shiftï¼Œä½ 28 ä½æ˜¯ len

