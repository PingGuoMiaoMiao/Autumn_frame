/// JDBC å’Œäº‹åŠ¡ä½¿ç”¨ç¤ºä¾‹
/// 
/// æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ JdbcTemplate å’Œå£°æ˜å¼äº‹åŠ¡

fn main {
  println("=".repeat(60))
  println("ğŸŒŸ Autumn Frame - JDBC å’Œäº‹åŠ¡ä½¿ç”¨ç¤ºä¾‹")
  println("=".repeat(60))
  println("")
  
  // ========== ç¬¬ä¸€éƒ¨åˆ†ï¼šåˆ›å»º IoC å®¹å™¨ ==========
  println("ğŸ“¦ ç¬¬ä¸€æ­¥ï¼šåˆ›å»º IoC å®¹å™¨")
  println("â”€".repeat(60))
  let config : Array[(String, String)] = [
    ("app.name", "JDBC Demo"),
    ("db.url", "jdbc:mysql://localhost:3306/test"),
    ("db.username", "root"),
    ("db.password", "password")
  ]
  let ctx = @ApplicationContext.ApplicationContext::new(config, "com.example")
  println("âœ“ IoC å®¹å™¨åˆ›å»ºæˆåŠŸ")
  println("")
  
  // ========== ç¬¬äºŒéƒ¨åˆ†ï¼šåˆ›å»ºå†…å­˜æ•°æ®åº“å’Œ JdbcTemplate ==========
  println("ğŸ“ ç¬¬äºŒæ­¥ï¼šåˆ›å»ºå†…å­˜æ•°æ®åº“å’Œ JdbcTemplate")
  println("â”€".repeat(60))
  
  // åˆ›å»ºå†…å­˜æ•°æ®åº“
  let database = @JdbcTemplate.MemoryDatabase::new()
  
  // åˆ›å»º JdbcTemplateï¼ˆä½¿ç”¨å†…å­˜æ•°æ®åº“ï¼‰
  let jdbc_template = @JdbcTemplate.JdbcTemplate::new_with_memory_database(database)
  println("âœ“ JdbcTemplate åˆ›å»ºæˆåŠŸï¼ˆä½¿ç”¨å†…å­˜æ•°æ®åº“ï¼‰")
  println("")
  
  // ========== ç¬¬ä¸‰éƒ¨åˆ†ï¼šä½¿ç”¨ JdbcTemplate æ‰§è¡Œæ“ä½œ ==========
  println("ğŸ“ ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨ JdbcTemplate æ‰§è¡Œæ•°æ®åº“æ“ä½œ")
  println("â”€".repeat(60))
  
  // 1. æ’å…¥æ“ä½œ
  println("1ï¸âƒ£  æ’å…¥æ“ä½œ")
  let insert_rows = jdbc_template.update("INSERT INTO users (name, email) VALUES (?, ?)", ["Alice", "alice@example.com"])
  println("   âœ“ æ’å…¥æˆåŠŸï¼Œå½±å“è¡Œæ•°: \{insert_rows}")
  
  let insert_rows2 = jdbc_template.update("INSERT INTO users (name, email) VALUES (?, ?)", ["Bob", "bob@example.com"])
  println("   âœ“ æ’å…¥æˆåŠŸï¼Œå½±å“è¡Œæ•°: \{insert_rows2}")
  println("")
  
  // 2. æŸ¥è¯¢æ“ä½œ
  println("2ï¸âƒ£  æŸ¥è¯¢æ“ä½œ")
  let row_mapper : @JdbcTemplate.RowMapper = fn(row : @JdbcTemplate.Row) {
    let mut result = ""
    row.iter().each(fn(entry : (String, String)) {
      let (key, value) = entry
      if result.length() > 0 {
        result = result + ", "
      }
      result = result + key + "=" + value
    })
    result
  }
  match jdbc_template.query("SELECT * FROM users WHERE id = ?", ["row_1"], row_mapper) {
    Some(result) => println("   âœ“ æŸ¥è¯¢æˆåŠŸ: \{result}")
    None => println("   â„¹ï¸  æœªæ‰¾åˆ°è®°å½•")
  }
  println("")
  
  // 3. æŸ¥è¯¢åˆ—è¡¨
  println("3ï¸âƒ£  æŸ¥è¯¢åˆ—è¡¨")
  let users = jdbc_template.query_for_list("SELECT * FROM users", [], row_mapper)
  println("   âœ“ æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° \{users.length()} æ¡è®°å½•")
  users.iter().each(fn(user) {
    println("     - \{user}")
  })
  println("")
  
  // 4. æ›´æ–°æ“ä½œ
  println("4ï¸âƒ£  æ›´æ–°æ“ä½œ")
  let affected_rows = jdbc_template.update("UPDATE users SET name = ? WHERE id = ?", ["AliceUpdated", "row_1"])
  println("   âœ“ æ›´æ–°æˆåŠŸï¼Œå½±å“è¡Œæ•°: \{affected_rows}")
  
  // å†æ¬¡æŸ¥è¯¢éªŒè¯æ›´æ–°
  match jdbc_template.query("SELECT * FROM users WHERE id = ?", ["row_1"], row_mapper) {
    Some(result) => println("   âœ“ æ›´æ–°åæŸ¥è¯¢: \{result}")
    None => println("   â„¹ï¸  æœªæ‰¾åˆ°è®°å½•")
  }
  println("")
  
  // 5. æ‰¹é‡æ’å…¥
  println("5ï¸âƒ£  æ‰¹é‡æ’å…¥")
  let batch_params = [
    ["Charlie", "charlie@example.com"],
    ["David", "david@example.com"],
    ["Eve", "eve@example.com"]
  ]
  let batch_results = jdbc_template.batch_update("INSERT INTO users (name, email) VALUES (?, ?)", batch_params)
  println("   âœ“ æ‰¹é‡æ’å…¥å®Œæˆï¼Œæ’å…¥ \{batch_results.length()} æ¡è®°å½•")
  println("")
  
  // 6. åˆ é™¤æ“ä½œ
  println("6ï¸âƒ£  åˆ é™¤æ“ä½œ")
  let deleted_rows = jdbc_template.update("DELETE FROM users WHERE id = ?", ["row_1"])
  println("   âœ“ åˆ é™¤æˆåŠŸï¼Œå½±å“è¡Œæ•°: \{deleted_rows}")
  println("")
  
  // ========== ç¬¬å››éƒ¨åˆ†ï¼šåˆ›å»ºäº‹åŠ¡ç®¡ç†å™¨ ==========
  println("ğŸ“ ç¬¬å››æ­¥ï¼šåˆ›å»ºäº‹åŠ¡ç®¡ç†å™¨")
  println("â”€".repeat(60))
  let transaction_manager = @Transaction.TransactionManager::new()
  println("âœ“ äº‹åŠ¡ç®¡ç†å™¨åˆ›å»ºæˆåŠŸ")
  println("")
  
  // ========== ç¬¬äº”éƒ¨åˆ†ï¼šåˆ›å»º AOP é›†æˆå™¨ ==========
  println("ğŸ“ ç¬¬äº”æ­¥ï¼šåˆ›å»º AOP é›†æˆå™¨ï¼ˆç”¨äºå£°æ˜å¼äº‹åŠ¡ï¼‰")
  println("â”€".repeat(60))
  let aop = @AopIntegration.AopIntegration::new()
  println("âœ“ AOP é›†æˆå™¨åˆ›å»ºæˆåŠŸ")
  println("")
  
  // ========== ç¬¬å…­éƒ¨åˆ†ï¼šæ³¨å†Œ Bean ==========
  println("ğŸ“ ç¬¬å…­æ­¥ï¼šæ³¨å†Œ Bean")
  println("â”€".repeat(60))
  ctx.register_bean("userService", "com.example.UserService", 10, true)
  println("âœ“ æ³¨å†Œäº† userService Bean")
  println("")
  
  // ========== ç¬¬ä¸ƒéƒ¨åˆ†ï¼šé…ç½®å£°æ˜å¼äº‹åŠ¡ ==========
  println("ğŸ“ ç¬¬ä¸ƒæ­¥ï¼šé…ç½®å£°æ˜å¼äº‹åŠ¡ï¼ˆ@Transactionalï¼‰")
  println("â”€".repeat(60))
  
  // åˆ›å»ºäº‹åŠ¡å®šä¹‰ï¼ˆä½¿ç”¨é»˜è®¤é…ç½®ï¼‰
  let transaction_def = @Transaction.TransactionDefinition::default()
  
  // ä¸º userService çš„ saveUser å’Œ deleteUser æ–¹æ³•æ³¨å†Œäº‹åŠ¡åˆ‡é¢
  let transactional_methods = ["saveUser", "deleteUser"]
  @TransactionAspect.register_transaction_aspect(
    aop,
    transaction_manager,
    "userService",
    transactional_methods,
    transaction_def
  )
  println("")
  
  // ========== ç¬¬å…«éƒ¨åˆ†ï¼šåˆ›å»º Bean å¹¶æµ‹è¯•äº‹åŠ¡ ==========
  println("ğŸ“ ç¬¬å…«æ­¥ï¼šåˆ›å»º Bean å¹¶æµ‹è¯•äº‹åŠ¡")
  println("â”€".repeat(60))
  
  // æ³¨å†Œ Bean åˆ›å»ºå‡½æ•°
  ctx.register_bean_creator("userService", fn(_ctx) { "instance_userService_001" })
  
  // åˆ›å»º Bean
  ctx.create_all_beans_enhanced()
  println("")
  
  // ========== æ€»ç»“ ==========
  println("=".repeat(60))
  println("ğŸ“Š æ€»ç»“")
  println("=".repeat(60))
  println("âœ… å·²å®Œæˆçš„åŠŸèƒ½ï¼š")
  println("  1. âœ“ MemoryDatabase - å†…å­˜æ•°æ®åº“ï¼ˆçœŸå®æ‰§è¡Œ SQLï¼ï¼‰")
  println("  2. âœ“ JdbcTemplate - JDBC æ¨¡æ¿ç±»ï¼ˆexecuteã€queryã€updateã€batch_updateï¼‰")
  println("  3. âœ“ DataSource - æ•°æ®æºæ¥å£å’Œå®ç°")
  println("  4. âœ“ RowMapper - è¡Œæ˜ å°„å™¨")
  println("  5. âœ“ TransactionManager - äº‹åŠ¡ç®¡ç†å™¨ï¼ˆå¼€å§‹ã€æäº¤ã€å›æ»šï¼‰")
  println("  6. âœ“ TransactionDefinition - äº‹åŠ¡å®šä¹‰ï¼ˆéš”ç¦»çº§åˆ«ã€ä¼ æ’­è¡Œä¸ºï¼‰")
  println("  7. âœ“ å£°æ˜å¼äº‹åŠ¡ - é€šè¿‡ AOP å®ç° @Transactional")
  println("")
  println("ğŸ‰ å†…å­˜æ•°æ®åº“åŠŸèƒ½æ¼”ç¤ºå®Œæˆï¼SQL çœŸçš„å¯ä»¥æ‰§è¡Œäº†ï¼")
}
