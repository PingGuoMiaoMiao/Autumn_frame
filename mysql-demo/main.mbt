/// MySQL æ•°æ®åº“è¿æ¥æ¼”ç¤º
/// 
/// æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ FFI è¿æ¥çœŸå®çš„ MySQL æ•°æ®åº“
/// 
/// æ³¨æ„ï¼š
/// - ä»…åœ¨ native åç«¯å¯ç”¨ï¼ˆC åç«¯ï¼‰
/// - éœ€è¦ç³»ç»Ÿå®‰è£… MySQL C å®¢æˆ·ç«¯åº“ï¼ˆ-lmysqlclientï¼‰
/// - éœ€è¦ç¼–è¯‘æ—¶æŒ‡å®š --target native

fn main {
  println("=".repeat(60))
  println("ğŸŒŸ Autumn Frame - MySQL æ•°æ®åº“è¿æ¥æ¼”ç¤º")
  println("=".repeat(60))
  println("")
  
  println("ğŸ“ æ³¨æ„ï¼šMySQL FFI åŠŸèƒ½ä»…åœ¨ native åç«¯å¯ç”¨")
  println("   ä½¿ç”¨å‘½ä»¤ï¼šmoon build --target native")
  println("   æˆ–ï¼šmoon run --target native mysql-demo")
  println("")
  
  // ========== ç¬¬ä¸€éƒ¨åˆ†ï¼šåˆ›å»º MySQL æ•°æ®æº ==========
  println("ğŸ“¦ ç¬¬ä¸€æ­¥ï¼šåˆ›å»º MySQL æ•°æ®æº")
  println("â”€".repeat(60))
  
  // åˆ›å»º MySQL æ•°æ®æºé…ç½®
  // è¿æ¥ information_schema æ•°æ®åº“
  let config = @JdbcTemplate.MySQLDataSourceConfig::new(
    "localhost",      // host
    3306,            // port
    "root",          // user
    "123456",        // password
    "information_schema" // database
  )
  let data_source = @JdbcTemplate.MySQLDataSource::new(config)
  println("âœ“ MySQL æ•°æ®æºåˆ›å»ºæˆåŠŸ")
  println("")
  
  // ========== ç¬¬äºŒéƒ¨åˆ†ï¼šè¿æ¥åˆ°æ•°æ®åº“ ==========
  println("ğŸ“ ç¬¬äºŒæ­¥ï¼šè¿æ¥åˆ°æ•°æ®åº“")
  println("â”€".repeat(60))
  let connected_source = data_source.connect()
  println("")
  
  // ========== ç¬¬ä¸‰éƒ¨åˆ†ï¼šæŸ¥è¯¢ TABLES è¡¨ä¿¡æ¯ ==========
  println("ğŸ“ ç¬¬ä¸‰æ­¥ï¼šæŸ¥è¯¢ information_schema.TABLES")
  println("â”€".repeat(60))
  
  // æŸ¥è¯¢ TABLES è¡¨çš„å‰10æ¡è®°å½•
  let row_mapper : @JdbcTemplate.RowMapper = fn(row : @JdbcTemplate.Row) {
    let mut result = ""
    let mut first = true
    row.iter().each(fn(entry : (String, String)) {
      let (key, value) = entry
      if first {
        result = result + key + "=" + value
        first = false
      } else {
        result = result + ", " + key + "=" + value
      }
    })
    result
  }
  
  // æŸ¥è¯¢ TABLES è¡¨çš„å‰10æ¡è®°å½•
  match connected_source.query("SELECT TABLE_SCHEMA, TABLE_NAME, TABLE_TYPE, ENGINE FROM TABLES LIMIT 10", row_mapper) {
    Some(results) => {
      println("âœ“ æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° \{results.length()} æ¡è®°å½•ï¼š")
      let mut i = 0
      while i < results.length() {
        println("  - \{results[i]}")
        i = i + 1
      }
    }
    None => println("â„¹ï¸  æœªæ‰¾åˆ°è®°å½•æˆ–æŸ¥è¯¢å¤±è´¥")
  }
  println("")
  
  // ========== ç¬¬å››éƒ¨åˆ†ï¼šæŸ¥è¯¢ USERS è¡¨ä¿¡æ¯ ==========
  println("ğŸ“ ç¬¬å››æ­¥ï¼šæŸ¥è¯¢ information_schema.USERS")
  println("â”€".repeat(60))
  
  // æŸ¥è¯¢ users è¡¨çš„æ‰€æœ‰è®°å½•ï¼ˆæ ¹æ® MariaDB è¾“å‡ºï¼Œè¡¨åæ˜¯ usersï¼Œå°å†™ï¼‰
  match connected_source.query("SELECT * FROM users", row_mapper) {
    Some(results) => {
      println("âœ“ æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° \{results.length()} æ¡è®°å½•ï¼š")
      let mut i = 0
      while i < results.length() {
        println("  - \{results[i]}")
        i = i + 1
      }
    }
    None => println("â„¹ï¸  æœªæ‰¾åˆ°è®°å½•æˆ–æŸ¥è¯¢å¤±è´¥ï¼ˆå¯èƒ½ USERS è¡¨ä¸å­˜åœ¨ï¼‰")
  }
  println("")
  
  // ========== ç¬¬äº”éƒ¨åˆ†ï¼šæŸ¥è¯¢ SCHEMATA è¡¨ï¼ˆæ‰€æœ‰æ•°æ®åº“ï¼‰ ==========
  println("ğŸ“ ç¬¬äº”æ­¥ï¼šæŸ¥è¯¢ information_schema.SCHEMATAï¼ˆæ‰€æœ‰æ•°æ®åº“ï¼‰")
  println("â”€".repeat(60))
  
  match connected_source.query("SELECT SCHEMA_NAME, DEFAULT_CHARACTER_SET_NAME, DEFAULT_COLLATION_NAME FROM SCHEMATA LIMIT 10", row_mapper) {
    Some(results) => {
      println("âœ“ æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° \{results.length()} ä¸ªæ•°æ®åº“ï¼š")
      let mut i = 0
      while i < results.length() {
        println("  - \{results[i]}")
        i = i + 1
      }
    }
    None => println("â„¹ï¸  æœªæ‰¾åˆ°è®°å½•æˆ–æŸ¥è¯¢å¤±è´¥")
  }
  println("")
  
  // ========== ç¬¬å…­éƒ¨åˆ†ï¼šæŸ¥è¯¢ ENGINES è¡¨ï¼ˆå­˜å‚¨å¼•æ“ï¼‰ ==========
  println("ğŸ“ ç¬¬å…­æ­¥ï¼šæŸ¥è¯¢ information_schema.ENGINESï¼ˆæ”¯æŒçš„å­˜å‚¨å¼•æ“ï¼‰")
  println("â”€".repeat(60))
  
  match connected_source.query("SELECT ENGINE, SUPPORT, COMMENT FROM ENGINES LIMIT 10", row_mapper) {
    Some(results) => {
      println("âœ“ æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° \{results.length()} ä¸ªå­˜å‚¨å¼•æ“ï¼š")
      let mut i = 0
      while i < results.length() {
        println("  - \{results[i]}")
        i = i + 1
      }
    }
    None => println("â„¹ï¸  æœªæ‰¾åˆ°è®°å½•æˆ–æŸ¥è¯¢å¤±è´¥")
  }
  println("")
  
  // ========== ç¬¬ä¸ƒéƒ¨åˆ†ï¼šæŸ¥è¯¢ COLUMNS è¡¨ï¼ˆåˆ—ä¿¡æ¯ï¼‰ ==========
  println("ğŸ“ ç¬¬ä¸ƒæ­¥ï¼šæŸ¥è¯¢ information_schema.COLUMNSï¼ˆè¡¨åˆ—ä¿¡æ¯ï¼‰")
  println("â”€".repeat(60))
  
  match connected_source.query("SELECT TABLE_SCHEMA, TABLE_NAME, COLUMN_NAME, DATA_TYPE, IS_NULLABLE FROM COLUMNS WHERE TABLE_SCHEMA = 'information_schema' AND TABLE_NAME = 'TABLES' LIMIT 10", row_mapper) {
    Some(results) => {
      println("âœ“ æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° \{results.length()} ä¸ªåˆ—ï¼š")
      let mut i = 0
      while i < results.length() {
        println("  - \{results[i]}")
        i = i + 1
      }
    }
    None => println("â„¹ï¸  æœªæ‰¾åˆ°è®°å½•æˆ–æŸ¥è¯¢å¤±è´¥")
  }
  println("")
  
  // ========== ç¬¬å…«éƒ¨åˆ†ï¼šæŸ¥è¯¢ PLUGINS è¡¨ï¼ˆæ’ä»¶ä¿¡æ¯ï¼‰ ==========
  println("ğŸ“ ç¬¬å…«æ­¥ï¼šæŸ¥è¯¢ information_schema.PLUGINSï¼ˆæ’ä»¶ä¿¡æ¯ï¼‰")
  println("â”€".repeat(60))
  
  match connected_source.query("SELECT PLUGIN_NAME, PLUGIN_STATUS, PLUGIN_TYPE FROM PLUGINS LIMIT 10", row_mapper) {
    Some(results) => {
      println("âœ“ æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° \{results.length()} ä¸ªæ’ä»¶ï¼š")
      let mut i = 0
      while i < results.length() {
        println("  - \{results[i]}")
        i = i + 1
      }
    }
    None => println("â„¹ï¸  æœªæ‰¾åˆ°è®°å½•æˆ–æŸ¥è¯¢å¤±è´¥")
  }
  println("")
  
  // ========== ç¬¬ä¹éƒ¨åˆ†ï¼šåˆ›å»ºæµ‹è¯•æ•°æ®åº“å’Œè¡¨ ==========
  println("ğŸ“ ç¬¬ä¹æ­¥ï¼šåˆ›å»ºæµ‹è¯•æ•°æ®åº“å’Œè¡¨")
  println("â”€".repeat(60))
  
  // åˆ›å»ºæµ‹è¯•æ•°æ®åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  match connected_source.execute("CREATE DATABASE IF NOT EXISTS test_db") {
    Some(_) => println("âœ“ æ•°æ®åº“åˆ›å»ºæˆåŠŸï¼ˆæˆ–å·²å­˜åœ¨ï¼‰")
    None => println("â„¹ï¸  æ•°æ®åº“åˆ›å»ºå¤±è´¥æˆ–å·²å­˜åœ¨")
  }
  println("")
  
  // åˆ‡æ¢åˆ°æµ‹è¯•æ•°æ®åº“ï¼ˆéœ€è¦é‡æ–°è¿æ¥ï¼‰
  let test_config = @JdbcTemplate.MySQLDataSourceConfig::new(
    "localhost",
    3306,
    "root",
    "123456",
    "test_db"
  )
  let test_data_source = @JdbcTemplate.MySQLDataSource::new(test_config)
  let test_connected = test_data_source.connect()
  println("âœ“ å·²åˆ‡æ¢åˆ° test_db æ•°æ®åº“")
  println("")
  
  // åˆ›å»ºæµ‹è¯•è¡¨
  match test_connected.execute("CREATE TABLE IF NOT EXISTS users (id INT AUTO_INCREMENT PRIMARY KEY, name VARCHAR(100), email VARCHAR(100), age INT)") {
    Some(_) => println("âœ“ è¡¨åˆ›å»ºæˆåŠŸï¼ˆæˆ–å·²å­˜åœ¨ï¼‰")
    None => println("âŒ è¡¨åˆ›å»ºå¤±è´¥")
  }
  println("")
  
  // ========== ç¬¬åéƒ¨åˆ†ï¼šå¢åˆ æ”¹æŸ¥æ“ä½œ ==========
  println("ğŸ“ ç¬¬åæ­¥ï¼šå¢åˆ æ”¹æŸ¥æ“ä½œ")
  println("â”€".repeat(60))
  
  // æ’å…¥æ•°æ®
  println("ğŸ”¹ æ’å…¥æ•°æ®ï¼š")
  match test_connected.execute("INSERT INTO users (name, email, age) VALUES ('å¼ ä¸‰', 'zhangsan@example.com', 25)") {
    Some(_) => println("  âœ“ æ’å…¥æˆåŠŸ")
    None => println("  âŒ æ’å…¥å¤±è´¥")
  }
  
  match test_connected.execute("INSERT INTO users (name, email, age) VALUES ('æå››', 'lisi@example.com', 30)") {
    Some(_) => println("  âœ“ æ’å…¥æˆåŠŸ")
    None => println("  âŒ æ’å…¥å¤±è´¥")
  }
  
  match test_connected.execute("INSERT INTO users (name, email, age) VALUES ('ç‹äº”', 'wangwu@example.com', 28)") {
    Some(_) => println("  âœ“ æ’å…¥æˆåŠŸ")
    None => println("  âŒ æ’å…¥å¤±è´¥")
  }
  println("")
  
  // æŸ¥è¯¢æ•°æ®
  println("ğŸ”¹ æŸ¥è¯¢æ‰€æœ‰æ•°æ®ï¼š")
  match test_connected.query("SELECT id, name, email, age FROM users", row_mapper) {
    Some(results) => {
      println("  âœ“ æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° \{results.length()} æ¡è®°å½•ï¼š")
      let mut i = 0
      while i < results.length() {
        println("    - \{results[i]}")
        i = i + 1
      }
    }
    None => println("  â„¹ï¸  æœªæ‰¾åˆ°è®°å½•")
  }
  println("")
  
  // æ›´æ–°æ•°æ®
  println("ğŸ”¹ æ›´æ–°æ•°æ®ï¼ˆå°†å¼ ä¸‰çš„å¹´é¾„æ”¹ä¸º 26ï¼‰ï¼š")
  match test_connected.execute("UPDATE users SET age = 26 WHERE name = 'å¼ ä¸‰'") {
    Some(_) => println("  âœ“ æ›´æ–°æˆåŠŸ")
    None => println("  âŒ æ›´æ–°å¤±è´¥")
  }
  
  // æŸ¥è¯¢æ›´æ–°åçš„æ•°æ®
  match test_connected.query("SELECT id, name, email, age FROM users WHERE name = 'å¼ ä¸‰'", row_mapper) {
    Some(results) => {
      println("  âœ“ æŸ¥è¯¢æ›´æ–°åçš„æ•°æ®ï¼š")
      let mut i = 0
      while i < results.length() {
        println("    - \{results[i]}")
        i = i + 1
      }
    }
    None => println("  â„¹ï¸  æœªæ‰¾åˆ°è®°å½•")
  }
  println("")
  
  // åˆ é™¤æ•°æ®
  println("ğŸ”¹ åˆ é™¤æ•°æ®ï¼ˆåˆ é™¤ç‹äº”çš„è®°å½•ï¼‰ï¼š")
  match test_connected.execute("DELETE FROM users WHERE name = 'ç‹äº”'") {
    Some(_) => println("  âœ“ åˆ é™¤æˆåŠŸ")
    None => println("  âŒ åˆ é™¤å¤±è´¥")
  }
  
  // æŸ¥è¯¢åˆ é™¤åçš„æ•°æ®
  match test_connected.query("SELECT id, name, email, age FROM users", row_mapper) {
    Some(results) => {
      println("  âœ“ æŸ¥è¯¢åˆ é™¤åçš„æ•°æ®ï¼Œå‰©ä½™ \{results.length()} æ¡è®°å½•ï¼š")
      let mut i = 0
      while i < results.length() {
        println("    - \{results[i]}")
        i = i + 1
      }
    }
    None => println("  â„¹ï¸  æœªæ‰¾åˆ°è®°å½•")
  }
  println("")
  
  // æ–­å¼€æµ‹è¯•æ•°æ®åº“è¿æ¥
  let _ = test_connected.disconnect()
  
  // ========== ç¬¬åä¸€éƒ¨åˆ†ï¼šæ–­å¼€è¿æ¥ ==========
  println("ğŸ“ ç¬¬åä¸€æ­¥ï¼šæ–­å¼€è¿æ¥")
  println("â”€".repeat(60))
  let _ = connected_source.disconnect()
  println("âœ“ æ–­å¼€è¿æ¥æˆåŠŸ")
  println("")
  
  // ========== æ€»ç»“ ==========
  println("=".repeat(60))
  println("ğŸ“Š æ€»ç»“")
  println("=".repeat(60))
  println("âœ… å·²å®Œæˆçš„åŠŸèƒ½ï¼š")
  println("  1. âœ“ DatabaseFFI - MySQL FFI å¤–éƒ¨å‡½æ•°å£°æ˜")
  println("  2. âœ“ MySQLDataSource - MySQL æ•°æ®æºå®ç°")
  println("  3. âœ“ C èƒ¶æ°´å‡½æ•° - mysql_wrapper.c")
  println("  4. âœ“ æ•°æ®åº“è¿æ¥ - connect/disconnect")
  println("  5. âœ“ SQL æ‰§è¡Œ - execute/query")
  println("")
  println("ğŸ‰ MySQL æ•°æ®åº“è¿æ¥åŠŸèƒ½æ¼”ç¤ºå®Œæˆï¼")
  println("")
  println("âš ï¸  æ³¨æ„ï¼š")
  println("  - æ­¤åŠŸèƒ½ä»…åœ¨ native åç«¯å¯ç”¨")
  println("  - wasm-gc åç«¯ä¸æ”¯æŒ extern \"C\" fn")
  println("  - éœ€è¦ç³»ç»Ÿå®‰è£… MySQL C å®¢æˆ·ç«¯åº“ï¼ˆ-lmysqlclientï¼‰")
  println("  - è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹è¿æ¥å‚æ•°ï¼ˆhost, port, user, password, databaseï¼‰")
}

